<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Manager - Gestion Complète</title>
    <style>
        /* Variables CSS pour une cohérence globale */
        :root {
            --primary-color: #5667E8;
            --primary-dark: #4054D4;
            --primary-light: #E8EAFD;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --info-color: #3B82F6;
            --dark-color: #1F2937;
            --gray-color: #6B7280;
            --light-gray: #F3F4F6;
            --border-color: #E5E7EB;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #F9FAFB;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        /* Toolbar */
        .toolbar {
            background: var(--light-gray);
            padding: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #D97706;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #DC2626;
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background: #2563EB;
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Year Selector */
        .year-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }

        .year-selector span {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-color);
            min-width: 4rem;
            text-align: center;
        }

        .year-selector button {
            width: 2rem;
            height: 2rem;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .year-selector button:hover {
            background: var(--primary-dark);
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }

        .nav-tab:hover {
            background: var(--light-gray);
            color: var(--dark-color);
        }

        .nav-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: var(--primary-light);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            gap: 0.5rem;
            margin: 1.5rem 0;
        }

        .view-tab {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: white;
            color: var(--gray-color);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            font-weight: 500;
            font-size: 0.875rem;
        }

        .view-tab:hover {
            background: var(--light-gray);
        }

        .view-tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-box {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-md);
            text-align: center;
            border: 2px solid var(--border-color);
            transition: var(--transition);
        }

        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-box.good {
            border-color: var(--success-color);
            background: #F0FDF4;
        }

        .stat-box.warning {
            border-color: var(--warning-color);
            background: #FFFBEB;
        }

        .stat-box.danger {
            border-color: var(--danger-color);
            background: #FEF2F2;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
            line-height: 1;
        }

        .stat-label {
            color: var(--gray-color);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            font-weight: 500;
        }

        /* Calendar Year View */
        .calendar-year {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .month-block {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
            background: white;
            transition: var(--transition);
        }

        .month-block:hover {
            box-shadow: var(--shadow-md);
        }

        .month-header {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .month-header:hover {
            background: var(--primary-dark);
        }

        .weeks-container {
            padding: 1rem;
        }

        .week-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.875rem;
            border: 1px solid transparent;
        }

        .week-row:hover {
            background: var(--light-gray);
            transform: translateX(4px);
        }

        .week-row.assigned {
            background: #F0FDF4;
            border-color: var(--success-color);
            color: #065F46;
        }

        .week-row.conflict {
            background: #FEF2F2;
            border-color: var(--danger-color);
            color: #7F1D1D;
            font-weight: 600;
        }

        .week-row.vacation {
            background: #FFFBEB;
            border-color: var(--warning-color);
            color: #78350F;
        }

        .week-number {
            font-weight: 700;
            color: var(--gray-color);
            min-width: 3rem;
        }

        .week-team {
            flex: 1;
            text-align: center;
            font-weight: 500;
        }

        .week-status {
            color: var(--danger-color);
            font-weight: 700;
            font-size: 1.2rem;
        }

        /* Month View */
        .calendar-month {
            display: none;
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .month-nav h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .day-header {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            border-radius: var(--radius-sm);
        }

        .day-cell {
            min-height: 100px;
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            background: white;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            border-radius: var(--radius-sm);
        }

        .day-cell:hover {
            background: var(--light-gray);
            box-shadow: var(--shadow-sm);
        }

        .day-cell.other-month {
            background: #FAFAFA;
            color: var(--gray-color);
        }

        .day-cell.has-assignment {
            background: #F0FDF4;
            border-color: var(--success-color);
        }

        .day-cell.has-conflict {
            background: #FEF2F2;
            border-color: var(--danger-color);
        }

        .day-number {
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--dark-color);
        }

        .day-info {
            font-size: 0.75rem;
            color: var(--gray-color);
        }

        .conflict-indicator {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            color: var(--danger-color);
            font-weight: 700;
        }

        /* Conflict Details */
        .conflict-details {
            background: white;
            border: 2px solid var(--danger-color);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .conflict-details h3 {
            color: var(--danger-color);
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Tables */
        .conflict-table,
        .dashboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.875rem;
        }

        .conflict-table th,
        .conflict-table td,
        .dashboard-table th,
        .dashboard-table td {
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            text-align: left;
        }

        .conflict-table th,
        .dashboard-table th {
            background: var(--light-gray);
            font-weight: 600;
            color: var(--dark-color);
        }

        .conflict-table tr:hover,
        .dashboard-table tr:hover {
            background: var(--light-gray);
        }

        .dashboard-table td {
            text-align: center;
        }

        /* Absences */
        .absences-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .member-card {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            background: white;
            transition: var(--transition);
        }

        .member-card:hover {
            box-shadow: var(--shadow-md);
        }

        .member-card h4 {
            color: var(--dark-color);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-color);
            font-size: 1.125rem;
            font-weight: 600;
        }

        .absence-item {
            background: var(--light-gray);
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .absence-item:hover {
            background: #E5E7EB;
        }

        .absence-dates {
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.875rem;
        }

        .absence-duration {
            background: var(--warning-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            margin: 3rem auto;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            border-radius: var(--radius-lg);
            position: relative;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-color);
            transition: var(--transition);
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
        }

        .close:hover {
            background: var(--light-gray);
            color: var(--dark-color);
        }

        .modal-content h2 {
            margin-bottom: 1.5rem;
            color: var(--dark-color);
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark-color);
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            transition: var(--transition);
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(86, 103, 232, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 2000;
            box-shadow: var(--shadow-lg);
            font-size: 0.875rem;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        /* Resolved Solutions */
        #resolvedSolutionsContainer {
            margin-top: 2rem;
        }

        #resolvedSolutionsContainer h3 {
            margin-bottom: 1rem;
            color: var(--dark-color);
            font-size: 1.25rem;
            font-weight: 600;
        }

        #resolvedSolutionsContainer > div {
            background: #F0F9FF;
            border: 1px solid #BFDBFE;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .nav-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .stats-bar {
                grid-template-columns: 1fr 1fr;
            }

            .calendar-year {
                grid-template-columns: 1fr;
            }

            .month-grid {
                gap: 0.25rem;
            }

            .day-cell {
                min-height: 80px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📅 PLANNING MANAGER</h1>
            <p style="font-size: 0.875rem; opacity: 0.8; margin-top: 0.5rem;">by Vadhor</p>
            <!-- Contenu onglet Paramètres -->
            <div id="settingsTab" class="tab-content">
                <h2 style="margin-bottom: 1.5rem; color: var(--dark-color);">Paramètres de l'équipe</h2>
                <div style="background: white; border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 2rem; max-width: 800px;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-color);">Personnaliser les noms des référents</h3>
                    <p style="color: var(--gray-color); margin-bottom: 2rem;">
                        Modifiez les noms des référents pour utiliser les vrais prénoms de votre équipe.
                    </p>
                    <div id="teamNamesContainer" style="display: grid; gap: 1rem;">
                        <!-- Généré dynamiquement -->
                    </div>
                    <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                        <button class="btn btn-success" onclick="saveTeamNames()">
                            💾 Enregistrer les modifications
                        </button>
                        <button class="btn btn-warning" onclick="resetTeamNames()">
                            🔄 Réinitialiser
                        </button>
                    </div>
                </div>
                
                <!-- Section Gestion des jours de congés -->
                <div style="background: white; border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 2rem; max-width: 800px; margin-top: 2rem;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-color);">Gestion des congés annuels</h3>
                    <p style="color: var(--gray-color); margin-bottom: 2rem;">
                        Définissez le nombre de jours de congés autorisés par référent pour l'année.
                    </p>
                    <div id="vacationLimitsContainer" style="display: grid; gap: 1rem;">
                        <!-- Généré dynamiquement -->
                    </div>
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-success" onclick="saveVacationLimits()">
                            💾 Enregistrer les limites
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <div class="toolbar">
            <div class="year-selector">
                <button onclick="changeYear(-1)">◀</button>
                <span id="currentYear">2025</span>
                <button onclick="changeYear(1)">▶</button>
            </div>
            
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="showAssignModal()">
                    ➕ Assigner Semaine
                </button>
                <button class="btn btn-warning" onclick="showVacationModal()">
                    🏖️ Ajouter Vacances
                </button>
                <button class="btn btn-success" onclick="autoFillYear()">
                    ⚡ Remplir l'Année
                </button>
                <button class="btn btn-danger" onclick="resolveAllConflicts()">
                    🔧 Résoudre Conflits
                </button>
                <button class="btn btn-info" onclick="exportPlanning()">
                    💾 Exporter JSON
                </button>
                <button class="btn btn-info" onclick="exportExcel()">
                    📊 Excel
                </button>
                <button class="btn btn-info" onclick="exportAgenda()">
                    📅 Agenda
                </button>
                <button class="btn btn-warning" onclick="generateTestConflicts()">
                    ⚠️ Test
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- Navigation par onglets -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab(event, 'planning')">📅 Planning</button>
                <button class="nav-tab" onclick="switchTab(event, 'absences')">🏖️ Absences</button>
                <button class="nav-tab" onclick="switchTab(event, 'conflicts')">⚠️ Conflits</button>
                <button class="nav-tab" onclick="switchTab(event, 'dashboard')">📊 Tableau de bord</button>
            </div>

            <!-- Contenu onglet Planning -->
            <div id="planningTab" class="tab-content active">
                <!-- Stats -->
                <div class="stats-bar">
                    <div class="stat-box good">
                        <div class="stat-number" id="weeksAssigned">0</div>
                        <div class="stat-label">Semaines Assignées</div>
                    </div>
                    <div class="stat-box warning">
                        <div class="stat-number" id="totalAbsences">0</div>
                        <div class="stat-label">Périodes d'Absence</div>
                    </div>
                    <div class="stat-box danger">
                        <div class="stat-number" id="conflictsCount">0</div>
                        <div class="stat-label">Conflits Actifs</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="progressPercent">0%</div>
                        <div class="stat-label">Progression</div>
                    </div>
                </div>

                <!-- Sélecteur de vue -->
                <div class="view-tabs">
                    <button class="view-tab active" onclick="switchView(event, 'year')">Vue Année</button>
                    <button class="view-tab" onclick="switchView(event, 'month')">Vue Mois</button>
                </div>

                <!-- Vue Année -->
                <div class="calendar-year" id="yearView">
                    <!-- Généré par JavaScript -->
                </div>

                <!-- Vue Mois -->
                <div class="calendar-month" id="monthView">
                    <div class="month-nav">
                        <button class="btn btn-primary" onclick="changeMonth(-1)">◀ Précédent</button>
                        <h2 id="currentMonthTitle">Janvier 2025</h2>
                        <button class="btn btn-primary" onclick="changeMonth(1)">Suivant ▶</button>
                    </div>
                    <div class="month-grid" id="monthGrid">
                        <!-- Généré par JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Contenu onglet Absences -->
            <div id="absencesTab" class="tab-content">
                <h2 style="margin-bottom: 1.5rem; color: var(--dark-color);">Gestion des Absences par Référent</h2>
                <div class="absences-container" id="absencesContainer">
                    <!-- Généré par JavaScript -->
                </div>
            </div>

            <!-- Contenu onglet Conflits -->
            <div id="conflictsTab" class="tab-content">
                <h2 style="margin-bottom: 1.5rem; color: var(--dark-color);">Détail des Conflits</h2>
                <div id="conflictsDetails">
                    <!-- Généré par JavaScript -->
                </div>
                <!-- Conteneur des solutions résolues -->
                <div id="resolvedSolutionsContainer">
                    <!-- Rempli dynamiquement pour afficher les solutions des conflits résolus -->
                </div>
            </div>

            <!-- Contenu onglet Tableau de bord -->
            <div id="dashboardTab" class="tab-content">
                <h2 style="margin-bottom: 1.5rem; color: var(--dark-color);">Tableau de bord des Référents</h2>
                <div id="dashboardContainer">
                    <!-- Généré par JavaScript -->
                </div>
            </div>

        </div>
    </div>

    <!-- Modal Assignation -->
    <div class="modal" id="assignModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assignModal')">&times;</span>
            <h2>Assigner une Semaine</h2>
            <form id="assignForm" onsubmit="saveAssignment(event)">
                <div class="form-group">
                    <label>Semaine</label>
                    <input type="week" id="weekInput" required>
                </div>
                <div class="form-group">
                    <label>Binôme</label>
                    <div class="form-row">
                        <select id="member1" required>
                            <option value="">Membre 1</option>
                        </select>
                        <select id="member2" required>
                            <option value="">Membre 2</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Remplaçant</label>
                    <select id="backup" required>
                        <option value="">Sélectionner</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 1rem;">
                    Enregistrer
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Vacances -->
    <div class="modal" id="vacationModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('vacationModal')">&times;</span>
            <h2>Ajouter des Vacances</h2>
            <form id="vacationForm" onsubmit="saveVacation(event)">
                <div class="form-group">
                    <label>Référent</label>
                    <select id="vacationMember" required>
                        <option value="">Sélectionner</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Du</label>
                    <input type="date" id="vacationStart" required>
                </div>
                <div class="form-group">
                    <label>Au</label>
                    <input type="date" id="vacationEnd" required>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 1rem;">
                    Enregistrer
                </button>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Configuration
        let TEAM = [
            'Référent 1', 'Référent 2', 'Référent 3', 'Référent 4', 'Référent 5',
            'Référent 6', 'Référent 7', 'Référent 8', 'Référent 9', 'Référent 10'
        ];
        
        // Noms personnalisés des référents
        let customTeamNames = {};
        
        // Limites de vacances par référent
        let vacationLimits = {};

        const BINOMES = [
            ['Référent 1', 'Référent 2', 'Référent 3'],
            ['Référent 4', 'Référent 5', 'Référent 6'],
            ['Référent 7', 'Référent 8', 'Référent 9'],
            ['Référent 2', 'Référent 10', 'Référent 1'],
            ['Référent 3', 'Référent 6', 'Référent 4']
        ];

        // État global
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let currentView = 'year';
        let currentTab = 'planning';
        let assignments = {};
        let vacations = {};
        let conflicts = [];
        // Tableau des solutions de conflits résolus (historique)
        let resolvedSolutions = [];

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadData();
            populateSelects();
            updateDisplay();
            detectConflicts();
        }

        function loadData() {
            const saved = localStorage.getItem('planningData');
            if (saved) {
                const data = JSON.parse(saved);
                assignments = data.assignments || {};
                vacations = data.vacations || {};
                currentYear = data.year || currentYear;
                customTeamNames = data.customTeamNames || {};
                vacationLimits = data.vacationLimits || {};
                
                // Appliquer les noms personnalisés
                applyCustomNames();
            }
        }

        function saveData() {
            const data = {
                year: currentYear,
                assignments: assignments,
                vacations: vacations,
                customTeamNames: customTeamNames,
                vacationLimits: vacationLimits
            };
            localStorage.setItem('planningData', JSON.stringify(data));
        }
        
        // Fonction pour obtenir le nom affiché d'un référent
        function getDisplayName(referentKey) {
            return customTeamNames[referentKey] || referentKey;
        }
        
        // Fonction pour appliquer les noms personnalisés
        function applyCustomNames() {
            const defaultTeam = [
                'Référent 1', 'Référent 2', 'Référent 3', 'Référent 4', 'Référent 5',
                'Référent 6', 'Référent 7', 'Référent 8', 'Référent 9', 'Référent 10'
            ];
            
            TEAM = defaultTeam.map(ref => customTeamNames[ref] || ref);
        }

        function populateSelects() {
            const selects = ['member1', 'member2', 'backup', 'vacationMember'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Sélectionner</option>';
                    TEAM.forEach(member => {
                        select.innerHTML += `<option value="${member}">${member}</option>`;
                    });
                }
            });
        }

        function switchTab(event, tab) {
            currentTab = tab;

            // Mettre à jour les onglets actifs
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Masquer tout contenu
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Afficher le bon contenu
            if (tab === 'planning') {
                document.getElementById('planningTab').classList.add('active');
            } else if (tab === 'absences') {
                document.getElementById('absencesTab').classList.add('active');
                renderAbsencesView();
            } else if (tab === 'conflicts') {
                document.getElementById('conflictsTab').classList.add('active');
                renderConflictsView();
            } else if (tab === 'dashboard') {
                document.getElementById('dashboardTab').classList.add('active');
                renderDashboardView();
            } else if (tab === 'settings') {
                document.getElementById('settingsTab').classList.add('active');
                renderSettingsView();
            }
        }

        function updateDisplay() {
            document.getElementById('currentYear').textContent = currentYear;

            if (currentView === 'year') {
                renderYearView();
            } else {
                renderMonthView();
            }

            updateStats();
        }

        function renderYearView() {
            const container = document.getElementById('yearView');
            container.innerHTML = '';

            const months = [
                'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
            ];

            months.forEach((month, index) => {
                const monthBlock = document.createElement('div');
                monthBlock.className = 'month-block';

                const header = document.createElement('div');
                header.className = 'month-header';
                header.textContent = month;
                header.onclick = () => {
                    currentMonth = index;
                    switchView(null, 'month');
                };
                monthBlock.appendChild(header);

                const weeksContainer = document.createElement('div');
                weeksContainer.className = 'weeks-container';

                const weeks = getWeeksInMonth(currentYear, index);

                weeks.forEach(week => {
                    const weekRow = document.createElement('div');
                    weekRow.className = 'week-row';

                    const weekKey = `${currentYear}-W${week.number}`;
                    const assignment = assignments[weekKey];
                    const weekConflicts = conflicts.filter(c => c.week === week.number);

                    if (weekConflicts.length > 0) {
                        weekRow.classList.add('conflict');
                        weekRow.title = weekConflicts.map(c =>
                            `${c.member}: ${formatDateFR(new Date(c.vacationStart))} au ${formatDateFR(new Date(c.vacationEnd))}`
                        ).join('\n');
                    } else if (assignment) {
                        weekRow.classList.add('assigned');
                    }

                    weekRow.innerHTML = `
                        <span class="week-number">S${week.number}</span>
                        <span class="week-team">
                            ${assignment ? `${assignment.member1} + ${assignment.member2}` : 'Non assignée'}
                        </span>
                        ${weekConflicts.length > 0 ? '<span class="week-status">⚠️</span>' : ''}
                    `;

                    weekRow.onclick = () => editWeek(week.number);

                    weeksContainer.appendChild(weekRow);
                });

                monthBlock.appendChild(weeksContainer);
                container.appendChild(monthBlock);
            });
        }

        function renderMonthView() {
            const monthNames = [
                'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
            ];

            document.getElementById('currentMonthTitle').textContent =
                `${monthNames[currentMonth]} ${currentYear}`;

            const grid = document.getElementById('monthGrid');
            grid.innerHTML = '';

            // En-têtes des jours
            const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            days.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // Calcul des jours
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDay = firstDay.getDay() || 7;

            // Jours vides avant le premier jour du mois
            for (let i = 1; i < startDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Jours du mois
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell';

                const date = new Date(currentYear, currentMonth, day);
                const weekNum = getWeekNumber(date);
                const weekKey = `${currentYear}-W${weekNum}`;
                const assignment = assignments[weekKey];
                const weekConflicts = conflicts.filter(c => c.week === weekNum);

                if (assignment) {
                    cell.classList.add('has-assignment');
                }

                if (weekConflicts.length > 0) {
                    cell.classList.add('has-conflict');
                }

                cell.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-info">S${weekNum}</div>
                    ${weekConflicts.length > 0 ? '<div class="conflict-indicator">⚠️</div>' : ''}
                `;

                cell.onclick = () => editWeek(weekNum);

                grid.appendChild(cell);
            }
        }

        function renderAbsencesView() {
            const container = document.getElementById('absencesContainer');
            container.innerHTML = '';

            TEAM.forEach(member => {
                const card = document.createElement('div');
                card.className = 'member-card';

                const memberVacations = vacations[member] || [];
                const totalDays = memberVacations.reduce((sum, vac) => {
                    const days = Math.ceil((new Date(vac.end) - new Date(vac.start)) / (1000 * 60 * 60 * 24)) + 1;
                    return sum + days;
                }, 0);

                card.innerHTML = `
                    <h4>${member} (${totalDays} jours)</h4>
                    ${
                        memberVacations.length === 0 ?
                        '<p style="color: var(--gray-color); font-style: italic;">Aucune absence enregistrée</p>' :
                        memberVacations.map(vac => {
                            const start = new Date(vac.start);
                            const end = new Date(vac.end);
                            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

                            return `
                                <div class="absence-item">
                                    <span class="absence-dates">
                                        ${formatDateFR(start)} - ${formatDateFR(end)}
                                    </span>
                                    <span class="absence-duration">${days} jours</span>
                                    <button class="btn btn-danger btn-small" style="margin-left:10px;" onclick="deleteVacation('${member}', '${vac.start}', '${vac.end}')">
                                        🗑️
                                    </button>
                                </div>
                            `;
                        }).join('')
                    }
                    <div class="quick-actions">
                        <button class="btn btn-warning btn-small" onclick="addVacationForMember('${member}')">
                            + Ajouter absence
                        </button>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function renderConflictsView() {
            const container = document.getElementById('conflictsDetails');
            container.innerHTML = '';

            if (conflicts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--success-color); background: #F0FDF4; border-radius: var(--radius-md); border: 2px solid var(--success-color);">
                        <h3 style="margin-bottom: 0.5rem;">✅ Aucun conflit détecté !</h3>
                        <p style="color: var(--gray-color);">Tous les membres sont disponibles pour leurs assignations.</p>
                    </div>
                `;
                // Effacer les solutions précédemment affichées
                document.getElementById('resolvedSolutionsContainer').innerHTML = '';
                return;
            }

            // Grouper les conflits par semaine
            const conflictsByWeek = {};
            conflicts.forEach(conflict => {
                if (!conflictsByWeek[conflict.week]) {
                    conflictsByWeek[conflict.week] = [];
                }
                conflictsByWeek[conflict.week].push(conflict);
            });

            Object.entries(conflictsByWeek).forEach(([week, weekConflicts]) => {
                const weekKey = `${currentYear}-W${week}`;
                const assignment = assignments[weekKey];
                const weekDates = getWeekDates(currentYear, parseInt(week));

                const conflictDiv = document.createElement('div');
                conflictDiv.className = 'conflict-details';

                conflictDiv.innerHTML = `
                    <h3>🚨 Semaine ${week} (${formatDateFR(weekDates.start)} au ${formatDateFR(weekDates.end)})</h3>
                    <p><strong>Équipe assignée :</strong> ${assignment.member1} + ${assignment.member2} (Backup: ${assignment.backup})</p>
                    
                    <table class="conflict-table">
                        <thead>
                            <tr>
                                <th>Membre en conflit</th>
                                <th>Rôle</th>
                                <th>Période d'absence</th>
                                <th>Durée</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${
                                weekConflicts.map(conflict => {
                                    const role = conflict.member === assignment.member1 || conflict.member === assignment.member2 ? 'Principal' : 'Backup';
                                    const days = Math.ceil((new Date(conflict.vacationEnd) - new Date(conflict.vacationStart)) / (1000 * 60 * 60 * 24)) + 1;

                                    return `
                                        <tr>
                                            <td><strong>${conflict.member}</strong></td>
                                            <td>${role}</td>
                                            <td>${formatDateFR(new Date(conflict.vacationStart))} - ${formatDateFR(new Date(conflict.vacationEnd))}</td>
                                            <td>${days} jours</td>
                                        </tr>
                                    `;
                                }).join('')
                            }
                        </tbody>
                    </table>
                    
                    <div class="quick-actions">
                        <button class="btn btn-danger" onclick="resolveConflict(${week})">
                            🔧 Résoudre ce conflit
                        </button>
                        <button class="btn btn-primary btn-small" onclick="editWeek(${week})">
                            ✏️ Modifier l'assignation
                        </button>
                    </div>
                `;

                container.appendChild(conflictDiv);
            });

            // Afficher les solutions des conflits résolus si disponibles
            renderResolvedSolutions();
        }

        function detectConflicts() {
            conflicts = [];

            Object.entries(assignments).forEach(([weekKey, assignment]) => {
                const weekNum = parseInt(weekKey.split('-W')[1]);
                const year = parseInt(weekKey.split('-W')[0]);
                const weekDates = getWeekDates(year, weekNum);

                // Vérifier chaque membre de l'assignation
                [assignment.member1, assignment.member2, assignment.backup].forEach(member => {
                    if (vacations[member]) {
                        vacations[member].forEach(vacation => {
                            const vacStart = new Date(vacation.start);
                            const vacEnd = new Date(vacation.end);

                            // Vérifier si les vacances chevauchent avec la semaine
                            if (datesOverlap(weekDates.start, weekDates.end, vacStart, vacEnd)) {
                                conflicts.push({
                                    week: weekNum,
                                    member: member,
                                    vacationStart: vacation.start,
                                    vacationEnd: vacation.end,
                                    assignment: assignment
                                });
                            }
                        });
                    }
                });
            });

            updateStats();
            return conflicts;
        }

        function getWeekDates(year, weekNum) {
            // Calculer le premier jeudi de l'année
            const jan1 = new Date(year, 0, 1);
            const jan1Day = jan1.getDay() || 7;

            let firstThursday = new Date(year, 0, 1);
            if (jan1Day <= 4) {
                firstThursday.setDate(jan1.getDate() + (4 - jan1Day));
            } else {
                firstThursday.setDate(jan1.getDate() + (11 - jan1Day));
            }

            // Premier lundi de la semaine 1
            const firstMonday = new Date(firstThursday);
            firstMonday.setDate(firstThursday.getDate() - 3);

            // Lundi de la semaine demandée
            const weekStart = new Date(firstMonday);
            weekStart.setDate(firstMonday.getDate() + (weekNum - 1) * 7);

            // Dimanche de la semaine
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            return { start: weekStart, end: weekEnd };
        }

        function datesOverlap(start1, end1, start2, end2) {
            return start1 <= end2 && end1 >= start2;
        }

        function formatDateFR(date) {
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('fr-FR', options);
        }

        function getWeeksInMonth(year, month) {
            const weeks = [];
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            let current = new Date(firstDay);

            while (current <= lastDay) {
                const weekNum = getWeekNumber(current);
                if (!weeks.find(w => w.number === weekNum)) {
                    weeks.push({
                        number: weekNum,
                        start: new Date(current)
                    });
                }
                current.setDate(current.getDate() + 7);
            }

            return weeks;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function switchView(event, view) {
            currentView = view;

            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Si appelé sans événement (depuis YearView), mettre à jour manuellement l'onglet correct
                const viewTabs = document.querySelectorAll('.view-tab');
                if (view === 'year') viewTabs[0].classList.add('active');
                else viewTabs[1].classList.add('active');
            }

            if (view === 'year') {
                document.getElementById('yearView').style.display = 'grid';
                document.getElementById('monthView').style.display = 'none';
            } else {
                document.getElementById('yearView').style.display = 'none';
                document.getElementById('monthView').style.display = 'block';
            }

            updateDisplay();
        }

        function changeYear(delta) {
            currentYear += delta;
            updateDisplay();
            detectConflicts();
            // Actualiser la vue du tableau de bord si elle est active
            if (currentTab === 'dashboard') {
                renderDashboardView();
            }
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderMonthView();
        }

        function showAssignModal() {
            document.getElementById('assignModal').style.display = 'block';
        }

        function showVacationModal() {
            document.getElementById('vacationModal').style.display = 'block';
        }

        function addVacationForMember(member) {
            document.getElementById('vacationMember').value = member;
            showVacationModal();
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function editWeek(weekNum) {
            const weekKey = `${currentYear}-W${weekNum}`;
            const assignment = assignments[weekKey];

            const weekInput = document.getElementById('weekInput');
            weekInput.value = weekKey;

            if (assignment) {
                document.getElementById('member1').value = assignment.member1;
                document.getElementById('member2').value = assignment.member2;
                document.getElementById('backup').value = assignment.backup;
            } else {
                document.getElementById('member1').value = '';
                document.getElementById('member2').value = '';
                document.getElementById('backup').value = '';
            }

            showAssignModal();
        }

        function saveAssignment(event) {
            event.preventDefault();

            const weekValue = document.getElementById('weekInput').value;
            const member1 = document.getElementById('member1').value;
            const member2 = document.getElementById('member2').value;
            const backup = document.getElementById('backup').value;

            if (member1 === member2) {
                showNotification('Les deux membres doivent être différents !', 'error');
                return;
            }

            assignments[weekValue] = { member1, member2, backup };

            saveData();
            closeModal('assignModal');
            detectConflicts();
            updateDisplay();
            showNotification('✅ Assignation enregistrée !', 'success');
        }

        function saveVacation(event) {
            event.preventDefault();

            const member = document.getElementById('vacationMember').value;
            const start = document.getElementById('vacationStart').value;
            const end = document.getElementById('vacationEnd').value;

            if (new Date(end) < new Date(start)) {
                showNotification('La date de fin doit être après la date de début !', 'error');
                return;
            }

            if (!vacations[member]) {
                vacations[member] = [];
            }

            vacations[member].push({ start, end });

            const days = Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)) + 1;

            saveData();
            closeModal('vacationModal');
            detectConflicts();
            updateDisplay();

            if (currentTab === 'absences') {
                renderAbsencesView();
            }

            showNotification(`✅ ${days} jours d'absence enregistrés pour ${member}`, 'success');
        }

        function autoFillYear() {
            if (!confirm('Remplir automatiquement toute l\'année avec une répartition équitable ?')) return;

            // Réinitialiser toutes les assignations de l'année en cours
            for (let week = 1; week <= 52; week++) {
                const weekKey = `${currentYear}-W${week}`;
                // Attribution équitable : on parcourt la liste des référents de façon cyclique
                const idx = (week - 1) % TEAM.length;
                const member1 = TEAM[idx];
                const member2 = TEAM[(idx + 1) % TEAM.length];
                const backup = TEAM[(idx + 2) % TEAM.length];
                assignments[weekKey] = {
                    member1: member1,
                    member2: member2,
                    backup: backup
                };
            }

            saveData();
            detectConflicts();
            updateDisplay();
            showNotification('✅ Planning rempli avec répartition équitable !', 'success');
        }

        function resolveConflict(weekNum) {
            const weekKey = `${currentYear}-W${weekNum}`;
            const weekConflicts = conflicts.filter(c => c.week === weekNum);

            // Membres en conflit
            const conflictMembers = weekConflicts.map(c => c.member);

            // Trouver des membres disponibles
            const available = TEAM.filter(member => {
                // Pas en conflit
                if (conflictMembers.includes(member)) return false;

                // Pas en vacances cette semaine
                if (!vacations[member]) return true;

                const weekDates = getWeekDates(currentYear, weekNum);
                return !vacations[member].some(vac => {
                    const vacStart = new Date(vac.start);
                    const vacEnd = new Date(vac.end);
                    return datesOverlap(weekDates.start, weekDates.end, vacStart, vacEnd);
                });
            });

            // Enregistrer les propositions et la solution choisie
            const solutionRecord = {
                week: weekNum,
                proposals: available.slice(), // Copier les membres disponibles
                chosen: null
            };

            if (available.length >= 3) {
                assignments[weekKey] = {
                    member1: available[0],
                    member2: available[1],
                    backup: available[2]
                };
                solutionRecord.chosen = {
                    member1: available[0],
                    member2: available[1],
                    backup: available[2]
                };

                saveData();
                detectConflicts();
                updateDisplay();

                // Si nous sommes sur le tableau de bord ou la page conflits, mettre à jour la vue
                if (currentTab === 'conflicts') {
                    renderConflictsView();
                }
                if (currentTab === 'dashboard') {
                    renderDashboardView();
                }

                showNotification(`✅ Conflit résolu pour la semaine ${weekNum}`, 'success');
            } else {
                showNotification(`❌ Pas assez de membres disponibles pour la semaine ${weekNum}`, 'error');
            }

            // Ajouter le record à l'historique des solutions
            resolvedSolutions.push(solutionRecord);

            // Rafraîchir l'affichage des solutions résolues
            renderResolvedSolutions();
        }

        function resolveAllConflicts() {
            if (conflicts.length === 0) {
                showNotification('Aucun conflit à résoudre', 'info');
                return;
            }

            const uniqueWeeks = [...new Set(conflicts.map(c => c.week))];
            let resolved = 0;

            uniqueWeeks.forEach(week => {
                // Avant résolution, enregistrer l'état actuel
                const beforeCount = conflicts.length;
                resolveConflict(week);
                detectConflicts();
                if (conflicts.filter(c => c.week === week).length === 0) {
                    resolved++;
                }
            });

            showNotification(`✅ ${resolved}/${uniqueWeeks.length} conflits résolus`, resolved > 0 ? 'success' : 'warning');
        }

        function exportPlanning() {
            const data = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                year: currentYear,
                assignments: assignments,
                vacations: vacations,
                stats: {
                    totalAssignments: Object.keys(assignments).length,
                    totalVacations: Object.values(vacations).reduce((sum, v) => sum + v.length, 0),
                    conflicts: conflicts.length
                },
                resolvedSolutions: resolvedSolutions
            };

            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `planning-${currentYear}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            showNotification('💾 Planning exporté !', 'success');
        }

        /**
         * Formate une date en chaîne AAAA-MM-JJ pour le CSV/Excel.
         * @param {Date} date
         * @returns {string}
         */
        function formatDateCSV(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        /**
         * Formate une date en chaîne AAAAMMJJ pour le format iCalendar.
         * @param {Date} date
         * @returns {string}
         */
        function formatDateICS(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}${m}${d}`;
        }

        /**
         * Exporte le planning sous forme de fichier CSV (compatible Excel).
         */
        function exportExcel() {
            let csv = 'Semaine,Date début,Date fin,Membre 1,Membre 2,Backup\n';
            const totalWeeks = 52;
            for (let week = 1; week <= totalWeeks; week++) {
                const weekKey = `${currentYear}-W${week}`;
                const ass = assignments[weekKey];
                if (!ass) continue;
                const weekDates = getWeekDates(currentYear, week);
                const startStr = formatDateCSV(weekDates.start);
                const endStr = formatDateCSV(weekDates.end);
                csv += `${week},${startStr},${endStr},${ass.member1},${ass.member2},${ass.backup}\n`;
            }
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `planning-${currentYear}-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showNotification('📊 Fichier Excel/CSV exporté !', 'success');
        }

        /**
         * Exporte des fichiers .ics (Agenda) pour chaque membre avec leurs périodes de piquet.
         */
        function exportAgenda() {
            TEAM.forEach(member => {
                let ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Planning Manager//FR\nCALSCALE:GREGORIAN\n';
                const totalWeeks = 52;
                for (let week = 1; week <= totalWeeks; week++) {
                    const weekKey = `${currentYear}-W${week}`;
                    const ass = assignments[weekKey];
                    if (!ass) continue;
                    
                    let role = '';
                    let isPrincipal = false;
                    
                    if (ass.member1 === member || ass.member2 === member) {
                        role = 'Piquet Principal';
                        isPrincipal = true;
                    } else if (ass.backup === member) {
                        role = 'Backup';
                        isPrincipal = false;
                    } else {
                        continue; // Ce membre n'est pas assigné cette semaine
                    }
                    
                    const weekDates = getWeekDates(currentYear, week);
                    const start = weekDates.start;
                    const end = weekDates.end;
                    const dtStart = formatDateICS(start);
                    const dtEnd = formatDateICS(new Date(end.getFullYear(), end.getMonth(), end.getDate() + 1));
                    const uid = `${currentYear}-W${week}-${member.replace(/\s+/g, '_')}@planning`;
                    const stamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                    
                    // Définir les couleurs et catégories selon le rôle
                    const categories = isPrincipal ? 'PIQUET PRINCIPAL' : 'BACKUP';
                    const color = isPrincipal ? 'darkred' : 'darkblue';
                    
                    // Titre plus explicite
                    const summary = isPrincipal ? 
                        `🚨 PIQUET PRINCIPAL - Semaine ${week}` : 
                        `📞 BACKUP - Semaine ${week}`;
                    
                    // Description détaillée
                    let description = `Semaine ${week}\\n`;
                    description += `Équipe: ${ass.member1} + ${ass.member2}\\n`;
                    description += `Backup: ${ass.backup}\\n\\n`;
                    
                    if (isPrincipal) {
                        description += `⚠️ RESPONSABILITÉS PIQUET PRINCIPAL:\\n`;
                        description += `- Participer à la séance hebdomadaire\\n`;
                        description += `- Gérer la BAL (Boîte Aux Lettres)\\n`;
                        description += `- Traiter les demandes urgentes\\n`;
                        description += `- Assurer la permanence téléphonique\\n`;
                    } else {
                        description += `📞 RESPONSABILITÉS BACKUP:\\n`;
                        description += `- Être disponible en cas de besoin\\n`;
                        description += `- Remplacer si absence du piquet principal\\n`;
                        description += `- Support en cas de surcharge\\n`;
                    }
                    
                    ics += 'BEGIN:VEVENT\n';
                    ics += `UID:${uid}\n`;
                    ics += `DTSTAMP:${stamp}\n`;
                    ics += `DTSTART;VALUE=DATE:${dtStart}\n`;
                    ics += `DTEND;VALUE=DATE:${dtEnd}\n`;
                    ics += `SUMMARY:${summary}\n`;
                    ics += `DESCRIPTION:${description}\n`;
                    ics += `CATEGORIES:${categories}\n`;
                    ics += `STATUS:CONFIRMED\n`;
                    ics += `PRIORITY:${isPrincipal ? '1' : '5'}\n`;
                    // Ajouter une alarme pour les piquets principaux
                    if (isPrincipal) {
                        ics += 'BEGIN:VALARM\n';
                        ics += 'TRIGGER:-P1D\n'; // Rappel 1 jour avant
                        ics += 'ACTION:DISPLAY\n';
                        ics += 'DESCRIPTION:Rappel: Vous êtes de piquet principal demain!\\nN\'oubliez pas la séance et la gestion de la BAL.\n';
                        ics += 'END:VALARM\n';
                    }
                    ics += 'END:VEVENT\n';
                }
                ics += 'END:VCALENDAR';
                const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `agenda-${member.replace(/\s+/g, '_')}-${currentYear}.ics`;
                link.click();
            });
            showNotification('📅 Fichiers Agenda exportés avec distinction Piquet/Backup !', 'success');
        }

        /**
         * Supprime une période d'absence pour un membre donné.
         * @param {string} member
         * @param {string} start
         * @param {string} end
         */
        function deleteVacation(member, start, end) {
            if (!vacations[member]) return;
            if (!confirm('Supprimer cette absence ?')) return;
            vacations[member] = vacations[member].filter(v => !(v.start === start && v.end === end));
            saveData();
            detectConflicts();
            updateDisplay();
            if (currentTab === 'absences') {
                renderAbsencesView();
            }
            showNotification('📅 Absence supprimée', 'success');
        }

        /**
         * Génère artificiellement des conflits de test en créant des absences sur les premières semaines.
         */
        function generateTestConflicts() {
            const weeksToTest = 3;
            for (let week = 1; week <= weeksToTest; week++) {
                const weekKey = `${currentYear}-W${week}`;
                const ass = assignments[weekKey];
                if (!ass) continue;
                const weekDates = getWeekDates(currentYear, week);
                [ass.member1, ass.member2, ass.backup].forEach(member => {
                    if (!vacations[member]) vacations[member] = [];
                    const startStr = weekDates.start.toISOString().split('T')[0];
                    const endStr = weekDates.end.toISOString().split('T')[0];
                    if (!vacations[member].some(v => v.start === startStr && v.end === endStr)) {
                        vacations[member].push({ start: startStr, end: endStr });
                    }
                });
            }
            saveData();
            detectConflicts();
            updateDisplay();
            if (currentTab === 'absences') {
                renderAbsencesView();
            }
            if (currentTab === 'conflicts') {
                renderConflictsView();
            }
            showNotification('⚠️ Conflits de test générés', 'warning');
        }

        function updateStats() {
            const totalWeeks = 52;
            const assignedWeeks = Object.keys(assignments).filter(key =>
                key.startsWith(`${currentYear}-W`)
            ).length;

            const totalAbsences = Object.values(vacations).reduce((sum, v) => sum + v.length, 0);
            const conflictCount = [...new Set(conflicts.map(c => c.week))].length;
            const progress = Math.round((assignedWeeks / totalWeeks) * 100);

            document.getElementById('weeksAssigned').textContent = assignedWeeks;
            document.getElementById('totalAbsences').textContent = totalAbsences;
            document.getElementById('conflictsCount').textContent = conflictCount;
            document.getElementById('progressPercent').textContent = progress + '%';

            // Colorer les stats
            document.querySelectorAll('.stat-box').forEach(box => {
                box.classList.remove('good', 'warning', 'danger');
            });

            // Exemple simple : si toutes les semaines sont assignées, c'est bon
            if (assignedWeeks === totalWeeks) {
                document.querySelectorAll('.stat-box')[0].classList.add('good');
            } else if (assignedWeeks > totalWeeks * 0.75) {
                document.querySelectorAll('.stat-box')[0].classList.add('warning');
            } else {
                document.querySelectorAll('.stat-box')[0].classList.add('danger');
            }

            // Mise en évidence du nombre de conflits
            if (conflictCount > 0) {
                document.querySelectorAll('.stat-box')[2].classList.add('danger');
            } else {
                document.querySelectorAll('.stat-box')[2].classList.add('good');
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Affichage des solutions de conflits résolus
        function renderResolvedSolutions() {
            const container = document.getElementById('resolvedSolutionsContainer');
            container.innerHTML = '';
            if (!resolvedSolutions || resolvedSolutions.length === 0) {
                return;
            }
            const heading = document.createElement('h3');
            heading.style.margin = '2rem 0 1rem 0';
            heading.textContent = '📝 Solutions de résolution des conflits';
            container.appendChild(heading);

            resolvedSolutions.forEach(sol => {
                const solDiv = document.createElement('div');
                solDiv.style.background = '#F0F9FF';
                solDiv.style.border = '1px solid #BFDBFE';
                solDiv.style.padding = '1rem';
                solDiv.style.marginBottom = '0.75rem';
                solDiv.style.borderRadius = 'var(--radius-md)';
                solDiv.style.fontSize = '0.875rem';

                const proposals = sol.proposals.length > 0 ?
                    sol.proposals.map(m => `<span style="margin-right:0.5rem; padding: 0.25rem 0.5rem; background: white; border-radius: var(--radius-sm);">${m}</span>`).join('') :
                    '<em style="color: var(--gray-color);">Aucune proposition disponible</em>';

                const chosen = sol.chosen ?
                    `${sol.chosen.member1} + ${sol.chosen.member2} (Backup: ${sol.chosen.backup})` :
                    '<em style="color: var(--gray-color);">Pas de solution choisie</em>';

                solDiv.innerHTML = `
                    <strong style="color: var(--dark-color);">Semaine ${sol.week}</strong><br>
                    <div style="margin-top: 0.5rem;">
                        <strong>Propositions:</strong> ${proposals}
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <strong>Solution choisie:</strong> <span style="color: var(--success-color); font-weight: 600;">${chosen}</span>
                    </div>
                `;
                container.appendChild(solDiv);
            });
        }

        // Génération de la vue du tableau de bord
        function renderDashboardView() {
            const container = document.getElementById('dashboardContainer');
            container.innerHTML = '';
            
            // Stats globales
            let totalVacationDays = 0;
            let totalAssignments = 0;
            
            // Construction du tableau
            let html = '<table class="dashboard-table"><thead><tr>';
            html += '<th>Référent</th>';
            html += '<th>Semaines principales</th>';
            html += '<th>Semaines backup</th>';
            html += '<th>Jours d\'absence pris</th>';
            html += '<th>Jours autorisés</th>';
            html += '<th>Solde congés</th>';
            html += '<th>Charge (%)</th>';
            html += '<th>Statut</th>';
            html += '</tr></thead><tbody>';

            TEAM.forEach(member => {
                // Nombre de semaines où le référent est membre principal (member1 ou member2)
                let principalCount = 0;
                let backupCount = 0;
                Object.entries(assignments).forEach(([weekKey, assign]) => {
                    if (weekKey.startsWith(`${currentYear}-W`)) {
                        if (assign.member1 === member || assign.member2 === member) principalCount++;
                        if (assign.backup === member) backupCount++;
                    }
                });
                totalAssignments += principalCount + backupCount;

                // Périodes d'absence et jours d'absence
                const periods = vacations[member] ? vacations[member].length : 0;
                let daysAbsent = 0;
                if (vacations[member]) {
                    vacations[member].forEach(vac => {
                        const start = new Date(vac.start);
                        const end = new Date(vac.end);
                        daysAbsent += Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    });
                }
                totalVacationDays += daysAbsent;
                
                // Limite de vacances
                const defaultRef = Object.keys(customTeamNames).find(key => customTeamNames[key] === member) || member;
                const limit = vacationLimits[defaultRef] || 25; // 25 jours par défaut
                const balance = limit - daysAbsent;

                // Charge : on considère 1 point par assignation principale et 0.5 par backup
                const loadPoints = principalCount + backupCount * 0.5;
                const maxLoad = 52; // max 52 semaines
                const chargePercent = ((loadPoints / maxLoad) * 100).toFixed(1);

                // Coloration selon la charge
                let chargeColor = 'var(--success-color)';
                if (parseFloat(chargePercent) > 30) chargeColor = 'var(--warning-color)';
                if (parseFloat(chargePercent) > 50) chargeColor = 'var(--danger-color)';
                
                // Statut basé sur le solde de congés
                let statusColor = 'var(--success-color)';
                let statusText = '✅ OK';
                if (balance < 5) {
                    statusColor = 'var(--warning-color)';
                    statusText = '⚠️ Attention';
                }
                if (balance < 0) {
                    statusColor = 'var(--danger-color)';
                    statusText = '❌ Dépassement';
                }

                html += `<tr>
                    <td style="font-weight:600; color: var(--dark-color);">${member}</td>
                    <td>${principalCount}</td>
                    <td>${backupCount}</td>
                    <td>${daysAbsent}</td>
                    <td>${limit}</td>
                    <td style="font-weight: 600; color: ${balance < 0 ? 'var(--danger-color)' : 'var(--dark-color)'};">${balance}</td>
                    <td style="font-weight: 600; color: ${chargeColor};">${chargePercent}%</td>
                    <td style="color: ${statusColor};">${statusText}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            
            // Ajouter des stats récapitulatives
            const statsHtml = `
                <div style="margin-top: 2rem; padding: 1.5rem; background: var(--light-gray); border-radius: var(--radius-md);">
                    <h3 style="margin-bottom: 1rem; color: var(--dark-color);">Statistiques globales</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);">${totalVacationDays}</div>
                            <div style="color: var(--gray-color); font-size: 0.875rem;">Jours de congés pris au total</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--success-color);">${totalAssignments}</div>
                            <div style="color: var(--gray-color); font-size: 0.875rem;">Assignations totales</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--warning-color);">${(totalVacationDays / TEAM.length).toFixed(1)}</div>
                            <div style="color: var(--gray-color); font-size: 0.875rem;">Moyenne jours/personne</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = statsHtml + html;
        }

        // Génération de la vue des paramètres
        function renderSettingsView() {
            // Partie 1: Noms personnalisés
            const container = document.getElementById('teamNamesContainer');
            container.innerHTML = '';
            
            const defaultTeam = [
                'Référent 1', 'Référent 2', 'Référent 3', 'Référent 4', 'Référent 5',
                'Référent 6', 'Référent 7', 'Référent 8', 'Référent 9', 'Référent 10'
            ];
            
            defaultTeam.forEach((ref, index) => {
                const fieldDiv = document.createElement('div');
                fieldDiv.style.display = 'grid';
                fieldDiv.style.gridTemplateColumns = '150px 1fr';
                fieldDiv.style.gap = '1rem';
                fieldDiv.style.alignItems = 'center';
                
                fieldDiv.innerHTML = `
                    <label style="font-weight: 600; color: var(--dark-color);">${ref} :</label>
                    <input 
                        type="text" 
                        id="name-${ref}" 
                        value="${customTeamNames[ref] || ''}"
                        placeholder="Ex: Fred, Marie, Jean..."
                        style="padding: 0.625rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm); font-size: 0.875rem;"
                    >
                `;
                
                container.appendChild(fieldDiv);
            });
            
            // Partie 2: Limites de vacances
            const limitsContainer = document.getElementById('vacationLimitsContainer');
            limitsContainer.innerHTML = '';
            
            defaultTeam.forEach((ref, index) => {
                const displayName = customTeamNames[ref] || ref;
                const fieldDiv = document.createElement('div');
                fieldDiv.style.display = 'grid';
                fieldDiv.style.gridTemplateColumns = '250px 100px auto';
                fieldDiv.style.gap = '1rem';
                fieldDiv.style.alignItems = 'center';
                
                const currentLimit = vacationLimits[ref] || 25;
                const memberVacations = vacations[displayName] || [];
                let daysUsed = 0;
                memberVacations.forEach(vac => {
                    const start = new Date(vac.start);
                    const end = new Date(vac.end);
                    daysUsed += Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                });
                const remaining = currentLimit - daysUsed;
                
                fieldDiv.innerHTML = `
                    <label style="font-weight: 600; color: var(--dark-color);">${displayName} :</label>
                    <input 
                        type="number" 
                        id="limit-${ref}" 
                        value="${currentLimit}"
                        min="0"
                        max="50"
                        style="padding: 0.625rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm); font-size: 0.875rem;"
                    >
                    <span style="font-size: 0.875rem; color: ${remaining < 0 ? 'var(--danger-color)' : 'var(--gray-color)'};">
                        ${daysUsed} jours pris / ${remaining} restants
                    </span>
                `;
                
                limitsContainer.appendChild(fieldDiv);
            });
        }
        
        // Sauvegarder les limites de vacances
        function saveVacationLimits() {
            const defaultTeam = [
                'Référent 1', 'Référent 2', 'Référent 3', 'Référent 4', 'Référent 5',
                'Référent 6', 'Référent 7', 'Référent 8', 'Référent 9', 'Référent 10'
            ];
            
            defaultTeam.forEach(ref => {
                const input = document.getElementById(`limit-${ref}`);
                if (input) {
                    vacationLimits[ref] = parseInt(input.value) || 25;
                }
            });
            
            saveData();
            showNotification('✅ Limites de congés mises à jour !', 'success');
            
            // Rafraîchir le tableau de bord si on y est
            if (currentTab === 'dashboard') {
                renderDashboardView();
            }
        }
        
        // Sauvegarder les noms personnalisés
        function saveTeamNames() {
            const defaultTeam = [
                'Référent 1', 'Référent 2', 'Référent 3', 'Référent 4', 'Référent 5',
                'Référent 6', 'Référent 7', 'Référent 8', 'Référent 9', 'Référent 10'
            ];
            
            const oldNames = {...customTeamNames};
            customTeamNames = {};
            
            defaultTeam.forEach(ref => {
                const input = document.getElementById(`name-${ref}`);
                if (input && input.value.trim()) {
                    customTeamNames[ref] = input.value.trim();
                }
            });
            
            // Mettre à jour les assignments et vacations avec les nouveaux noms
            updateDataWithNewNames(oldNames, customTeamNames);
            
            applyCustomNames();
            saveData();
            populateSelects();
            updateDisplay();
            
            showNotification('✅ Noms des référents mis à jour !', 'success');
        }
        
        // Mettre à jour les données avec les nouveaux noms
        function updateDataWithNewNames(oldNames, newNames) {
            const defaultTeam = [
                'Référent 1', 'Référent 2', 'Référent 3', 'Référent 4', 'Référent 5',
                'Référent 6', 'Référent 7', 'Référent 8', 'Référent 9', 'Référent 10'
            ];
            
            // Créer un mapping des anciens noms vers les nouveaux
            const nameMapping = {};
            defaultTeam.forEach(ref => {
                const oldName = oldNames[ref] || ref;
                const newName = newNames[ref] || ref;
                if (oldName !== newName) {
                    nameMapping[oldName] = newName;
                }
            });
            
            // Mettre à jour les assignments
            Object.keys(assignments).forEach(weekKey => {
                const assignment = assignments[weekKey];
                if (nameMapping[assignment.member1]) assignment.member1 = nameMapping[assignment.member1];
                if (nameMapping[assignment.member2]) assignment.member2 = nameMapping[assignment.member2];
                if (nameMapping[assignment.backup]) assignment.backup = nameMapping[assignment.backup];
            });
            
            // Mettre à jour les vacations
            const newVacations = {};
            Object.keys(vacations).forEach(member => {
                const newMemberName = nameMapping[member] || member;
                newVacations[newMemberName] = vacations[member];
            });
            vacations = newVacations;
        }
        
        // Réinitialiser les noms
        function resetTeamNames() {
            if (!confirm('Voulez-vous vraiment réinitialiser tous les noms par défaut ?')) return;
            
            customTeamNames = {};
            applyCustomNames();
            saveData();
            populateSelects();
            updateDisplay();
            renderSettingsView();
            
            showNotification('🔄 Noms réinitialisés !', 'info');
        }

        // Fermer les modals en cliquant dehors
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>
