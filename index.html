<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Manager - Gestion Compl√®te (Am√©lior√©)</title>
    <style>
        /* Reset de base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .toolbar {
            background: #ecf0f1;
            padding: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-info { background: #17a2b8; color: white; }

        .year-selector {
            display: flex;
            aligns: center;
            gap: 10px;
            font-weight: bold;
            font-size: 18px;
        }

        .year-selector button {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: #34495e;
            color: white;
            cursor: pointer;
        }

        .main-content {
            padding: 20px;
        }

        /* Onglets de navigation principaux */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .nav-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Alertes de conflits am√©lior√©es */
        .conflict-details {
            background: #fff5f5;
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .conflict-details h3 {
            color: #c0392b;
            margin-bottom: 15px;
        }

        .conflict-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .conflict-table th,
        .conflict-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .conflict-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .conflict-table tr:hover {
            background: #f8f9fa;
        }

        /* Page Absences */
        .absences-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .member-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .member-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .absence-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .absence-dates {
            font-weight: bold;
            color: #e74c3c;
        }

        .absence-duration {
            background: #f39c12;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        /* Stats am√©lior√©es */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid transparent;
        }

        .stat-box.good { border-color: #27ae60; }
        .stat-box.warning { border-color: #f39c12; }
        .stat-box.danger { border-color: #e74c3c; }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Calendrier Vue Ann√©e */
        .calendar-year {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .month-block {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .month-header {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
        }

        .month-header:hover {
            background: #2c3e50;
        }

        .weeks-container {
            padding: 10px;
        }

        .week-row {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .week-row:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .week-row.assigned {
            background: #e8f5e9;
            border-left: 4px solid #27ae60;
        }

        .week-row.conflict {
            background: #ffebee;
            border-left: 4px solid #e74c3c;
            font-weight: bold;
        }

        .week-row.vacation {
            background: #fff3e0;
            border-left: 4px solid #f39c12;
        }

        .week-number {
            font-weight: bold;
            color: #666;
        }

        .week-team {
            flex: 1;
            text-align: center;
        }

        .week-status {
            color: #e74c3c;
            font-weight: bold;
        }

        /* Vue Mensuelle */
        .calendar-month {
            display: none;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 20px;
        }

        .day-header {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .day-cell {
            min-height: 100px;
            border: 1px solid #ddd;
            padding: 5px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .day-cell:hover {
            background: #f8f9fa;
            transform: scale(1.02);
        }

        .day-cell.other-month {
            background: #f5f5f5;
            color: #999;
        }

        .day-cell.has-assignment {
            background: #e8f5e9;
        }

        .day-cell.has-conflict {
            background: #ffebee;
            border: 2px solid #e74c3c;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .day-info {
            font-size: 0.7em;
            margin-top: 5px;
        }

        .conflict-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            color: #e74c3c;
            font-weight: bold;
        }

        /* Navigation mois */
        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-nav h2 {
            font-size: 24px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }

        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
        .notification.warning { background: #f39c12; }
        .notification.info { background: #3498db; }

        /* Tableau de bord am√©lior√© */
        .dashboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .dashboard-table th,
        .dashboard-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        .dashboard-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .dashboard-table tr:hover {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Planning des R√©f√©rents - Gestion Compl√®te</h1>
        </div>

        <div class="toolbar">
            <div class="year-selector">
                <button id="prevYear">&lt;</button>
                <span id="currentYear">2025</span>
                <button id="nextYear">&gt;</button>
            </div>
            <button class="btn btn-primary" onclick="openModal('assignModal')">üìÖ Assigner Semaine</button>
            <button class="btn btn-warning" onclick="openModal('vacationModal')">üå¥ Ajouter Vacances</button>
            <button class="btn btn-success" onclick="autoFillYear()">‚úÖ Remplir l'Ann√©e</button>
            <button class="btn btn-danger" onclick="resolveAllConflicts()">üõ†Ô∏è R√©soudre Tous les Conflits</button>
            <button class="btn btn-info" onclick="exportAgendas()">üìÖ Exporter Agenda</button>
            <button class="btn btn-info" onclick="exportExcel()">üìä Exporter Excel</button>
            <button class="btn btn-warning" onclick="generateTestConflicts()">‚ö†Ô∏è Tester Conflicts</button>
        </div>

        <div class="main-content">
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="planning">Planning</button>
                <button class="nav-tab" data-tab="absences">Absences</button>
                <button class="nav-tab" data-tab="conflicts">Conflits</button>
                <button class="nav-tab" data-tab="dashboard">Tableau de bord</button>
            </div>

            <!-- Tab planning -->
            <div class="tab-content active" id="planningTab">
                <div class="stats-bar">
                    <div class="stat-box">
                        <div class="stat-number" id="weeksAssigned">0</div>
                        <div class="stat-label">Semaines Assign√©es</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="totalAbsences">0</div>
                        <div class="stat-label">P√©riodes d'Absence</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="conflictsCount">0</div>
                        <div class="stat-label">Conflits Actifs</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="progressPercent">0%</div>
                        <div class="stat-label">Progression</div>
                    </div>
                </div>
                <div>
                    <button id="viewYearBtn" class="btn btn-primary">Vue Ann√©e</button>
                    <button id="viewMonthBtn" class="btn btn-primary">Vue Mois</button>
                </div>
                <div id="calendarYear" class="calendar-year"></div>
                <div id="calendarMonth" class="calendar-month"></div>
            </div>

            <!-- Tab absences -->
            <div class="tab-content" id="absencesTab">
                <h2>Gestion des Absences</h2>
                <div id="absencesContainer" class="absences-container"></div>
            </div>

            <!-- Tab conflicts -->
            <div class="tab-content" id="conflictsTab">
                <h2>Gestion des Conflits</h2>
                <div id="conflictsContainer"></div>
                <div id="resolvedSolutionsContainer"></div>
            </div>

            <!-- Tab dashboard -->
            <div class="tab-content" id="dashboardTab">
                <h2>Tableau de bord des R√©f√©rents</h2>
                <div id="dashboardContainer"></div>
            </div>
        </div>
    </div>

    <!-- Assign modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assignModal')">&times;</span>
            <h2>Assigner une √©quipe</h2>
            <div class="form-group">
                <label for="assignWeek">Semaine (1-52)</label>
                <input type="number" id="assignWeek" min="1" max="52">
            </div>
            <div class="form-group">
                <label for="assignMember1">Membre 1</label>
                <select id="assignMember1"></select>
            </div>
            <div class="form-group">
                <label for="assignMember2">Membre 2</label>
                <select id="assignMember2"></select>
            </div>
            <div class="form-group">
                <label for="assignBackup">Backup</label>
                <select id="assignBackup"></select>
            </div>
            <button class="btn btn-primary" onclick="assignWeek()">Assigner</button>
        </div>
    </div>

    <!-- Vacation modal -->
    <div id="vacationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('vacationModal')">&times;</span>
            <h2>Ajouter une p√©riode de vacances</h2>
            <div class="form-group">
                <label for="vacationMember">R√©f√©rent</label>
                <select id="vacationMember"></select>
            </div>
            <div class="form-group">
                <label for="vacationStart">Date de d√©but</label>
                <input type="date" id="vacationStart">
            </div>
            <div class="form-group">
                <label for="vacationEnd">Date de fin</label>
                <input type="date" id="vacationEnd">
            </div>
            <button class="btn btn-primary" onclick="addVacation()">Enregistrer</button>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        let currentYear = new Date().getFullYear();
        let TEAM = [
            "R√©f√©rent 1", "R√©f√©rent 2", "R√©f√©rent 3", "R√©f√©rent 4", "R√©f√©rent 5",
            "R√©f√©rent 6", "R√©f√©rent 7", "R√©f√©rent 8", "R√©f√©rent 9", "R√©f√©rent 10"
        ];
        let assignments = {};  // format: { '2025-W1': { member1: 'R√©f√©rent 1', member2: 'R√©f√©rent 2', backup: 'R√©f√©rent 3' }, ... }
        let vacations = {};    // format: { 'R√©f√©rent 1': [ { start: '2025-01-01', end: '2025-01-07' }, ... ], ... }
        let conflicts = [];    // liste des conflits d√©tect√©s
        let resolvedSolutions = []; // historique des solutions appliqu√©es

        // Navigation entre les tabs
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');

        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                navTabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
                // Mettre √† jour l'affichage si besoin
                if (tab.dataset.tab === 'planning') {
                    renderCalendar();
                } else if (tab.dataset.tab === 'absences') {
                    renderAbsencesView();
                } else if (tab.dataset.tab === 'conflicts') {
                    renderConflictsView();
                } else if (tab.dataset.tab === 'dashboard') {
                    renderDashboardView();
                }
            });
        });

        // Changer l'ann√©e
        document.getElementById('prevYear').addEventListener('click', () => {
            currentYear--;
            document.getElementById('currentYear').textContent = currentYear;
            updateDisplay();
        });
        document.getElementById('nextYear').addEventListener('click', () => {
            currentYear++;
            document.getElementById('currentYear').textContent = currentYear;
            updateDisplay();
        });
        document.getElementById('currentYear').textContent = currentYear;

        function updateDisplay() {
            renderCalendar();
            updateStats();
            // Actualiser la vue courante
            if (document.getElementById('absencesTab').classList.contains('active')) {
                renderAbsencesView();
            }
            if (document.getElementById('conflictsTab').classList.contains('active')) {
                renderConflictsView();
            }
            if (document.getElementById('dashboardTab').classList.contains('active')) {
                renderDashboardView();
            }
        }

        // Remplir les listes d√©roulantes pour assigner et pour les vacances
        function populateMemberSelects() {
            const selects = [
                document.getElementById('assignMember1'),
                document.getElementById('assignMember2'),
                document.getElementById('assignBackup'),
                document.getElementById('vacationMember')
            ];
            selects.forEach(select => {
                select.innerHTML = '';
                TEAM.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    select.appendChild(option);
                });
            });
        }
        populateMemberSelects();

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function assignWeek() {
            const week = parseInt(document.getElementById('assignWeek').value);
            const member1 = document.getElementById('assignMember1').value;
            const member2 = document.getElementById('assignMember2').value;
            const backup = document.getElementById('assignBackup').value;

            if (week < 1 || week > 52) {
                showNotification('‚ùå Semaine invalide¬†!', 'error');
                return;
            }
            if (!member1 || !member2 || !backup) {
                showNotification('‚ùå S√©lectionnez tous les membres¬†!', 'error');
                return;
            }
            if (member1 === member2 || member1 === backup || member2 === backup) {
                showNotification('‚ùå Les membres doivent √™tre diff√©rents¬†!', 'error');
                return;
            }

            const weekKey = `${currentYear}-W${week}`;
            assignments[weekKey] = { member1, member2, backup };
            saveData();
            closeModal('assignModal');
            detectConflicts();
            updateDisplay();
            showNotification(`‚úÖ Semaine ${week} assign√©e √† ${member1} & ${member2} (Backup: ${backup})`, 'success');
        }

        function addVacation() {
            const member = document.getElementById('vacationMember').value;
            const start = document.getElementById('vacationStart').value;
            const end = document.getElementById('vacationEnd').value;

            if (!member || !start || !end) {
                showNotification('‚ùå Tous les champs sont requis¬†!', 'error');
                return;
            }
            if (new Date(start) > new Date(end)) {
                showNotification('‚ùå La date de d√©but doit √™tre avant la date de fin¬†!', 'error');
                return;
            }

            if (!vacations[member]) {
                vacations[member] = [];
            }

            vacations[member].push({ start, end });

            const days = Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)) + 1;

            saveData();
            closeModal('vacationModal');
            detectConflicts();
            updateDisplay();

            if (document.getElementById('absencesTab').classList.contains('active')) {
                renderAbsencesView();
            }

            showNotification(`‚úÖ ${days} jours d'absence enregistr√©s pour ${member}`, 'success');
        }

        function autoFillYear() {
            // Demande de confirmation avant de r√©initialiser et remplir le planning avec une r√©partition √©quilibr√©e.
            if (!confirm('Remplir automatiquement toute l\\'ann√©e avec une r√©partition globale √©quilibr√©e¬†?')) return;

            // R√©initialiser toutes les assignations de l'ann√©e en cours avec une r√©partition globale √©quilibr√©e.
            // L'objectif est que chaque r√©f√©rent soit assign√© un nombre similaire de fois au r√¥le de membre (1 ou 2) et en tant que backup.
            // On maintient des compteurs pour suivre le nombre d'attributions primaires et de backup par r√©f√©rent.
            const primaryCounts = {};
            const backupCounts = {};
            TEAM.forEach(member => {
                primaryCounts[member] = 0;
                backupCounts[member] = 0;
            });
            // Pour chaque semaine, choisir les deux r√©f√©rents ayant le moins d'attributions primaires, puis le backup ayant le moins d'attributions backup.
            for (let week = 1; week <= 52; week++) {
                const weekKey = `${currentYear}-W${week}`;
                // Trier les r√©f√©rents par nombre d'attributions primaires croissant
                const sortedPrimary = [...TEAM].sort((a, b) => primaryCounts[a] - primaryCounts[b]);
                const member1 = sortedPrimary[0];
                // Chercher le deuxi√®me membre avec le moins d'attributions primaires qui n'est pas le m√™me que member1
                let member2 = null;
                for (let i = 1; i < sortedPrimary.length; i++) {
                    if (sortedPrimary[i] !== member1) {
                        member2 = sortedPrimary[i];
                        break;
                    }
                }
                // Trier les r√©f√©rents par nombre d'attributions backup croissant et choisir le premier diff√©rent des deux primaires
                const sortedBackup = [...TEAM].sort((a, b) => backupCounts[a] - backupCounts[b]);
                let backup = null;
                for (const candidate of sortedBackup) {
                    if (candidate !== member1 && candidate !== member2) {
                        backup = candidate;
                        break;
                    }
                }
                // Enregistrer l'assignation de la semaine
                assignments[weekKey] = {
                    member1: member1,
                    member2: member2,
                    backup: backup
                };
                // Mettre √† jour les compteurs
                primaryCounts[member1]++;
                primaryCounts[member2]++;
                backupCounts[backup]++;
            }

            saveData();
            detectConflicts();
            updateDisplay();
            showNotification('‚úÖ Planning rempli avec r√©partition globale √©quilibr√©e¬†!', 'success');
        }

        function resolveConflict(weekNum) {
            const weekKey = `${currentYear}-W${weekNum}`;
            const weekConflicts = conflicts.filter(c => c.week === weekNum);

            // Membres en conflit
            const conflictMembers = weekConflicts.map(c => c.member);

            // Trouver des membres disponibles (non en conflit et sans vacances sur cette semaine)
            let available = TEAM.filter(member => {
                // Ne pas prendre les membres d√©j√† en conflit
                if (conflictMembers.includes(member)) return false;

                // Pas en vacances cette semaine
                if (!vacations[member]) return true;

                const weekDates = getWeekDates(currentYear, weekNum);
                return !vacations[member].some(vac => {
                    const vacStart = new Date(vac.start);
                    const vacEnd = new Date(vac.end);
                    return datesOverlap(weekDates.start, weekDates.end, vacStart, vacEnd);
                });
            });

            // S'il n'y a pas suffisamment de membres disponibles, compl√©ter en ignorant les vacances puis les conflits si besoin.
            if (available.length < 3) {
                // Ajouter des membres hors vacances (mais pouvant √™tre en vacances) qui ne sont pas d√©j√† pr√©sents
                TEAM.forEach(member => {
                    if (available.length >= 3) return;
                    if (!conflictMembers.includes(member) && !available.includes(member)) {
                        available.push(member);
                    }
                });
            }
            if (available.length < 3) {
                // En dernier recours, inclure m√™me les membres en conflit pour atteindre 3 membres
                conflictMembers.forEach(member => {
                    if (available.length >= 3) return;
                    if (!available.includes(member)) {
                        available.push(member);
                    }
                });
            }

            // Enregistrer les propositions et la solution choisie
            const solutionRecord = {
                week: weekNum,
                proposals: available.slice(), // Copier les membres disponibles
                chosen: null
            };

            if (available.length >= 3) {
                assignments[weekKey] = {
                    member1: available[0],
                    member2: available[1],
                    backup: available[2]
                };
                solutionRecord.chosen = {
                    member1: available[0],
                    member2: available[1],
                    backup: available[2]
                };

                saveData();
                detectConflicts();
                updateDisplay();

                // Si nous sommes sur le tableau de bord ou la page conflits, mettre √† jour la vue
                if (document.getElementById('conflictsTab').classList.contains('active')) {
                    renderConflictsView();
                }
                if (document.getElementById('dashboardTab').classList.contains('active')) {
                    renderDashboardView();
                }

                showNotification(`‚úÖ Conflit r√©solu pour la semaine ${weekNum}`, 'success');
            } else {
                showNotification(`‚ùå Pas assez de membres disponibles pour la semaine ${weekNum}`, 'error');
            }

            // Ajouter le record √† l'historique des solutions
            resolvedSolutions.push(solutionRecord);

            // Rafra√Æchir l'affichage des solutions r√©solues
            renderResolvedSolutions();
        }

        function resolveAllConflicts() {
            if (conflicts.length === 0) {
                showNotification('Aucun conflit √† r√©soudre', 'info');
                return;
            }

            const uniqueWeeks = [...new Set(conflicts.map(c => c.week))];
            let resolved = 0;

            uniqueWeeks.forEach(week => {
                // R√©soudre chaque conflit en utilisant la fonction d√©di√©e
                const initialConflicts = conflicts.length;
                resolveConflict(week);
                if (conflicts.length < initialConflicts) {
                    resolved++;
                }
            });

            detectConflicts();
            if (resolved > 0) {
                showNotification(`‚úÖ ${resolved} conflit(s) r√©solu(s)`, 'success');
            } else {
                showNotification('‚ùå Aucun conflit n\\'a pu √™tre r√©solu', 'error');
            }
        }

        // D√©tecter les conflits (absence sur une assignation)
        function detectConflicts() {
            conflicts = [];
            // Pour chaque semaine assign√©e
            Object.keys(assignments).forEach(key => {
                const [year, w] = key.split('-W');
                const week = parseInt(w);
                const assign = assignments[key];
                const weekDates = getWeekDates(parseInt(year), week);
                // V√©rifier les trois membres
                [assign.member1, assign.member2, assign.backup].forEach(role => {
                    if (vacations[role]) {
                        vacations[role].forEach(vac => {
                            const vacStart = new Date(vac.start);
                            const vacEnd   = new Date(vac.end);
                            if (datesOverlap(weekDates.start, weekDates.end, vacStart, vacEnd)) {
                                conflicts.push({
                                    week: week,
                                    member: role,
                                    role: (role === assign.backup ? 'Backup' : 'Principal'),
                                    conflictStart: vac.start,
                                    conflictEnd: vac.end
                                });
                            }
                        });
                    }
                });
            });
        }

        function datesOverlap(start1, end1, start2, end2) {
            return (start1 <= end2) && (start2 <= end1);
        }

        // Calculer les dates de d√©but et de fin d'une semaine (ISO-8601)
        function getWeekDates(year, week) {
            const simple = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
            const dow = simple.getUTCDay();
            const ISOweekStart = simple;
            if (dow <= 4) {
                ISOweekStart.setUTCDate(simple.getUTCDate() - simple.getUTCDay() + 1);
            } else {
                ISOweekStart.setUTCDate(simple.getUTCDate() + 8 - simple.getUTCDay());
            }
            const ISOweekEnd = new Date(ISOweekStart);
            ISOweekEnd.setUTCDate(ISOweekStart.getUTCDate() + 6);
            return { start: ISOweekStart, end: ISOweekEnd };
        }

        function renderCalendar() {
            const calendarYearDiv = document.getElementById('calendarYear');
            calendarYearDiv.innerHTML = '';
            const calendarMonthDiv = document.getElementById('calendarMonth');
            calendarMonthDiv.innerHTML = '';
            const months = [
                'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
            ];

            // Vue ann√©e
            const yearContainer = document.getElementById('calendarYear');
            yearContainer.style.display = 'grid';
            const monthContainer = document.getElementById('calendarMonth');
            monthContainer.style.display = 'none';

            months.forEach((month, index) => {
                const monthBlock = document.createElement('div');
                monthBlock.className = 'month-block';

                const monthHeader = document.createElement('div');
                monthHeader.className = 'month-header';
                monthHeader.textContent = month;
                monthHeader.onclick = () => {
                    renderMonthlyCalendar(index);
                };
                monthBlock.appendChild(monthHeader);

                const weeksContainer = document.createElement('div');
                weeksContainer.className = 'weeks-container';

                // Afficher les 4 ou 5 semaines (index->month + 1)
                for (let week = index * 4 + 1; week <= (index + 1) * 4 && week <= 52; week++) {
                    const weekRow = document.createElement('div');
                    weekRow.className = 'week-row';
                    weekRow.onclick = () => {
                        // Ouvrir modal pour assigner la semaine
                        openModal('assignModal');
                        document.getElementById('assignWeek').value = week;
                    };

                    const weekNumber = document.createElement('div');
                    weekNumber.className = 'week-number';
                    weekNumber.textContent = 'S' + week;
                    weekRow.appendChild(weekNumber);

                    const teamSpan = document.createElement('div');
                    teamSpan.className = 'week-team';
                    const weekKey = `${currentYear}-W${week}`;
                    if (assignments[weekKey]) {
                        const assign = assignments[weekKey];
                        teamSpan.textContent = `${assign.member1} + ${assign.member2}`;
                        weekRow.classList.add('assigned');
                    } else {
                        teamSpan.textContent = 'Non assign√©e';
                    }
                    weekRow.appendChild(teamSpan);

                    const status = document.createElement('div');
                    status.className = 'week-status';
                    const conflictForWeek = conflicts.find(c => c.week === week);
                    if (conflictForWeek) {
                        status.textContent = '‚ö†Ô∏è';
                        weekRow.classList.add('conflict');
                    }
                    weekRow.appendChild(status);

                    weeksContainer.appendChild(weekRow);
                }

                monthBlock.appendChild(weeksContainer);
                yearContainer.appendChild(monthBlock);
            });
        }

        function renderMonthlyCalendar(monthIndex) {
            const months = [
                'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
            ];
            const calendarYearDiv = document.getElementById('calendarYear');
            calendarYearDiv.style.display = 'none';
            const calendarMonthDiv = document.getElementById('calendarMonth');
            calendarMonthDiv.style.display = 'block';
            calendarMonthDiv.innerHTML = '';

            // Navigation
            const nav = document.createElement('div');
            nav.className = 'month-nav';

            const prevBtn = document.createElement('button');
            prevBtn.className = 'btn btn-info';
            prevBtn.textContent = '‚ü®';
            prevBtn.onclick = () => {
                const newIndex = monthIndex - 1 < 0 ? 11 : monthIndex - 1;
                renderMonthlyCalendar(newIndex);
            };
            nav.appendChild(prevBtn);

            const title = document.createElement('h2');
            title.textContent = months[monthIndex];
            nav.appendChild(title);

            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn btn-info';
            nextBtn.textContent = '‚ü©';
            nextBtn.onclick = () => {
                const newIndex = monthIndex + 1 > 11 ? 0 : monthIndex + 1;
                renderMonthlyCalendar(newIndex);
            };
            nav.appendChild(nextBtn);

            calendarMonthDiv.appendChild(nav);

            // Grille du mois
            const grid = document.createElement('div');
            grid.className = 'month-grid';

            // En-t√™tes des jours
            const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            dayNames.forEach(name => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = name;
                grid.appendChild(header);
            });

            // Premier jour du mois
            const firstDay = new Date(Date.UTC(currentYear, monthIndex, 1));
            const firstDow = (firstDay.getUTCDay() + 6) % 7; // lundi = 0

            // Nombre de jours dans ce mois
            const daysInMonth = new Date(Date.UTC(currentYear, monthIndex + 1, 0)).getUTCDate();

            // Affichage des cellules
            for (let i = 0; i < firstDow; i++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell other-month';
                grid.appendChild(cell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                cell.appendChild(dayNumber);

                const dateObj = new Date(Date.UTC(currentYear, monthIndex, day));
                const weekNum = getISOWeekNumber(dateObj);

                // Informations sur la semaine assign√©e (si l'utilisateur clique le 1er jour)
                const weekKey = `${currentYear}-W${weekNum}`;
                const info = document.createElement('div');
                info.className = 'day-info';
                if (assignments[weekKey]) {
                    const ass = assignments[weekKey];
                    info.textContent = `${ass.member1} & ${ass.member2}`;
                    cell.classList.add('has-assignment');
                } else {
                    info.textContent = 'Libre';
                }
                cell.appendChild(info);

                // Conflit ce jour ?
                const conflict = conflicts.find(c => {
                    const vacStart = new Date(c.conflictStart);
                    const vacEnd   = new Date(c.conflictEnd);
                    return datesOverlap(dateObj, dateObj, vacStart, vacEnd);
                });
                if (conflict) {
                    const indicator = document.createElement('div');
                    indicator.className = 'conflict-indicator';
                    indicator.textContent = '‚ö†Ô∏è';
                    cell.classList.add('has-conflict');
                    cell.appendChild(indicator);
                }

                cell.onclick = () => {
                    // Ouvrir le modal d'assignation avec la semaine correspondante
                    const mondayDate = getMondayOfWeek(weekNum, currentYear);
                    const isoWeek = getISOWeekNumber(mondayDate);
                    openModal('assignModal');
                    document.getElementById('assignWeek').value = isoWeek;
                };

                grid.appendChild(cell);
            }

            calendarMonthDiv.appendChild(grid);
        }

        function getISOWeekNumber(date) {
            const target = new Date(date.valueOf());
            const dayNr  = (date.getUTCDay() + 6) % 7;
            target.setUTCDate(target.getUTCDate() - dayNr + 3);
            const firstThursday = target.valueOf();
            target.setUTCMonth(0, 1);
            if (target.getUTCDay() !== 4) {
                target.setUTCMonth(0, 1 + ((4 - target.getUTCDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - target) / 604800000);
        }

        function getMondayOfWeek(week, year) {
            const simple = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
            const dow = simple.getUTCDay();
            const ISOweekStart = simple;
            if (dow <= 4) {
                ISOweekStart.setUTCDate(simple.getUTCDate() - dow + 1);
            } else {
                ISOweekStart.setUTCDate(simple.getUTCDate() + 8 - dow);
            }
            return ISOweekStart;
        }

        function saveData() {
            localStorage.setItem('planningAssignments', JSON.stringify(assignments));
            localStorage.setItem('planningVacations', JSON.stringify(vacations));
        }

        function loadData() {
            const storedAssignments = localStorage.getItem('planningAssignments');
            const storedVacations = localStorage.getItem('planningVacations');
            assignments = storedAssignments ? JSON.parse(storedAssignments) : {};
            vacations = storedVacations ? JSON.parse(storedVacations) : {};
        }
        loadData();
        detectConflicts();
        updateDisplay();

        // Affichage de la vue absences
        function renderAbsencesView() {
            const container = document.getElementById('absencesContainer');
            container.innerHTML = '';
            TEAM.forEach(member => {
                const card = document.createElement('div');
                card.className = 'member-card';
                const header = document.createElement('h4');
                header.textContent = member;
                card.appendChild(header);

                const absList = vacations[member] || [];
                if (absList.length === 0) {
                    const noAbs = document.createElement('p');
                    noAbs.textContent = 'Aucune absence';
                    card.appendChild(noAbs);
                } else {
                    absList.forEach(vac => {
                        const item = document.createElement('div');
                        item.className = 'absence-item';

                        const datesDiv = document.createElement('div');
                        datesDiv.className = 'absence-dates';
                        datesDiv.textContent = `${vac.start} au ${vac.end}`;
                        item.appendChild(datesDiv);

                        const durationDiv = document.createElement('div');
                        const start = new Date(vac.start);
                        const end = new Date(vac.end);
                        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                        durationDiv.className = 'absence-duration';
                        durationDiv.textContent = `${days} j`;
                        item.appendChild(durationDiv);

                        // Bouton supprimer
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Supprimer';
                        deleteBtn.className = 'btn btn-danger';
                        deleteBtn.onclick = () => {
                            deleteVacation(member, vac.start, vac.end);
                        };
                        item.appendChild(deleteBtn);

                        card.appendChild(item);
                    });
                }

                container.appendChild(card);
            });
        }

        // Affichage de la vue des conflits
        function renderConflictsView() {
            const container = document.getElementById('conflictsContainer');
            container.innerHTML = '';

            // Grouper les conflits par semaine
            const grouped = {};
            conflicts.forEach(conflict => {
                if (!grouped[conflict.week]) grouped[conflict.week] = [];
                grouped[conflict.week].push(conflict);
            });

            Object.keys(grouped).sort((a, b) => a - b).forEach(weekNum => {
                const weekConflicts = grouped[weekNum];

                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'conflict-details';

                const weekDates = getWeekDates(currentYear, parseInt(weekNum));
                const weekLabel = `Semaine ${weekNum} (${weekDates.start.toISOString().split('T')[0]} au ${weekDates.end.toISOString().split('T')[0]})`;
                const title = document.createElement('h3');
                title.textContent = weekLabel;
                detailsDiv.appendChild(title);

                const assign = assignments[`${currentYear}-W${weekNum}`];
                const assignText = assign ? `${assign.member1} + ${assign.member2} (Backup: ${assign.backup})` : 'Non assign√©e';
                const assignP = document.createElement('p');
                assignP.innerHTML = `<strong>√âquipe assign√©e¬†:</strong> ${assignText}`;
                detailsDiv.appendChild(assignP);

                // Tableau des membres en conflit
                const table = document.createElement('table');
                table.className = 'conflict-table';
                const thead = document.createElement('thead');
                const trHead = document.createElement('tr');
                ['Membre en conflit', 'R√¥le', 'P√©riode d\\'absence', 'Dur√©e'].forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    trHead.appendChild(th);
                });
                thead.appendChild(trHead);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                weekConflicts.forEach(conf => {
                    const tr = document.createElement('tr');
                    const tdMember = document.createElement('td');
                    tdMember.textContent = conf.member;
                    const tdRole = document.createElement('td');
                    tdRole.textContent = conf.role;
                    const tdPeriod = document.createElement('td');
                    tdPeriod.textContent = `${conf.conflictStart} - ${conf.conflictEnd}`;
                    const tdDays = document.createElement('td');
                    const start = new Date(conf.conflictStart);
                    const end = new Date(conf.conflictEnd);
                    const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    tdDays.textContent = days + ' j';
                    tr.appendChild(tdMember);
                    tr.appendChild(tdRole);
                    tr.appendChild(tdPeriod);
                    tr.appendChild(tdDays);
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                detailsDiv.appendChild(table);

                const buttonsDiv = document.createElement('div');
                buttonsDiv.style.marginTop = '10px';

                const resolveBtn = document.createElement('button');
                resolveBtn.className = 'btn btn-success';
                resolveBtn.textContent = 'R√©soudre ce conflit';
                resolveBtn.onclick = () => {
                    resolveConflict(parseInt(weekNum));
                };
                buttonsDiv.appendChild(resolveBtn);

                const modifyBtn = document.createElement('button');
                modifyBtn.className = 'btn btn-warning';
                modifyBtn.textContent = 'Modifier l\\'assignation';
                modifyBtn.onclick = () => {
                    openModal('assignModal');
                    document.getElementById('assignWeek').value = parseInt(weekNum);
                };
                buttonsDiv.appendChild(modifyBtn);

                detailsDiv.appendChild(buttonsDiv);
                container.appendChild(detailsDiv);
            });

            renderResolvedSolutions();
        }

        /**
         * Exportation des donn√©es du planning au format CSV.
         */
        function exportExcel() {
            let csvContent = 'Semaine;Date d√©but;Date fin;Membre 1;Membre 2;Backup\\n';
            for (let week = 1; week <= 52; week++) {
                const weekKey = `${currentYear}-W${week}`;
                const weekDates = getWeekDates(currentYear, week);
                const startStr = formatDateCSV(weekDates.start);
                const endStr = formatDateCSV(weekDates.end);
                const ass = assignments[weekKey];
                const m1 = ass ? ass.member1 : '';
                const m2 = ass ? ass.member2 : '';
                const bk = ass ? ass.backup  : '';
                csvContent += `${week};${startStr};${endStr};${m1};${m2};${bk}\\n`;
            }
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `planning-${currentYear}.csv`;
            link.click();
            showNotification('‚úÖ Fichier Excel export√©¬†!', 'success');
        }

        function formatDateCSV(dateObj) {
            return dateObj.toISOString().split('T')[0];
        }

        function formatDateICS(dateObj) {
            return dateObj.toISOString().split('T')[0].replace(/-/g, '');
        }

        /**
         * Exporte des fichiers .ics individuels par r√©f√©rent contenant toutes ses p√©riodes de piquet.
         */
        function exportAgendas() {
            // Cr√©er un fichier par membre
            TEAM.forEach(member => {
                let ics = 'BEGIN:VCALENDAR\\nVERSION:2.0\\nPRODID:-//Planning//FR\\n';
                Object.keys(assignments).forEach(key => {
                    if (!key.startsWith(`${currentYear}-W`)) return;
                    const [yr, w] = key.split('-W');
                    const week = parseInt(w);
                    const ass = assignments[key];
                    let role = null;
                    if (ass.member1 === member || ass.member2 === member) {
                        role = 'Principal';
                    } else if (ass.backup === member) {
                        role = 'Backup';
                    }
                    if (!role) return;
                    const { start, end } = getWeekDates(currentYear, week);
                    const dtStart = formatDateICS(start);
                    const dtEnd = formatDateICS(new Date(end.getFullYear(), end.getMonth(), end.getDate() + 1));
                    const uid = `${currentYear}-W${week}-${member.replace(/\\s+/g, '_')}@planning`;
                    const stamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                    ics += 'BEGIN:VEVENT\\n';
                    ics += `UID:${uid}\\n`;
                    ics += `DTSTAMP:${stamp}\\n`;
                    ics += `DTSTART;VALUE=DATE:${dtStart}\\n`;
                    ics += `DTEND;VALUE=DATE:${dtEnd}\\n`;
                    ics += `SUMMARY:P√©riode de piquet semaine ${week}\\n`;
                    ics += `DESCRIPTION:Semaine ${week}: ${ass.member1} + ${ass.member2} (Backup: ${ass.backup})\\nR√¥le: ${role}\\n`;
                    ics += 'END:VEVENT\\n';
                });
                ics += 'END:VCALENDAR';
                const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `agenda-${member.replace(/\\s+/g, '_')}-${currentYear}.ics`;
                link.click();
            });
            showNotification('üìÖ Fichiers Agenda export√©s¬†!', 'success');
        }

        /**
         * Supprime une p√©riode d'absence pour un membre donn√©.
         * @param {string} member
         * @param {string} start
         * @param {string} end
         */
        function deleteVacation(member, start, end) {
            if (!vacations[member]) return;
            if (!confirm('Supprimer cette absence¬†?')) return;
            vacations[member] = vacations[member].filter(v => !(v.start === start && v.end === end));
            saveData();
            detectConflicts();
            updateDisplay();
            if (document.getElementById('absencesTab').classList.contains('active')) {
                renderAbsencesView();
            }
            showNotification('üìÖ Absence supprim√©e', 'success');
        }

        /**
         * G√©n√®re artificiellement des conflits de test en cr√©ant des absences sur les premi√®res semaines.
         */
        function generateTestConflicts() {
            const weeksToTest = 3;
            for (let week = 1; week <= weeksToTest; week++) {
                const weekKey = `${currentYear}-W${week}`;
                const ass = assignments[weekKey];
                if (!ass) continue;
                const weekDates = getWeekDates(currentYear, week);
                [ass.member1, ass.member2, ass.backup].forEach(member => {
                    if (!vacations[member]) vacations[member] = [];
                    const startStr = weekDates.start.toISOString().split('T')[0];
                    const endStr = weekDates.end.toISOString().split('T')[0];
                    if (!vacations[member].some(v => v.start === startStr && v.end === endStr)) {
                        vacations[member].push({ start: startStr, end: endStr });
                    }
                });
            }
            saveData();
            detectConflicts();
            updateDisplay();
            if (document.getElementById('absencesTab').classList.contains('active')) {
                renderAbsencesView();
            }
            if (document.getElementById('conflictsTab').classList.contains('active')) {
                renderConflictsView();
            }
            showNotification('‚ö†Ô∏è Conflits de test g√©n√©r√©s', 'warning');
        }

        function updateStats() {
            const totalWeeks = 52;
            const assignedWeeks = Object.keys(assignments).filter(key =>
                key.startsWith(`${currentYear}-W`)
            ).length;

            const totalAbsences = Object.values(vacations).reduce((sum, v) => sum + v.length, 0);
            const conflictCount = [...new Set(conflicts.map(c => c.week))].length;
            const progress = Math.round((assignedWeeks / totalWeeks) * 100);

            document.getElementById('weeksAssigned').textContent = assignedWeeks;
            document.getElementById('totalAbsences').textContent = totalAbsences;
            document.getElementById('conflictsCount').textContent = conflictCount;
            document.getElementById('progressPercent').textContent = progress + '%';

            // Colorer les stats
            document.querySelectorAll('.stat-box').forEach(box => {
                box.classList.remove('good', 'warning', 'danger');
            });

            // Exemple simple : si toutes les semaines sont assign√©es, c'est bon
            if (assignedWeeks === totalWeeks) {
                document.querySelectorAll('.stat-box')[0].classList.add('good');
            } else if (assignedWeeks > totalWeeks * 0.75) {
                document.querySelectorAll('.stat-box')[0].classList.add('warning');
            } else {
                document.querySelectorAll('.stat-box')[0].classList.add('danger');
            }

            // Mise en √©vidence du nombre de conflits
            if (conflictCount > 0) {
                document.querySelectorAll('.stat-box')[2].classList.add('danger');
            } else {
                document.querySelectorAll('.stat-box')[2].classList.add('good');
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Affichage des solutions de conflits r√©solus
        function renderResolvedSolutions() {
            const container = document.getElementById('resolvedSolutionsContainer');
            container.innerHTML = '';
            if (!resolvedSolutions || resolvedSolutions.length === 0) {
                return;
            }
            const heading = document.createElement('h3');
            heading.style.margin = '30px 0 10px 0';
            heading.textContent = 'üìù Solutions de r√©solution des conflits';
            container.appendChild(heading);

            resolvedSolutions.forEach(sol => {
                const solDiv = document.createElement('div');
                solDiv.style.background = '#f0f8ff';
                solDiv.style.border = '1px solid #bcdff1';
                solDiv.style.padding = '10px';
                solDiv.style.marginBottom = '10px';
                solDiv.style.borderRadius = '6px';

                const proposals = sol.proposals.length > 0 ?
                    sol.proposals.map(m => `<span style="margin-right:8px;">${m}</span>`).join('') :
                    '<em>Aucune proposition disponible</em>';

                const chosen = sol.chosen ?
                    `${sol.chosen.member1} + ${sol.chosen.member2} (Backup: ${sol.chosen.backup})` :
                    '<em>Pas de solution choisie</em>';

                solDiv.innerHTML = `
                    <strong>Semaine ${sol.week}</strong><br>
                    <strong>Propositions:</strong> ${proposals}<br>
                    <strong>Choix:</strong> ${chosen}
                `;
                container.appendChild(solDiv);
            });
        }

        // G√©n√©ration de la vue du tableau de bord
        function renderDashboardView() {
            const container = document.getElementById('dashboardContainer');
            container.innerHTML = '';

            // Construction du tableau
            let html = '<table class="dashboard-table"><thead><tr>';
            html += '<th>R√©f√©rent</th>';
            html += '<th>Semaine(s) principale(s)</th>';
            html += '<th>Semaine(s) backup</th>';
            html += '<th>P√©riodes d\\'absence</th>';
            html += '<th>Jours d\\'absence</th>';
            html += '<th>Charge (%)</th>';
            html += '</tr></thead><tbody>';

            TEAM.forEach(member => {
                // Nombre de semaines o√π le r√©f√©rent est membre principal (member1 ou member2)
                let principalCount = 0;
                let backupCount = 0;
                Object.entries(assignments).forEach(([weekKey, assign]) => {
                    if (weekKey.startsWith(`${currentYear}-W`)) {
                        if (assign.member1 === member || assign.member2 === member) principalCount++;
                        if (assign.backup === member) backupCount++;
                    }
                });

                // P√©riodes d'absence et jours d'absence
                const periods = vacations[member] ? vacations[member].length : 0;
                let daysAbsent = 0;
                if (vacations[member]) {
                    vacations[member].forEach(vac => {
                        const start = new Date(vac.start);
                        const end = new Date(vac.end);
                        daysAbsent += Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    });
                }

                // Charge : on consid√®re 1 point par assignation principale et 0.5 par backup
                const loadPoints = principalCount + backupCount * 0.5;
                const maxLoad = 52; // max 52 semaines
                const chargePercent = ((loadPoints / maxLoad) * 100).toFixed(1);

                html += `<tr>
                    <td style="font-weight:bold;">${member}</td>
                    <td>${principalCount}</td>
                    <td>${backupCount}</td>
                    <td>${periods}</td>
                    <td>${daysAbsent}</td>
                    <td>${chargePercent}%</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Fermer les modals en cliquant dehors
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>
