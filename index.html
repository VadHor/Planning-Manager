<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Manager Pro - Gestion Complète</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 32px;
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 20px;
            font-weight: bold;
        }

        .year-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .year-btn:hover {
            background: white;
            color: #764ba2;
        }

        .toolbar {
            background: #2c3e50;
            padding: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-success { background: #27ae60; color: white; }
        .btn-primary { background: #3498db; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-dark { background: #34495e; color: white; }
        .btn-danger { background: #e74c3c; color: white; }

        /* Layout principal avec sidebar pour drag and drop */
        .main-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: 800px;
        }

        /* Sidebar avec les équipes disponibles */
        .teams-sidebar {
            background: #f8f9fa;
            border-right: 2px solid #ecf0f1;
            padding: 20px;
            overflow-y: auto;
        }

        .teams-sidebar h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .drag-instructions {
            background: #e8f4fd;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .drag-instructions h4 {
            color: #2980b9;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .drag-instructions p {
            color: #34495e;
            margin: 0;
            font-size: 12px;
        }

        .team-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #ecf0f1;
            cursor: grab;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .team-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border-color: #3498db;
        }

        .team-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            cursor: grabbing;
            z-index: 1000;
        }

        .team-pair {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .team-member {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .team-backup {
            background: #f39c12;
            color: white;
            padding: 3px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
        }

        .tabs-container {
            padding: 30px;
        }

        .tabs-nav {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #27ae60;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .calendar-year {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .month-block {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .month-header {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .weeks-container {
            padding: 10px;
        }

        .week-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 8px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
            min-height: 60px;
            border: 2px solid transparent;
        }

        .week-row:hover {
            background: #f8f9fa;
        }

        .week-row.assigned {
            background: #e8f5e9;
            border-left: 4px solid #27ae60;
        }

        .week-row.conflict {
            background: #ffebee;
            border-left: 4px solid #e74c3c;
            font-weight: bold;
        }

        /* Styles pour le drag and drop */
        .week-row.drag-over {
            background: #e3f2fd !important;
            border: 2px dashed #2196f3 !important;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        .week-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
        }

        .week-number {
            font-weight: bold;
            font-size: 12px;
            color: #2c3e50;
        }

        .week-assignment {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .assignment-team {
            display: flex;
            gap: 3px;
            align-items: center;
            flex-wrap: wrap;
        }

        .assignment-member {
            background: #3498db;
            color: white;
            padding: 2px 5px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: bold;
        }

        .assignment-backup {
            background: #f39c12;
            color: white;
            padding: 2px 5px;
            border-radius: 8px;
            font-size: 9px;
        }

        .week-actions {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .week-edit-btn, .week-delete-btn {
            padding: 3px 6px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
        }

        .week-edit-btn {
            background: #3498db;
            color: white;
        }

        .week-delete-btn {
            background: #e74c3c;
            color: white;
        }

        .week-edit-btn:hover, .week-delete-btn:hover {
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: 15px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 20px 30px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 2000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
        .notification.warning { background: #f39c12; }
        .notification.info { background: #3498db; }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .partnership-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .partnership-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
        }

        .heatmap-grid {
            display: grid;
            gap: 2px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
        }

        .heatmap-cell {
            padding: 8px;
            text-align: center;
            font-weight: bold;
            color: white;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* Style responsive pour mobile */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .teams-sidebar {
                border-right: none;
                border-bottom: 2px solid #ecf0f1;
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📊 Planning Manager Pro</h1>
            <div class="year-selector">
                <button class="year-btn" onclick="changeYear(-1)">◀</button>
                <span id="currentYear">2025</span>
                <button class="year-btn" onclick="changeYear(1)">▶</button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <button class="btn btn-success" onclick="autoFillWithBalance()">⚡ Remplissage Intelligent</button>
            <button class="btn btn-success" onclick="fillWithPredefinedPairs()">🎯 Remplir avec Binômes</button>
            <button class="btn btn-primary" onclick="showAssignModal()">➕ Assigner Semaine</button>
            <button class="btn btn-warning" onclick="showVacationModal()">🏖️ Ajouter Absence</button>
            <button class="btn btn-info" onclick="exportAll()">💾 Export JSON</button>
            <button class="btn btn-success" onclick="showImportModal()">📂 Import JSON</button>
            <button class="btn btn-info" onclick="exportCalendars()">📅 Export Calendriers</button>
            <button class="btn btn-dark" onclick="showTeamEditModal()">👥 Éditer Équipe</button>
            <button class="btn btn-info" onclick="showPartnershipAnalysis()">📊 Analyser Binômes</button>
            <button class="btn btn-danger" onclick="confirmReboot()">🔄 REBOOT</button>
        </div>

        <!-- Layout principal avec sidebar pour drag and drop -->
        <div class="main-layout">
            <!-- Sidebar avec les équipes disponibles -->
            <div class="teams-sidebar">
                <h3>🎯 Équipes Disponibles</h3>
                
                <div class="drag-instructions">
                    <h4>💡 Drag & Drop</h4>
                    <p>Glissez une équipe sur une semaine pour l'assigner instantanément !</p>
                </div>
                
                <div id="teamsAvailable">
                    <!-- Généré dynamiquement -->
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px; font-size: 12px; padding: 8px;" onclick="generateRandomTeams()">
                    🎲 Générer Équipes
                </button>
            </div>

            <!-- Contenu principal avec onglets -->
            <div class="tabs-container">
                <!-- Tabs Navigation -->
                <div class="tabs-nav">
                    <button class="tab-btn active" onclick="switchTab('planning')">📅 Planning</button>
                    <button class="tab-btn" onclick="switchTab('absences')">🏖️ Absences</button>
                    <button class="tab-btn" onclick="switchTab('conflicts')">⚠️ Conflits</button>
                    <button class="tab-btn" onclick="switchTab('team')">👥 Équipe</button>
                    <button class="tab-btn" onclick="switchTab('binomes')">🎯 Config Binômes</button>
                    <button class="tab-btn" onclick="switchTab('partnerships')">🤝 Analyse Binômes</button>
                </div>

                <!-- Planning Tab -->
                <div id="planningTab" class="tab-content active">
                    <div class="stats-bar">
                        <div class="stat-box">
                            <div class="stat-number" id="weeksAssigned">0</div>
                            <div class="stat-label">Semaines Assignées</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="totalAbsences">0</div>
                            <div class="stat-label">Périodes d'Absence</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="conflictsCount">0</div>
                            <div class="stat-label">Conflits Actifs</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="progressPercent">0%</div>
                            <div class="stat-label">Progression</div>
                        </div>
                    </div>
                    <div class="calendar-year" id="yearView"></div>
                </div>

                <!-- Absences Tab -->
                <div id="absencesTab" class="tab-content">
                    <h2 style="margin-bottom: 20px;">Gestion des Absences</h2>
                    <div id="absencesContainer"></div>
                </div>

                <!-- Conflicts Tab -->
                <div id="conflictsTab" class="tab-content">
                    <h2 style="margin-bottom: 20px;">Centre de Résolution des Conflits</h2>
                    <div id="conflictList"></div>
                </div>

                <!-- Team Tab -->
                <div id="teamTab" class="tab-content">
                    <h2 style="margin-bottom: 20px;">Tableau de l'Équipe</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Référent</th>
                                <th>Semaines Principal</th>
                                <th>Semaines Backup</th>
                                <th>Jours Absence</th>
                                <th>Charge (%)</th>
                            </tr>
                        </thead>
                        <tbody id="teamTableBody"></tbody>
                    </table>
                </div>

                <!-- Config Binômes Tab -->
                <div id="binomesTab" class="tab-content">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">🎯 Configuration des Binômes Prédéfinis</h2>
                    
                    <div style="background: #e8f5e9; border: 2px solid #27ae60; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                        <h4 style="color: #27ae60; margin-bottom: 10px;">💡 Comment ça fonctionne ?</h4>
                        <p style="color: #2c3e50; margin: 0;">
                            Définissez vos binômes préférés ci-dessous, puis utilisez le bouton <strong>"🎯 Remplir avec Binômes"</strong> 
                            dans la barre d'outils. L'algorithme fera tourner intelligemment vos binômes sur l'année entière 
                            en évitant les répétitions et en équilibrant les charges.
                        </p>
                    </div>

                    <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #2c3e50; margin: 0;">📝 Vos Binômes Prédéfinis</h3>
                            <button class="btn btn-primary" onclick="addPredefinedPair()">+ Ajouter un Binôme</button>
                        </div>
                        
                        <div id="predefinedPairsList" style="display: grid; gap: 15px;">
                            <!-- Généré dynamiquement -->
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ecf0f1;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button class="btn btn-warning" onclick="resetPredefinedPairs()">🔄 Binômes par Défaut</button>
                                <button class="btn btn-success" onclick="savePredefinedPairs()">✅ Sauvegarder Configuration</button>
                            </div>
                        </div>
                    </div>

                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin-top: 30px;">
                        <h4 style="color: #856404; margin-bottom: 15px;">⚙️ Conseils d'optimisation</h4>
                        <ul style="color: #856404; margin: 0; padding-left: 20px;">
                            <li><strong>Équilibre :</strong> Essayez de créer des binômes avec des niveaux d'expérience complémentaires</li>
                            <li><strong>Diversité :</strong> L'algorithme fera tourner vos binômes automatiquement</li>
                            <li><strong>Backup :</strong> Les backups seront assignés automatiquement parmi les membres libres</li>
                            <li><strong>Flexibilité :</strong> Vous pouvez toujours modifier manuellement après le remplissage</li>
                        </ul>
                    </div>
                </div>

                <!-- Partnership Analysis Tab -->
                <div id="partnershipsTab" class="tab-content">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">🤝 Analyse des Binômes</h2>
                    
                    <div class="stats-bar">
                        <div class="stat-box">
                            <div class="stat-number" id="totalPartnerships">0</div>
                            <div class="stat-label">Binômes Différents</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="maxPartnership">0</div>
                            <div class="stat-label">Partenariat Max</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="diversityScore">0%</div>
                            <div class="stat-label">Score Diversité</div>
                        </div>
                    </div>

                    <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 15px; color: #2c3e50;">🔥 Matrice de Collaboration</h3>
                        <p style="color: #666; margin-bottom: 15px;">
                            Cette matrice montre le nombre de fois où chaque paire de référents a travaillé ensemble.
                        </p>
                        <div id="collaborationHeatmap"></div>
                    </div>

                    <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">📋 Détail des Partenariats</h3>
                        <div id="partnershipDetails"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tous vos modals existants -->
    <div class="modal" id="assignModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assignModal')">&times;</span>
            <h2>📅 Assigner une Semaine</h2>
            <form onsubmit="saveAssignment(event)">
                <div class="form-group">
                    <label>Semaine</label>
                    <input type="week" id="weekInput" required>
                </div>
                <div class="form-group">
                    <label>Binôme</label>
                    <div class="form-row">
                        <select id="member1" required>
                            <option value="">Membre 1</option>
                        </select>
                        <select id="member2" required>
                            <option value="">Membre 2</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Backup</label>
                    <select id="backup" required>
                        <option value="">Sélectionner</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Enregistrer</button>
            </form>
        </div>
    </div>

    <div class="modal" id="vacationModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('vacationModal')">&times;</span>
            <h2>🏖️ Ajouter une Absence</h2>
            <form onsubmit="saveVacation(event)">
                <div class="form-group">
                    <label>Référent</label>
                    <select id="vacationMember" required>
                        <option value="">Sélectionner</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date de début</label>
                    <input type="date" id="vacationStart" required>
                </div>
                <div class="form-group">
                    <label>Date de fin</label>
                    <input type="date" id="vacationEnd" required>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Enregistrer</button>
            </form>
        </div>
    </div>

    <div class="modal" id="teamEditModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('teamEditModal')">&times;</span>
            <h2>👥 Éditer les Noms des Référents</h2>
            <form onsubmit="saveTeamNames(event)">
                <div id="teamEditList" style="display: grid; gap: 10px;"></div>
                <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button type="button" class="btn btn-warning" onclick="resetTeamNames()">🔄 Réinitialiser</button>
                    <button type="submit" class="btn btn-success">✅ Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="importModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('importModal')">&times;</span>
            <h2>📂 Importer des Données JSON</h2>
            
            <div style="background: #e8f5e9; border: 2px solid #27ae60; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h4 style="color: #27ae60; margin-bottom: 10px;">💡 Instructions</h4>
                <ul style="color: #2c3e50; margin: 0; padding-left: 20px;">
                    <li>Sélectionnez un fichier JSON exporté précédemment</li>
                    <li>Toutes les données actuelles seront remplacées</li>
                    <li>Une sauvegarde automatique sera créée avant l'import</li>
                </ul>
            </div>
            
            <form onsubmit="importData(event)">
                <div class="form-group">
                    <label>Fichier JSON</label>
                    <input type="file" id="jsonFileInput" accept=".json" required
                           style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px;">
                </div>
                
                <div id="importPreview" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">📋 Aperçu des données</h4>
                    <div id="importSummary"></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-warning" onclick="createBackup()">💾 Créer Sauvegarde</button>
                    <button type="submit" class="btn btn-success" id="importBtn" disabled>📂 Importer</button>
                </div>
            </form>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Variables globales (toutes vos variables existantes)
        let TEAM = ['Référent 1', 'Référent 2', 'Référent 3', 'Référent 4', 'Référent 5', 'Référent 6', 'Référent 7', 'Référent 8', 'Référent 9'];
        let currentYear = 2025;
        let assignments = {};
        let vacations = {};
        let conflicts = [];
        let predefinedPairs = [];

        // Variables pour le drag and drop
        let draggedTeam = null;

        // Fonction pour calculer le numéro de semaine ISO d'une date
        function getISOWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // Fonction pour obtenir toutes les semaines d'un mois donné
        function getWeeksInMonth(year, month) {
            const weeks = [];
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Trouver le premier lundi du mois (ou le lundi de la semaine qui contient le 1er)
            let currentDate = new Date(firstDay);
            
            // Reculer au lundi de la semaine qui contient le 1er du mois
            while (currentDate.getDay() !== 1) {
                currentDate.setDate(currentDate.getDate() - 1);
            }
            
            // Collecter toutes les semaines qui touchent ce mois
            while (currentDate <= lastDay || (currentDate.getMonth() === month && currentDate.getDate() <= 7)) {
                const weekNum = getISOWeekNumber(currentDate);
                
                // Vérifier si cette semaine touche le mois en cours
                const weekStart = new Date(currentDate);
                const weekEnd = new Date(currentDate);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                if ((weekStart.getMonth() === month || weekEnd.getMonth() === month) ||
                    (weekStart < firstDay && weekEnd >= firstDay) ||
                    (weekStart <= lastDay && weekEnd > lastDay)) {
                    
                    if (!weeks.includes(weekNum) && weekNum >= 1 && weekNum <= 53) {
                        weeks.push(weekNum);
                    }
                }
                
                currentDate.setDate(currentDate.getDate() + 7);
            }
            
            return weeks.sort((a, b) => a - b);
        }

        // Fonction pour obtenir les dates de début et fin d'une semaine
        function getWeekDates(year, weekNum) {
            const jan4 = new Date(year, 0, 4);
            const jan4Day = jan4.getDay() || 7;
            const firstMonday = new Date(jan4);
            firstMonday.setDate(jan4.getDate() - jan4Day + 1);
            
            const weekStart = new Date(firstMonday);
            weekStart.setDate(firstMonday.getDate() + (weekNum - 1) * 7);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            return { start: weekStart, end: weekEnd };
        }

        // ===== NOUVELLES FONCTIONS DRAG AND DROP =====
        
        function generateRandomTeams() {
            const availableTeams = document.getElementById('teamsAvailable');
            availableTeams.innerHTML = '';
            
            // Générer 5 équipes aléatoires
            for (let i = 0; i < 5; i++) {
                const shuffledTeam = [...TEAM].sort(() => Math.random() - 0.5);
                const member1 = shuffledTeam[0];
                const member2 = shuffledTeam[1];
                const backup = shuffledTeam[2];
                
                const teamCard = createTeamCard(member1, member2, backup, i);
                availableTeams.appendChild(teamCard);
            }
        }

        function createTeamCard(member1, member2, backup, index) {
            const card = document.createElement('div');
            card.className = 'team-card';
            card.draggable = true;
            card.dataset.member1 = member1;
            card.dataset.member2 = member2;
            card.dataset.backup = backup;
            
            card.innerHTML = `
                <div class="team-pair">
                    <span class="team-member">${member1}</span>
                    <span>+</span>
                    <span class="team-member">${member2}</span>
                </div>
                <div style="text-align: center; margin-top: 8px;">
                    <span class="team-backup">Backup: ${backup}</span>
                </div>
            `;
            
            // Événements drag and drop
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            
            return card;
        }

        function handleDragStart(e) {
            this.classList.add('dragging');
            draggedTeam = {
                member1: this.dataset.member1,
                member2: this.dataset.member2,
                backup: this.dataset.backup
            };
            
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedTeam = null;
        }

        function setupWeekDropZones() {
            const weekRows = document.querySelectorAll('.week-row');
            
            weekRows.forEach(weekRow => {
                weekRow.addEventListener('dragover', handleDragOver);
                weekRow.addEventListener('dragenter', handleDragEnter);
                weekRow.addEventListener('dragleave', handleDragLeave);
                weekRow.addEventListener('drop', handleDrop);
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (draggedTeam) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            // Vérifier si on quitte vraiment l'élément (pas juste un enfant)
            if (!this.contains(e.relatedTarget)) {
                this.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (!draggedTeam) return;
            
            const weekNumber = this.dataset.week;
            if (!weekNumber) return;
            
            const weekKey = `${currentYear}-W${weekNumber.toString().padStart(2, '0')}`;
            
            // Vérifier les conflits potentiels
            const member1 = draggedTeam.member1;
            const member2 = draggedTeam.member2;
            const backup = draggedTeam.backup;
            
            if (member1 === member2 || member1 === backup || member2 === backup) {
                showNotification('❌ Les membres doivent être différents', 'error');
                return;
            }
            
            // Vérifier les conflits de vacances avant d'assigner
            const weekDates = getWeekDates(currentYear, parseInt(weekNumber));
            const membersToCheck = [member1, member2, backup];
            const vacationConflicts = [];
            
            membersToCheck.forEach(member => {
                const memberVacations = vacations[member] || [];
                memberVacations.forEach(vacation => {
                    const vacationStart = new Date(vacation.start);
                    const vacationEnd = new Date(vacation.end);
                    
                    if (isDateOverlap(weekDates.start, weekDates.end, vacationStart, vacationEnd)) {
                        const role = member === backup ? 'Backup' : 'Référent Principal';
                        vacationConflicts.push({
                            member: member,
                            role: role,
                            vacation: vacation
                        });
                    }
                });
            });
            
            // Alerter l'utilisateur s'il y a des conflits de vacances
            if (vacationConflicts.length > 0) {
                let conflictMessage = `⚠️ ATTENTION - Conflits détectés pour la semaine ${weekNumber}:\n\n`;
                vacationConflicts.forEach(conflict => {
                    conflictMessage += `• ${conflict.member} (${conflict.role}) est en vacances du ${formatDateCH(conflict.vacation.start)} au ${formatDateCH(conflict.vacation.end)}\n`;
                });
                conflictMessage += '\nVoulez-vous quand même assigner cette équipe ?';
                
                if (!confirm(conflictMessage)) {
                    showNotification('❌ Assignation annulée en raison des conflits', 'warning');
                    return;
                }
            }
            
            // Assigner l'équipe à cette semaine
            assignments[weekKey] = {
                member1: member1,
                member2: member2,
                backup: backup
            };
            
            saveData();
            updateAllDisplays();
            
            if (vacationConflicts.length > 0) {
                showNotification(`⚠️ Équipe assignée avec ${vacationConflicts.length} conflit(s) - Vérifiez l'onglet Conflits`, 'warning');
            } else {
                showNotification(`✅ Équipe assignée à la semaine ${weekNumber}`, 'success');
            }
        }

        // ===== FIN DRAG AND DROP =====

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application initialisée avec drag and drop et détection de conflits');
            loadData();
            populateSelects();
            updateAllDisplays();
            generateRandomTeams();
            
            // Ajouter l'événement pour l'input file
            const fileInput = document.getElementById('jsonFileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            // Test de la détection de conflits au démarrage
            console.log('Test détection conflits:', conflicts.length);
        });

        // Toutes vos fonctions existantes (je les garde intactes)
        
        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
            document.getElementById('jsonFileInput').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importBtn').disabled = true;
        }

        function createBackup() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const backupData = {
                version: '3.1-backup',
                backupDate: new Date().toISOString(),
                year: currentYear,
                assignments: assignments,
                vacations: vacations,
                teamNames: TEAM,
                predefinedPairs: predefinedPairs
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_planning_${timestamp}.json`;
            link.click();
            
            showNotification('💾 Sauvegarde créée avec succès', 'success');
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('importPreview').style.display = 'none';
                document.getElementById('importBtn').disabled = true;
                return;
            }
            
            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                showNotification('❌ Veuillez sélectionner un fichier JSON valide', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    validateAndPreviewImport(data);
                } catch (error) {
                    showNotification('❌ Fichier JSON invalide: ' + error.message, 'error');
                    document.getElementById('importPreview').style.display = 'none';
                    document.getElementById('importBtn').disabled = true;
                }
            };
            reader.readAsText(file);
        }

        function validateAndPreviewImport(data) {
            const preview = document.getElementById('importPreview');
            const summary = document.getElementById('importSummary');
            const importBtn = document.getElementById('importBtn');
            
            // Validation basique
            if (!data || typeof data !== 'object') {
                showNotification('❌ Structure de données invalide', 'error');
                preview.style.display = 'none';
                importBtn.disabled = true;
                return;
            }
            
            // Extraire les informations
            const year = data.year || 'Non spécifiée';
            const teamNames = data.teamNames || [];
            const assignmentsCount = Object.keys(data.assignments || {}).length;
            const vacationsCount = Object.values(data.vacations || {}).reduce((sum, v) => sum + v.length, 0);
            const predefinedPairsCount = (data.predefinedPairs || []).length;
            const exportDate = data.exportDate || data.lastModified || 'Inconnue';
            
            // Afficher l'aperçu
            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong>📅 Année:</strong> ${year}<br>
                        <strong>👥 Équipe:</strong> ${teamNames.length} membres<br>
                        <strong>📝 Assignations:</strong> ${assignmentsCount} semaines
                    </div>
                    <div>
                        <strong>🏖️ Absences:</strong> ${vacationsCount} périodes<br>
                        <strong>🎯 Binômes:</strong> ${predefinedPairsCount} prédéfinis<br>
                        <strong>📊 Export:</strong> ${new Date(exportDate).toLocaleDateString('de-CH')}
                    </div>
                </div>
                
                ${teamNames.length > 0 ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <strong>👥 Membres de l'équipe:</strong><br>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                            ${teamNames.map(name => `<span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">${name}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            
            preview.style.display = 'block';
            importBtn.disabled = false;
            
            // Stocker les données pour l'import
            window.pendingImportData = data;
        }

        function importData(event) {
            event.preventDefault();
            
            if (!window.pendingImportData) {
                showNotification('❌ Aucune donnée à importer', 'error');
                return;
            }
            
            if (!confirm('⚠️ ATTENTION: Cette action remplacera toutes les données actuelles.\n\nContinuer l\'import?')) {
                return;
            }
            
            const data = window.pendingImportData;
            
            try {
                // Importer les données
                if (data.teamNames && Array.isArray(data.teamNames)) {
                    TEAM = data.teamNames;
                }
                
                if (data.year) {
                    currentYear = data.year;
                    document.getElementById('currentYear').textContent = currentYear;
                }
                
                assignments = data.assignments || {};
                vacations = data.vacations || {};
                predefinedPairs = data.predefinedPairs || [];
                
                // Sauvegarder et mettre à jour
                saveData();
                populateSelects();
                updateAllDisplays();
                generateRandomTeams(); // Regénérer les équipes dans la sidebar
                
                closeModal('importModal');
                
                // Afficher un rapport d'import
                const assignmentsCount = Object.keys(assignments).length;
                const vacationsCount = Object.values(vacations).reduce((sum, v) => sum + v.length, 0);
                
                showNotification('✅ Import réussi !', 'success');
                
                setTimeout(() => {
                    alert(`📂 Import terminé avec succès !\n\n` +
                          `📅 Année: ${currentYear}\n` +
                          `👥 Équipe: ${TEAM.length} membres\n` +
                          `📝 Assignations: ${assignmentsCount} semaines\n` +
                          `🏖️ Absences: ${vacationsCount} périodes\n` +
                          `🎯 Binômes: ${predefinedPairs.length} prédéfinis`);
                }, 1000);
                
            } catch (error) {
                console.error('Erreur lors de l\'import:', error);
                showNotification('❌ Erreur lors de l\'import: ' + error.message, 'error');
            }
        }

        // Gestion des données
        function loadData() {
            const saved = localStorage.getItem('planningData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.teamNames) TEAM = data.teamNames;
                    assignments = data.assignments || {};
                    vacations = data.vacations || {};
                    predefinedPairs = data.predefinedPairs || [];
                    currentYear = data.year || currentYear;
                    console.log('Données chargées:', data);
                } catch (e) {
                    console.error('Erreur chargement:', e);
                }
            }
            document.getElementById('currentYear').textContent = currentYear;
        }

        function saveData() {
            const data = {
                year: currentYear,
                assignments: assignments,
                vacations: vacations,
                teamNames: TEAM,
                predefinedPairs: predefinedPairs,
                lastModified: new Date().toISOString()
            };
            localStorage.setItem('planningData', JSON.stringify(data));
            console.log('Données sauvegardées');
        }

        // Gestion des onglets
        function switchTab(tabName) {
            console.log('Changement onglet:', tabName);
            
            // Désactiver tous les onglets
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activer l'onglet sélectionné
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Mettre à jour le contenu si nécessaire
            if (tabName === 'partnerships') {
                updatePartnershipAnalysis();
            } else if (tabName === 'binomes') {
                updatePredefinedPairsList();
            }
        }

        // Mise à jour des affichages
        function updateAllDisplays() {
            updateStats();
            updateYearView();
            updateAbsencesView();
            updateTeamTable();
            updateConflictDisplay();
            detectConflicts();
        }

        function updateStats() {
            const totalWeeks = 52;
            const assignedWeeks = Object.keys(assignments).filter(key => key.startsWith(`${currentYear}-W`)).length;
            const totalAbsences = Object.values(vacations).reduce((sum, v) => sum + v.length, 0);
            const conflictCount = conflicts.length;
            const progress = Math.round((assignedWeeks / totalWeeks) * 100);
            
            document.getElementById('weeksAssigned').textContent = assignedWeeks;
            document.getElementById('totalAbsences').textContent = totalAbsences;
            document.getElementById('conflictsCount').textContent = conflictCount;
            document.getElementById('progressPercent').textContent = progress + '%';
        }

        function calculateWorkloads() {
            const workloads = {};
            TEAM.forEach(member => {
                workloads[member] = { principal: 0, backup: 0, total: 0 };
            });
            
            Object.values(assignments).forEach(assignment => {
                if (workloads[assignment.member1]) workloads[assignment.member1].principal++;
                if (workloads[assignment.member2]) workloads[assignment.member2].principal++;
                if (workloads[assignment.backup]) workloads[assignment.backup].backup++;
            });
            
            Object.keys(workloads).forEach(member => {
                workloads[member].total = workloads[member].principal + (workloads[member].backup * 0.5);
            });
            
            return workloads;
        }

        function detectConflicts() {
            conflicts = [];
            
            console.log('=== DÉTECTION DES CONFLITS ===');
            console.log('Assignations à vérifier:', Object.keys(assignments).length);
            console.log('Vacances à vérifier:', Object.keys(vacations).length);
            
            // Parcourir toutes les assignations pour détecter les conflits
            Object.entries(assignments).forEach(([weekKey, assignment]) => {
                if (!weekKey.startsWith(`${currentYear}-W`)) return;
                
                const weekNum = parseInt(weekKey.split('-W')[1]);
                const weekDates = getWeekDates(currentYear, weekNum);
                
                console.log(`Vérification semaine ${weekNum}:`, weekDates);
                console.log(`Équipe assignée: ${assignment.member1} + ${assignment.member2}, Backup: ${assignment.backup}`);
                
                // Vérifier les conflits de vacances pour chaque membre de l'équipe
                [assignment.member1, assignment.member2, assignment.backup].forEach(member => {
                    if (!member) return;
                    
                    const memberVacations = vacations[member] || [];
                    console.log(`Vacances de ${member}:`, memberVacations);
                    
                    memberVacations.forEach(vacation => {
                        const vacationStart = new Date(vacation.start);
                        const vacationEnd = new Date(vacation.end);
                        
                        console.log(`Test conflit: Semaine ${weekNum} (${weekDates.start.toDateString()} - ${weekDates.end.toDateString()}) vs Vacances ${member} (${vacationStart.toDateString()} - ${vacationEnd.toDateString()})`);
                        
                        // Vérifier si la semaine chevauche avec les vacances
                        if (isDateOverlap(weekDates.start, weekDates.end, vacationStart, vacationEnd)) {
                            const role = assignment.member1 === member || assignment.member2 === member ? 'Référent Principal' : 'Backup';
                            
                            console.log('🚨 CONFLIT DÉTECTÉ!', {
                                member: member,
                                role: role,
                                semaine: weekNum,
                                vacances: vacation
                            });
                            
                            conflicts.push({
                                type: 'vacation_conflict',
                                weekKey: weekKey,
                                weekNumber: weekNum,
                                member: member,
                                role: role,
                                vacationStart: vacation.start,
                                vacationEnd: vacation.end,
                                severity: role === 'Backup' ? 'medium' : 'high',
                                message: `${member} (${role}) est en vacances du ${formatDateCH(vacation.start)} au ${formatDateCH(vacation.end)}`
                            });
                        }
                    });
                });
                
                // NOUVELLE VÉRIFICATION : Conflits d'équipe incomplète
                // Si un des membres principaux est absent, l'équipe est incomplète
                const mainMembers = [assignment.member1, assignment.member2].filter(m => m);
                let absentMainMembers = [];
                
                mainMembers.forEach(member => {
                    const memberVacations = vacations[member] || [];
                    memberVacations.forEach(vacation => {
                        const vacationStart = new Date(vacation.start);
                        const vacationEnd = new Date(vacation.end);
                        
                        if (isDateOverlap(weekDates.start, weekDates.end, vacationStart, vacationEnd)) {
                            absentMainMembers.push({
                                member: member,
                                vacation: vacation
                            });
                        }
                    });
                });
                
                // Si un membre principal est absent mais pas l'autre, créer un conflit d'équipe incomplète
                if (absentMainMembers.length === 1 && mainMembers.length === 2) {
                    const absentMember = absentMainMembers[0];
                    const presentMember = mainMembers.find(m => m !== absentMember.member);
                    
                    console.log('🚨 ÉQUIPE INCOMPLÈTE DÉTECTÉE!', {
                        semaine: weekNum,
                        absent: absentMember.member,
                        present: presentMember
                    });
                    
                    conflicts.push({
                        type: 'incomplete_team',
                        weekKey: weekKey,
                        weekNumber: weekNum,
                        absentMember: absentMember.member,
                        presentMember: presentMember,
                        backup: assignment.backup,
                        vacationStart: absentMember.vacation.start,
                        vacationEnd: absentMember.vacation.end,
                        severity: 'high',
                        message: `Équipe incomplète: ${absentMember.member} est en vacances, ${presentMember} se retrouve seul(e). Backup: ${assignment.backup || 'Non défini'}`
                    });
                }
                
                // Vérifier les doublons (même personne assignée plusieurs fois la même semaine)
                const allMembers = [assignment.member1, assignment.member2, assignment.backup].filter(m => m);
                const uniqueMembers = [...new Set(allMembers)];
                
                if (allMembers.length !== uniqueMembers.length) {
                    const duplicates = allMembers.filter((member, index) => allMembers.indexOf(member) !== index);
                    duplicates.forEach(member => {
                        console.log('🚨 DOUBLON DÉTECTÉ!', {
                            member: member,
                            semaine: weekNum
                        });
                        
                        conflicts.push({
                            type: 'duplicate_assignment',
                            weekKey: weekKey,
                            weekNumber: weekNum,
                            member: member,
                            severity: 'high',
                            message: `${member} est assigné plusieurs fois la même semaine`
                        });
                    });
                }
            });
            
            console.log('=== RÉSULTAT DÉTECTION ===');
            console.log('Conflits détectés:', conflicts.length);
            console.log('Détails des conflits:', conflicts);
            
            // Afficher une notification s'il y a de nouveaux conflits
            if (conflicts.length > 0) {
                const highSeverityConflicts = conflicts.filter(c => c.severity === 'high').length;
                const mediumSeverityConflicts = conflicts.filter(c => c.severity === 'medium').length;
                
                if (highSeverityConflicts > 0) {
                    showNotification(`🚨 ${highSeverityConflicts} conflit(s) CRITIQUE(S) détecté(s) !`, 'error');
                } else if (mediumSeverityConflicts > 0) {
                    showNotification(`⚠️ ${mediumSeverityConflicts} conflit(s) détecté(s)`, 'warning');
                }
            }
        }
        
        // Fonction utilitaire pour vérifier le chevauchement de dates
        function isDateOverlap(start1, end1, start2, end2) {
            const overlap = start1 <= end2 && end1 >= start2;
            console.log(`Chevauchement test: [${start1.toDateString()} - ${end1.toDateString()}] vs [${start2.toDateString()} - ${end2.toDateString()}] = ${overlap}`);
            return overlap;
        }
        
        // Fonction utilitaire pour formater les dates au format suisse
        function formatDateCH(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }
        
        // Fonction utilitaire pour formater une plage de dates au format suisse
        function formatDateRangeCH(startDate, endDate) {
            return `${formatDateCH(startDate)} - ${formatDateCH(endDate)}`;
        }

        function updateYearView() {
            const container = document.getElementById('yearView');
            if (!container) return;
            
            container.innerHTML = '';
            const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
            
            months.forEach((month, monthIndex) => {
                const monthBlock = document.createElement('div');
                monthBlock.className = 'month-block';
                
                const header = document.createElement('div');
                header.className = 'month-header';
                header.textContent = month;
                monthBlock.appendChild(header);
                
                const weeksContainer = document.createElement('div');
                weeksContainer.className = 'weeks-container';
                
                // Obtenir les vraies semaines de ce mois
                const weeksInMonth = getWeeksInMonth(currentYear, monthIndex);
                
                weeksInMonth.forEach(weekNum => {
                    const weekRow = document.createElement('div');
                    weekRow.className = 'week-row';
                    weekRow.dataset.week = weekNum; // Important pour le drag and drop
                    
                    const weekKey = `${currentYear}-W${weekNum.toString().padStart(2, '0')}`;
                    const assignment = assignments[weekKey];
                    
                    // Vérifier s'il y a des conflits pour cette semaine
                    const weekConflicts = conflicts.filter(c => c.weekNumber === weekNum);
                    
                    if (assignment) {
                        weekRow.classList.add('assigned');
                    }
                    
                    // Ajouter la classe conflit si nécessaire
                    if (weekConflicts.length > 0) {
                        weekRow.classList.add('conflict');
                        // Ajouter une bordure rouge pour les conflits critiques
                        const highSeverityConflicts = weekConflicts.filter(c => c.severity === 'high');
                        if (highSeverityConflicts.length > 0) {
                            weekRow.style.borderLeft = '4px solid #e74c3c';
                            weekRow.style.background = '#ffebee';
                        } else {
                            weekRow.style.borderLeft = '4px solid #f39c12';
                            weekRow.style.background = '#fff3cd';
                        }
                    }
                    
                    // Obtenir les dates de la semaine pour affichage
                    const weekDates = getWeekDates(currentYear, weekNum);
                    const startDate = weekDates.start.getDate();
                    const endDate = weekDates.end.getDate();
                    
                    // Créer l'affichage des conflits
                    let conflictDisplay = '';
                    if (weekConflicts.length > 0) {
                        conflictDisplay = `
                            <div style="margin-top: 3px; padding: 3px; background: rgba(231, 76, 60, 0.1); border-radius: 3px;">
                                <span style="color: #e74c3c; font-size: 10px; font-weight: bold;">
                                    ⚠️ ${weekConflicts.length} conflit(s)
                                </span>
                            </div>
                        `;
                    }
                    
                    weekRow.innerHTML = `
                        <div class="week-info">
                            <div class="week-number">S${weekNum} (${startDate}-${endDate})</div>
                            <div class="week-assignment">
                                ${assignment ? `
                                    <div class="assignment-team">
                                        <span class="assignment-member">${assignment.member1}</span>
                                        <span class="assignment-member">${assignment.member2}</span>
                                    </div>
                                    <div style="margin-top: 2px;">
                                        <span class="assignment-backup">Backup: ${assignment.backup}</span>
                                    </div>
                                ` : '<span style="color: #999; font-size: 11px;">Non assignée</span>'}
                                ${conflictDisplay}
                            </div>
                        </div>
                        <div class="week-actions">
                            <button class="week-edit-btn" onclick="editWeek(${weekNum})" title="Éditer cette semaine">✏️</button>
                            ${assignment ? `<button class="week-delete-btn" onclick="deleteWeekAssignment('${weekKey}')" title="Supprimer cette assignation">🗑️</button>` : ''}
                            ${weekConflicts.length > 0 ? `<button class="week-edit-btn" onclick="showConflictDetails(${weekNum})" style="background: #e74c3c;" title="Voir les conflits">⚠️</button>` : ''}
                        </div>
                    `;
                    
                    weeksContainer.appendChild(weekRow);
                });
                
                monthBlock.appendChild(weeksContainer);
                container.appendChild(monthBlock);
            });
            
            // Réinitialiser les zones de drop après la mise à jour du DOM
            setTimeout(() => {
                setupWeekDropZones();
            }, 100);
        }

        function deleteWeekAssignment(weekKey) {
            if (confirm('Supprimer cette assignation ?')) {
                delete assignments[weekKey];
                saveData();
                updateAllDisplays();
                showNotification('🗑️ Assignation supprimée', 'warning');
            }
        }

        function updateAbsencesView() {
            const container = document.getElementById('absencesContainer');
            if (!container) return;
            
            container.innerHTML = '';
            container.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;';
            
            TEAM.forEach(member => {
                const card = document.createElement('div');
                card.style.cssText = 'border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f8f9fa;';
                
                const memberVacations = vacations[member] || [];
                
                card.innerHTML = `
                    <h4 style="color: #2c3e50; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #3498db;">
                        ${member} (${memberVacations.length} absences)
                    </h4>
                    ${memberVacations.length === 0 ? 
                        '<p style="color: #666; font-style: italic;">Aucune absence</p>' :
                        memberVacations.map(vac => `
                            <div style="background: white; padding: 10px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                                <span>${formatDateCH(vac.start)} - ${formatDateCH(vac.end)}</span>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteVacation('${member}', '${vac.start}', '${vac.end}')">🗑️</button>
                            </div>
                        `).join('')
                    }
                `;
                
                container.appendChild(card);
            });
        }

        function updateTeamTable() {
            const tbody = document.getElementById('teamTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            const workloads = calculateWorkloads();
            
            TEAM.forEach(member => {
                const workload = workloads[member];
                const absenceDays = vacations[member] ? vacations[member].length * 7 : 0; // Approximation
                const chargePercent = Math.round((workload.total / 52) * 100);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${member}</strong></td>
                    <td>${workload.principal}</td>
                    <td>${workload.backup}</td>
                    <td>${absenceDays}</td>
                    <td>${chargePercent}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateConflictDisplay() {
            const container = document.getElementById('conflictList');
            if (!container) return;
            
            if (conflicts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #27ae60;">
                        <h3>✅ Aucun conflit détecté</h3>
                        <p>Le planning est optimal</p>
                    </div>
                `;
            } else {
                // Grouper les conflits par type
                const vacationConflicts = conflicts.filter(c => c.type === 'vacation_conflict');
                const incompleteTeamConflicts = conflicts.filter(c => c.type === 'incomplete_team');
                const duplicateConflicts = conflicts.filter(c => c.type === 'duplicate_assignment');
                
                let conflictHTML = `
                    <div style="background: #ffebee; border: 2px solid #e74c3c; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #c62828; margin-bottom: 15px;">⚠️ ${conflicts.length} Conflit(s) Détecté(s)</h3>
                        <p style="color: #d32f2f; margin-bottom: 20px;">Voici les problèmes qui nécessitent votre attention :</p>
                    </div>
                `;
                
                // Conflits d'équipes incomplètes (NOUVEAU)
                if (incompleteTeamConflicts.length > 0) {
                    conflictHTML += `
                        <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="color: #e74c3c; margin-bottom: 15px;">👥 Équipes Incomplètes (${incompleteTeamConflicts.length})</h4>
                            <p style="color: #666; margin-bottom: 15px;">Une personne du binôme est absente, laissant son partenaire seul(e) :</p>
                            <div style="display: grid; gap: 10px;">
                    `;
                    
                    incompleteTeamConflicts.forEach(conflict => {
                        conflictHTML += `
                            <div style="border-left: 4px solid #e74c3c; padding: 15px; background: #fff5f5; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <strong style="color: #2c3e50;">Semaine ${conflict.weekNumber} 🚨</strong>
                                    <span style="background: #e74c3c; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">CRITIQUE</span>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                    <p style="margin: 0; color: #555;"><strong>Absent:</strong> ${conflict.absentMember} (${formatDateCH(conflict.vacationStart)} - ${formatDateCH(conflict.vacationEnd)})</p>
                                    <p style="margin: 5px 0 0 0; color: #555;"><strong>Présent:</strong> ${conflict.presentMember} (seul en équipe)</p>
                                    <p style="margin: 5px 0 0 0; color: #555;"><strong>Backup:</strong> ${conflict.backup || 'Non défini'}</p>
                                </div>
                                <p style="color: #d32f2f; margin: 5px 0; font-weight: bold;">⚠️ ${conflict.presentMember} devra assurer seul(e) ou avec le backup</p>
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;" 
                                            onclick="editWeek(${conflict.weekNumber})">✏️ Réassigner</button>
                                    <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" 
                                            onclick="deleteWeekAssignment('${conflict.weekKey}')">🗑️ Supprimer</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    conflictHTML += '</div></div>';
                }
                
                if (vacationConflicts.length > 0) {
                    conflictHTML += `
                        <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="color: #e74c3c; margin-bottom: 15px;">🏖️ Conflits de Vacances Directs (${vacationConflicts.length})</h4>
                            <div style="display: grid; gap: 10px;">
                    `;
                    
                    vacationConflicts.forEach(conflict => {
                        const severityColor = conflict.severity === 'high' ? '#e74c3c' : '#f39c12';
                        const severityIcon = conflict.severity === 'high' ? '🚨' : '⚠️';
                        
                        conflictHTML += `
                            <div style="border-left: 4px solid ${severityColor}; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <strong style="color: #2c3e50;">Semaine ${conflict.weekNumber} ${severityIcon}</strong>
                                    <span style="background: ${severityColor}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">
                                        ${conflict.severity === 'high' ? 'CRITIQUE' : 'ATTENTION'}
                                    </span>
                                </div>
                                <p style="color: #555; margin: 5px 0;">${conflict.message}</p>
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;" 
                                            onclick="editWeek(${conflict.weekNumber})">✏️ Modifier</button>
                                    <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" 
                                            onclick="deleteWeekAssignment('${conflict.weekKey}')">🗑️ Supprimer</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    conflictHTML += '</div></div>';
                }
                
                if (duplicateConflicts.length > 0) {
                    conflictHTML += `
                        <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="color: #e74c3c; margin-bottom: 15px;">👥 Assignations Multiples (${duplicateConflicts.length})</h4>
                            <div style="display: grid; gap: 10px;">
                    `;
                    
                    duplicateConflicts.forEach(conflict => {
                        conflictHTML += `
                            <div style="border-left: 4px solid #e74c3c; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <strong style="color: #2c3e50;">Semaine ${conflict.weekNumber} 🚨</strong>
                                    <span style="background: #e74c3c; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">CRITIQUE</span>
                                </div>
                                <p style="color: #555; margin: 5px 0;">${conflict.message}</p>
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" 
                                            onclick="editWeek(${conflict.weekNumber})">✏️ Corriger</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    conflictHTML += '</div></div>';
                }
                
                // Ajouter des actions rapides
                conflictHTML += `
                    <div style="background: #e8f4fd; border: 2px solid #3498db; border-radius: 10px; padding: 20px; margin-top: 20px;">
                        <h4 style="color: #2980b9; margin-bottom: 15px;">🛠️ Actions Rapides</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <button class="btn btn-warning" onclick="autoResolveVacationConflicts()">🏖️ Résoudre Conflits Vacances</button>
                            <button class="btn btn-info" onclick="switchTab('absences')">📝 Gérer les Absences</button>
                            <button class="btn btn-success" onclick="autoFillWithBalance()">⚡ Regénérer Planning</button>
                        </div>
                    </div>
                `;
                
                container.innerHTML = conflictHTML;
            }
        }
        
        // Fonction pour afficher les détails d'un conflit spécifique
        function showConflictDetails(weekNumber) {
            const weekConflicts = conflicts.filter(c => c.weekNumber === weekNumber);
            if (weekConflicts.length === 0) return;
            
            let message = `Conflits pour la semaine ${weekNumber}:\n\n`;
            weekConflicts.forEach(conflict => {
                message += `• ${conflict.message}\n`;
            });
            
            message += '\nVoulez-vous modifier cette semaine ?';
            
            if (confirm(message)) {
                editWeek(weekNumber);
            }
        }
        
        // Fonction pour résoudre automatiquement les conflits de vacances
        function autoResolveVacationConflicts() {
            const vacationConflicts = conflicts.filter(c => c.type === 'vacation_conflict');
            
            if (vacationConflicts.length === 0) {
                showNotification('✅ Aucun conflit de vacances à résoudre', 'info');
                return;
            }
            
            if (!confirm(`Résoudre automatiquement ${vacationConflicts.length} conflit(s) de vacances ?\n\nCela supprimera les assignations problématiques.`)) {
                return;
            }
            
            let resolvedCount = 0;
            
            vacationConflicts.forEach(conflict => {
                // Supprimer l'assignation qui pose problème
                if (assignments[conflict.weekKey]) {
                    delete assignments[conflict.weekKey];
                    resolvedCount++;
                }
            });
            
            saveData();
            updateAllDisplays();
            
            showNotification(`✅ ${resolvedCount} conflit(s) de vacances résolu(s)`, 'success');
        }

        // Analyse des binômes
        function calculatePartnershipStats() {
            const partnerships = {};
            const memberStats = {};
            
            TEAM.forEach(member => {
                memberStats[member] = { collaborations: {} };
            });
            
            Object.values(assignments).forEach(assignment => {
                const member1 = assignment.member1;
                const member2 = assignment.member2;
                
                if (member1 && member2 && TEAM.includes(member1) && TEAM.includes(member2)) {
                    const partnershipKey = [member1, member2].sort().join(' + ');
                    
                    if (!partnerships[partnershipKey]) {
                        partnerships[partnershipKey] = { members: [member1, member2], count: 0 };
                    }
                    partnerships[partnershipKey].count++;
                    
                    if (!memberStats[member1].collaborations[member2]) {
                        memberStats[member1].collaborations[member2] = 0;
                    }
                    if (!memberStats[member2].collaborations[member1]) {
                        memberStats[member2].collaborations[member1] = 0;
                    }
                    memberStats[member1].collaborations[member2]++;
                    memberStats[member2].collaborations[member1]++;
                }
            });
            
            return { partnerships, memberStats };
        }

        function updatePartnershipAnalysis() {
            const { partnerships, memberStats } = calculatePartnershipStats();
            
            const totalPartnerships = Object.keys(partnerships).length;
            const maxPartnership = Object.values(partnerships).length > 0 ? 
                Math.max(...Object.values(partnerships).map(p => p.count)) : 0;
            
            const maxPossiblePartnerships = (TEAM.length * (TEAM.length - 1)) / 2;
            const diversityScore = Math.round((totalPartnerships / maxPossiblePartnerships) * 100);
            
            if (document.getElementById('totalPartnerships')) {
                document.getElementById('totalPartnerships').textContent = totalPartnerships;
                document.getElementById('maxPartnership').textContent = maxPartnership;
                document.getElementById('diversityScore').textContent = diversityScore + '%';
            }
            
            updateCollaborationHeatmap(memberStats);
            updatePartnershipDetails(partnerships);
        }

        function updateCollaborationHeatmap(memberStats) {
            const container = document.getElementById('collaborationHeatmap');
            if (!container) return;
            
            const maxCollaborations = Math.max(...TEAM.flatMap(member1 => 
                TEAM.map(member2 => member1 !== member2 ? (memberStats[member1]?.collaborations[member2] || 0) : 0)
            ));
            
            let gridHTML = '<div class="heatmap-grid" style="grid-template-columns: 100px repeat(' + TEAM.length + ', 1fr);">';
            
            // Header row
            gridHTML += '<div class="heatmap-cell" style="background: #34495e;"></div>';
            TEAM.forEach(member => {
                gridHTML += `<div class="heatmap-cell" style="background: #34495e;">${member.split(' ')[1] || member.substring(0, 3)}</div>`;
            });
            
            // Data rows
            TEAM.forEach(member1 => {
                gridHTML += `<div class="heatmap-cell" style="background: #34495e; text-align: left; padding-left: 5px;">${member1.split(' ')[1] || member1.substring(0, 3)}</div>`;
                TEAM.forEach(member2 => {
                    if (member1 === member2) {
                        gridHTML += '<div class="heatmap-cell" style="background: #95a5a6;">-</div>';
                    } else {
                        const count = memberStats[member1]?.collaborations[member2] || 0;
                        const intensity = maxCollaborations > 0 ? count / maxCollaborations : 0;
                        const color = getHeatmapColor(intensity);
                        gridHTML += `<div class="heatmap-cell" style="background: ${color};" title="${member1} + ${member2}: ${count} fois">${count}</div>`;
                    }
                });
            });
            
            gridHTML += '</div>';
            container.innerHTML = gridHTML;
        }

        function getHeatmapColor(intensity) {
            if (intensity === 0) return '#ecf0f1';
            if (intensity <= 0.3) return '#d5dbdb';
            if (intensity <= 0.6) return '#85c1e9';
            return '#3498db';
        }

        function updatePartnershipDetails(partnerships) {
            const container = document.getElementById('partnershipDetails');
            if (!container) return;
            
            const sortedPartnerships = Object.entries(partnerships).sort(([,a], [,b]) => b.count - a.count);
            
            if (sortedPartnerships.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Aucun binôme assigné pour le moment.</p>';
                return;
            }
            
            container.innerHTML = '<div class="partnership-grid">' +
                sortedPartnerships.map(([key, partnership]) => {
                    const [member1, member2] = partnership.members;
                    const isFrequent = partnership.count >= 3;
                    const borderColor = isFrequent ? '#e74c3c' : '#3498db';
                    
                    return `
                        <div class="partnership-card" style="border-left-color: ${borderColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="color: #2c3e50; margin: 0;">${member1} + ${member2}</h4>
                                <span style="background: ${borderColor}; color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 14px;">${partnership.count}x</span>
                            </div>
                            <div style="font-size: 14px; color: #666;">
                                ${isFrequent ? 
                                    '<span style="color: #e74c3c;">⚠️ Partenariat fréquent</span>' : 
                                    '<span style="color: #27ae60;">✓ Partenariat équilibré</span>'
                                }
                            </div>
                        </div>
                    `;
                }).join('') + '</div>';
        }

        // Gestion des binômes prédéfinis
        function updatePredefinedPairsList() {
            const container = document.getElementById('predefinedPairsList');
            if (!container) return;
            
            // Initialiser avec des binômes par défaut si vide
            if (predefinedPairs.length === 0) {
                resetPredefinedPairs();
                return;
            }
            
            container.innerHTML = predefinedPairs.map((pair, index) => `
                <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                    <span style="font-weight: bold; color: #666; width: 80px;">Binôme ${index + 1}:</span>
                    
                    <select id="pair${index}_member1" style="flex: 1; padding: 8px; border: 2px solid #ecf0f1; border-radius: 5px;">
                        <option value="">Membre 1</option>
                        ${TEAM.map(member => `<option value="${member}" ${pair.member1 === member ? 'selected' : ''}>${member}</option>`).join('')}
                    </select>
                    
                    <span style="font-weight: bold; color: #3498db;">+</span>
                    
                    <select id="pair${index}_member2" style="flex: 1; padding: 8px; border: 2px solid #ecf0f1; border-radius: 5px;">
                        <option value="">Membre 2</option>
                        ${TEAM.map(member => `<option value="${member}" ${pair.member2 === member ? 'selected' : ''}>${member}</option>`).join('')}
                    </select>
                    
                    <button class="btn btn-danger" style="padding: 8px 12px; font-size: 12px;" onclick="removePredefinedPair(${index})">🗑️</button>
                </div>
            `).join('');
        }

        function addPredefinedPair() {
            predefinedPairs.push({ member1: '', member2: '' });
            updatePredefinedPairsList();
            showNotification('➕ Nouveau binôme ajouté', 'info');
        }

        function removePredefinedPair(index) {
            if (predefinedPairs.length <= 1) {
                showNotification('❌ Vous devez garder au moins un binôme', 'error');
                return;
            }
            
            predefinedPairs.splice(index, 1);
            updatePredefinedPairsList();
            showNotification('🗑️ Binôme supprimé', 'warning');
        }

        function resetPredefinedPairs() {
            // Créer des binômes par défaut intelligents
            predefinedPairs = [
                { member1: TEAM[0], member2: TEAM[1] },
                { member1: TEAM[2], member2: TEAM[3] },
                { member1: TEAM[4], member2: TEAM[5] },
                { member1: TEAM[6], member2: TEAM[7] }
            ];
            updatePredefinedPairsList();
            showNotification('🔄 Binômes par défaut créés', 'info');
        }

        function savePredefinedPairs() {
            const newPairs = [];
            
            for (let i = 0; i < predefinedPairs.length; i++) {
                const member1 = document.getElementById(`pair${i}_member1`).value;
                const member2 = document.getElementById(`pair${i}_member2`).value;
                
                if (!member1 || !member2) {
                    showNotification(`❌ Binôme ${i + 1}: Veuillez sélectionner les deux membres`, 'error');
                    return;
                }
                
                if (member1 === member2) {
                    showNotification(`❌ Binôme ${i + 1}: Les membres doivent être différents`, 'error');
                    return;
                }
                
                // Vérifier les doublons
                const pairKey = [member1, member2].sort().join('|');
                if (newPairs.some(p => [p.member1, p.member2].sort().join('|') === pairKey)) {
                    showNotification(`❌ Binôme ${i + 1}: Ce binôme existe déjà`, 'error');
                    return;
                }
                
                newPairs.push({ member1, member2 });
            }
            
            predefinedPairs = newPairs;
            saveData();
            showNotification('✅ Configuration des binômes sauvegardée !', 'success');
        }

        // Remplissage avec binômes prédéfinis
        function fillWithPredefinedPairs() {
            if (predefinedPairs.length === 0) {
                showNotification('❌ Veuillez d\'abord configurer vos binômes dans l\'onglet "Config Binômes"', 'error');
                return;
            }
            
            // Validation des binômes
            for (let pair of predefinedPairs) {
                if (!pair.member1 || !pair.member2 || pair.member1 === pair.member2) {
                    showNotification('❌ Certains binômes sont mal configurés. Vérifiez l\'onglet "Config Binômes"', 'error');
                    return;
                }
            }
            
            if (!confirm(`Remplir l'année avec vos ${predefinedPairs.length} binômes prédéfinis ?\n\nCela utilisera une rotation intelligente de vos binômes.`)) return;
            
            const pairUsageCount = new Array(predefinedPairs.length).fill(0);
            const memberLastWeek = {};
            
            // Initialiser le suivi des dernières semaines
            TEAM.forEach(member => {
                memberLastWeek[member] = 0;
            });
            
            for (let week = 1; week <= 52; week++) {
                const weekKey = `${currentYear}-W${week.toString().padStart(2, '0')}`;
                
                // Trouver le binôme le moins utilisé dont les membres sont disponibles
                let bestPairIndex = -1;
                let minUsage = Infinity;
                
                for (let i = 0; i < predefinedPairs.length; i++) {
                    const pair = predefinedPairs[i];
                    const member1LastWeek = memberLastWeek[pair.member1] || 0;
                    const member2LastWeek = memberLastWeek[pair.member2] || 0;
                    
                    // Éviter d'assigner quelqu'un deux semaines de suite
                    if (week - member1LastWeek >= 2 && week - member2LastWeek >= 2) {
                        if (pairUsageCount[i] < minUsage) {
                            minUsage = pairUsageCount[i];
                            bestPairIndex = i;
                        }
                    }
                }
                
                // Si aucun binôme n'est disponible, prendre le moins utilisé quand même
                if (bestPairIndex === -1) {
                    bestPairIndex = pairUsageCount.indexOf(Math.min(...pairUsageCount));
                }
                
                const selectedPair = predefinedPairs[bestPairIndex];
                
                // Sélectionner le backup parmi les membres non utilisés cette semaine
                const usedMembers = [selectedPair.member1, selectedPair.member2];
                const availableForBackup = TEAM.filter(member => !usedMembers.includes(member))
                    .sort((a, b) => (memberLastWeek[a] || 0) - (memberLastWeek[b] || 0));
                
                const backup = availableForBackup[0];
                
                // Enregistrer l'assignation
                assignments[weekKey] = {
                    member1: selectedPair.member1,
                    member2: selectedPair.member2,
                    backup: backup
                };
                
                // Mettre à jour les compteurs
                pairUsageCount[bestPairIndex]++;
                memberLastWeek[selectedPair.member1] = week;
                memberLastWeek[selectedPair.member2] = week;
                memberLastWeek[backup] = week;
            }
            
            saveData();
            updateAllDisplays();
            generateRandomTeams(); // Regénérer les équipes dans la sidebar
            
            // Afficher un rapport
            const report = predefinedPairs.map((pair, index) => 
                `${pair.member1} + ${pair.member2}: ${pairUsageCount[index]} fois`
            ).join('\n');
            
            showNotification('✅ Planning rempli avec vos binômes prédéfinis !', 'success');
            
            setTimeout(() => {
                alert(`🎯 Rapport de répartition:\n\n${report}\n\nTotal: 52 semaines assignées`);
            }, 1000);
        }

        // Remplissage automatique avec rotation intelligente (fonction originale)
        function autoFillWithBalance() {
            if (!confirm('Remplir automatiquement l\'année avec une rotation intelligente des binômes?')) return;
            
            const memberAssignments = {};
            const partnershipHistory = {};
            
            TEAM.forEach(member => {
                memberAssignments[member] = { principal: 0, backup: 0, lastWeek: 0, partners: new Set() };
            });
            
            function getPartnershipScore(member1, member2) {
                const key = [member1, member2].sort().join('|');
                return partnershipHistory[key] || 0;
            }
            
            function updatePartnershipHistory(member1, member2) {
                const key = [member1, member2].sort().join('|');
                partnershipHistory[key] = (partnershipHistory[key] || 0) + 1;
                memberAssignments[member1].partners.add(member2);
                memberAssignments[member2].partners.add(member1);
            }
            
            for (let week = 1; week <= 52; week++) {
                const weekKey = `${currentYear}-W${week.toString().padStart(2, '0')}`;
                
                // Filtrer les membres disponibles (pas assignés la semaine précédente)
                const availableMembers = [...TEAM].filter(member => {
                    return week - memberAssignments[member].lastWeek >= 2;
                }).sort((a, b) => {
                    const scoreA = memberAssignments[a].principal * 2 + memberAssignments[a].backup;
                    const scoreB = memberAssignments[b].principal * 2 + memberAssignments[b].backup;
                    return scoreA - scoreB;
                });
                
                if (availableMembers.length < 3) {
                    availableMembers.push(...TEAM.filter(m => !availableMembers.includes(m)));
                }
                
                // Trouver le meilleur binôme (moins utilisé ensemble)
                let bestPair = null;
                let bestScore = Infinity;
                
                for (let i = 0; i < Math.min(6, availableMembers.length); i++) {
                    for (let j = i + 1; j < Math.min(6, availableMembers.length); j++) {
                        const member1 = availableMembers[i];
                        const member2 = availableMembers[j];
                        
                        const partnershipScore = getPartnershipScore(member1, member2);
                        const workloadScore = memberAssignments[member1].principal + memberAssignments[member2].principal;
                        const diversityBonus = memberAssignments[member1].partners.has(member2) ? 10 : 0;
                        
                        const totalScore = partnershipScore * 5 + workloadScore + diversityBonus;
                        
                        if (totalScore < bestScore) {
                            bestScore = totalScore;
                            bestPair = [member1, member2];
                        }
                    }
                }
                
                const [member1, member2] = bestPair || [availableMembers[0], availableMembers[1]];
                
                // Sélectionner le backup
                const availableForBackup = TEAM.filter(m => m !== member1 && m !== member2)
                    .sort((a, b) => memberAssignments[a].backup - memberAssignments[b].backup);
                
                const backup = availableForBackup[0];
                
                // Enregistrer l'assignation
                assignments[weekKey] = { member1, member2, backup };
                
                // Mettre à jour les compteurs
                memberAssignments[member1].principal++;
                memberAssignments[member1].lastWeek = week;
                memberAssignments[member2].principal++;
                memberAssignments[member2].lastWeek = week;
                memberAssignments[backup].backup++;
                memberAssignments[backup].lastWeek = week;
                
                updatePartnershipHistory(member1, member2);
            }
            
            saveData();
            updateAllDisplays();
            generateRandomTeams(); // Regénérer les équipes dans la sidebar
            showNotification('✅ Planning rempli avec rotation intelligente des binômes !', 'success');
        }

        function showPartnershipAnalysis() {
            switchTab('partnerships');
        }

        // Gestion des modals
        function populateSelects() {
            const selects = ['member1', 'member2', 'backup', 'vacationMember'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Sélectionner</option>';
                    TEAM.forEach(member => {
                        select.innerHTML += `<option value="${member}">${member}</option>`;
                    });
                }
            });
        }

        function showAssignModal() {
            document.getElementById('assignModal').style.display = 'block';
        }

        function showVacationModal() {
            document.getElementById('vacationModal').style.display = 'block';
        }

        function showTeamEditModal() {
            const modal = document.getElementById('teamEditModal');
            const list = document.getElementById('teamEditList');
            
            list.innerHTML = TEAM.map((member, index) => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                    <span style="font-weight: bold; color: #666; width: 30px;">${index + 1}.</span>
                    <input type="text" id="teamMember${index}" value="${member}" required
                           style="flex: 1; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px;"
                           placeholder="Nom du référent ${index + 1}">
                </div>
            `).join('');
            
            modal.style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function editWeek(weekNum) {
            const weekKey = `${currentYear}-W${weekNum.toString().padStart(2, '0')}`;
            document.getElementById('weekInput').value = weekKey;
            
            const assignment = assignments[weekKey];
            if (assignment) {
                document.getElementById('member1').value = assignment.member1;
                document.getElementById('member2').value = assignment.member2;
                document.getElementById('backup').value = assignment.backup;
            } else {
                document.getElementById('member1').value = '';
                document.getElementById('member2').value = '';
                document.getElementById('backup').value = '';
            }
            
            showAssignModal();
        }

        function saveAssignment(event) {
            event.preventDefault();
            
            const weekValue = document.getElementById('weekInput').value;
            const member1 = document.getElementById('member1').value;
            const member2 = document.getElementById('member2').value;
            const backup = document.getElementById('backup').value;
            
            if (member1 === member2 || member1 === backup || member2 === backup) {
                showNotification('❌ Les membres doivent être différents', 'error');
                return;
            }
            
            assignments[weekValue] = { member1, member2, backup };
            
            console.log('Nouvelle assignation:', { weekValue, member1, member2, backup });
            console.log('Toutes les assignations:', assignments);
            
            saveData();
            closeModal('assignModal');
            updateAllDisplays();
            generateRandomTeams(); // Regénérer les équipes dans la sidebar
            showNotification('✅ Assignation enregistrée', 'success');
            
            // Forcer une vérification immédiate des conflits
            setTimeout(() => {
                console.log('Vérification forcée des conflits après assignation...');
                detectConflicts();
                updateConflictDisplay();
            }, 500);
        }

        function saveVacation(event) {
            event.preventDefault();
            
            const member = document.getElementById('vacationMember').value;
            const start = document.getElementById('vacationStart').value;
            const end = document.getElementById('vacationEnd').value;
            
            if (new Date(end) < new Date(start)) {
                showNotification('❌ Date de fin invalide', 'error');
                return;
            }
            
            if (!vacations[member]) vacations[member] = [];
            vacations[member].push({ start, end });
            
            console.log('Nouvelle absence ajoutée:', { member, start, end });
            console.log('Toutes les vacances:', vacations);
            
            saveData();
            closeModal('vacationModal');
            updateAllDisplays(); // Ceci va déclencher detectConflicts()
            showNotification(`✅ Absence enregistrée pour ${member}`, 'success');
            
            // Forcer une vérification immédiate des conflits
            setTimeout(() => {
                console.log('Vérification forcée des conflits après ajout absence...');
                detectConflicts();
                updateConflictDisplay();
            }, 500);
        }

        function saveTeamNames(event) {
            event.preventDefault();
            
            const newNames = [];
            for (let i = 0; i < TEAM.length; i++) {
                const newName = document.getElementById(`teamMember${i}`).value.trim();
                if (!newName) {
                    showNotification('❌ Tous les noms doivent être remplis', 'error');
                    return;
                }
                newNames.push(newName);
            }
            
            const uniqueNames = new Set(newNames);
            if (uniqueNames.size !== newNames.length) {
                showNotification('❌ Les noms doivent être uniques', 'error');
                return;
            }
            
            TEAM = newNames;
            saveData();
            populateSelects();
            updatePredefinedPairsList(); // Mettre à jour les binômes aussi
            updateAllDisplays();
            generateRandomTeams(); // Regénérer les équipes dans la sidebar
            closeModal('teamEditModal');
            showNotification('✅ Noms de l\'équipe mis à jour', 'success');
        }

        function resetTeamNames() {
            const defaultNames = ['Référent 1', 'Référent 2', 'Référent 3', 'Référent 4', 'Référent 5', 'Référent 6', 'Référent 7', 'Référent 8', 'Référent 9'];
            for (let i = 0; i < defaultNames.length; i++) {
                const input = document.getElementById(`teamMember${i}`);
                if (input) input.value = defaultNames[i];
            }
            showNotification('🔄 Noms réinitialisés', 'info');
        }

        function deleteVacation(member, start, end) {
            if (!confirm('Supprimer cette absence?')) return;
            
            vacations[member] = vacations[member].filter(v => !(v.start === start && v.end === end));
            saveData();
            updateAllDisplays();
            showNotification('✅ Absence supprimée', 'success');
        }

        function exportAll() {
            const data = {
                version: '3.1',
                exportDate: new Date().toISOString(),
                year: currentYear,
                assignments: assignments,
                vacations: vacations,
                teamNames: TEAM,
                predefinedPairs: predefinedPairs
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `planning_${currentYear}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('💾 Export JSON généré avec succès', 'success');
        }

        function exportCalendars() {
            let exportCount = 0;
            
            TEAM.forEach(member => {
                let icsContent = 'BEGIN:VCALENDAR\r\n';
                icsContent += 'VERSION:2.0\r\n';
                icsContent += 'PRODID:-//Planning Manager Pro//FR\r\n';
                icsContent += `X-WR-CALNAME:Planning ${member} - ${currentYear}\r\n`;
                
                Object.entries(assignments).forEach(([weekKey, assignment]) => {
                    if (!weekKey.startsWith(`${currentYear}-W`)) return;
                    
                    const weekNum = parseInt(weekKey.split('-W')[1]);
                    let role = null;
                    
                    if (assignment.member1 === member || assignment.member2 === member) {
                        role = 'Référent Principal';
                    } else if (assignment.backup === member) {
                        role = 'Backup';
                    }
                    
                    if (role) {
                        const uid = `${weekKey}-${member.replace(/\s+/g, '_')}@planningpro`;
                        const weekDates = getWeekDates(currentYear, weekNum);
                        
                        // Formatter les dates pour ICS (YYYYMMDD)
                        const formatDateForICS = (date) => {
                            return date.getFullYear().toString() + 
                                   (date.getMonth() + 1).toString().padStart(2, '0') + 
                                   date.getDate().toString().padStart(2, '0');
                        };
                        
                        const startDate = formatDateForICS(weekDates.start);
                        const endDate = formatDateForICS(new Date(weekDates.end.getTime() + 24 * 60 * 60 * 1000)); // +1 jour pour exclusif
                        
                        icsContent += 'BEGIN:VEVENT\r\n';
                        icsContent += `UID:${uid}\r\n`;
                        icsContent += `DTSTART;VALUE=DATE:${startDate}\r\n`;
                        icsContent += `DTEND;VALUE=DATE:${endDate}\r\n`;
                        icsContent += `SUMMARY:${role} - Semaine ${weekNum}\r\n`;
                        icsContent += `DESCRIPTION:Équipe: ${assignment.member1} + ${assignment.member2}, Backup: ${assignment.backup}\r\n`;
                        icsContent += 'END:VEVENT\r\n';
                    }
                });
                
                icsContent += 'END:VCALENDAR';
                
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a');
                const fileName = `planning_${member.replace(/\s+/g, '_')}_${currentYear}.ics`;
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                
                setTimeout(() => {
                    link.click();
                    exportCount++;
                    if (exportCount === TEAM.length) {
                        setTimeout(() => {
                            showNotification(`📅 ${exportCount} calendriers exportés !`, 'success');
                        }, 500);
                    }
                }, exportCount * 100);
            });
        }

        function confirmReboot() {
            if (confirm('⚠️ ATTENTION: Cette action effacera TOUTES les données.\n\nContinuer?')) {
                assignments = {};
                vacations = {};
                conflicts = [];
                predefinedPairs = [];
                saveData();
                updateAllDisplays();
                generateRandomTeams(); // Regénérer les équipes dans la sidebar
                showNotification('🔄 Système réinitialisé', 'warning');
            }
        }

        function changeYear(delta) {
            currentYear += delta;
            document.getElementById('currentYear').textContent = currentYear;
            updateAllDisplays();
            generateRandomTeams(); // Regénérer les équipes dans la sidebar
            saveData();
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Fermer les modals en cliquant dehors
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>
