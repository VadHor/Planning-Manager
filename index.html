<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Manager - Système de Conflits Intégré</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        .connection-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .connection-status.connected {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            border: 1px solid rgba(39, 174, 96, 0.3);
        }

        .connection-status.disconnected {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
            gap: 15px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .year-selector button {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #6c757d;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .year-selector button:hover {
            background: #495057;
            transform: scale(1.1);
        }

        .main-content {
            padding: 30px;
            display: flex;
            gap: 20px;
        }

        .sidebar {
            width: 350px;
            flex-shrink: 0;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .main-panel {
            flex: 1;
            min-width: 0;
        }

        .sidebar h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .sidebar-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f1f3f4;
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        /* ========================================
           DASHBOARD DES CONFLITS INTÉGRÉ
        ======================================== */
        
        .conflicts-dashboard {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .conflict-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-conflict {
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .stat-conflict:hover {
            transform: translateY(-2px);
        }

        .stat-conflict.critical {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            animation: criticalPulse 2s infinite;
        }

        .stat-conflict.moderate {
            background: linear-gradient(135deg, #ffa726, #ff9800);
            color: white;
        }

        .stat-conflict.warning {
            background: linear-gradient(135deg, #ffee58, #ffd54f);
            color: #333;
        }

        .stat-conflict.upcoming {
            background: linear-gradient(135deg, #42a5f5, #2196f3);
            color: white;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8em;
            opacity: 0.9;
        }

        @keyframes criticalPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            50% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
        }

        /* Liste des conflits compacte */
        .conflicts-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .conflict-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .conflict-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .conflict-item.critical {
            border-left: 4px solid #ff6b6b;
        }

        .conflict-item.moderate {
            border-left: 4px solid #ffa726;
        }

        .conflict-item.warning {
            border-left: 4px solid #ffee58;
        }

        .conflict-header {
            padding: 12px 15px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .conflict-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .conflict-severity {
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .conflict-severity.critical {
            background: #ffebee;
            color: #c62828;
        }

        .conflict-severity.moderate {
            background: #fff3e0;
            color: #ef6c00;
        }

        .conflict-severity.warning {
            background: #fffde7;
            color: #f57f17;
        }

        .conflict-details {
            padding: 15px;
            display: none;
            font-size: 0.85em;
        }

        .conflict-details.expanded {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Planning individuel des référents */
        .member-schedule {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .member-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .member-selector select {
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }

        .schedule-timeline {
            position: relative;
            padding: 20px 0;
        }

        .schedule-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }

        .schedule-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .schedule-item.vacation {
            border-left-color: #f39c12;
            background: #fef5e7;
        }

        .schedule-item.backup {
            border-left-color: #9b59b6;
            background: #f4ecf7;
        }

        .schedule-date {
            font-weight: bold;
            color: #2c3e50;
            margin-right: 15px;
            min-width: 100px;
        }

        .schedule-role {
            flex: 1;
        }

        .schedule-partners {
            font-size: 0.9em;
            color: #6c757d;
        }

        /* Résolveur IA intégré */
        .ai-resolver {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .resolver-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .ai-icon {
            margin-right: 8px;
        }

        .solutions-list {
            margin-top: 10px;
        }

        .solution-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
        }

        .solution-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(3px);
        }

        .solution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .solution-score {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7em;
        }

        .solution-score.optimal {
            background: #4caf50;
        }

        .solution-score.good {
            background: #ff9800;
        }

        .solution-score.fallback {
            background: #f44336;
        }

        .solution-details {
            font-size: 0.8em;
            opacity: 0.9;
        }

        /* Alertes proactives */
        .alerts-timeline {
            position: relative;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 8px;
            position: relative;
            font-size: 0.85em;
        }

        .alert-item.urgent {
            background: #ffebee;
            border-left: 3px solid #f44336;
            animation: urgentBlink 1.5s infinite;
        }

        .alert-item.warning {
            background: #fff3e0;
            border-left: 3px solid #ff9800;
        }

        .alert-item.info {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        @keyframes urgentBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .alert-icon {
            margin-right: 8px;
            font-size: 1em;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 0.9em;
        }

        .alert-description {
            font-size: 0.8em;
            color: #666;
        }

        .alert-time {
            font-size: 0.7em;
            color: #999;
            margin-top: 3px;
        }

        /* Chat IA amélioré */
        .ai-chat-container {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .ai-chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .user-message {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .ai-message {
            background: #e8f5e8;
            border-left: 3px solid #4caf50;
        }

        .loading-message {
            animation: pulse 1.5s infinite;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 0.8em;
        }

        .message-author {
            color: #2c3e50;
        }

        .message-time {
            color: #6c757d;
        }

        .message-content {
            color: #2c3e50;
        }

        .ai-chat-input {
            padding: 10px;
            display: flex;
            gap: 8px;
        }

        .ai-chat-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.85em;
        }

        /* Stats et calendrier du planning original */
        .quick-stats {
            display: grid;
            gap: 8px;
        }

        .quick-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .quick-stat-value {
            font-weight: bold;
            color: #3498db;
        }

        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .calendar-scroll-container {
            overflow-x: auto;
            overflow-y: hidden;
            margin: 0 -25px;
            padding: 0 25px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(12, 300px);
            gap: 15px;
            min-width: 3600px;
        }

        .month-column {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            min-height: 400px;
            width: 100%;
        }

        .month-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1em;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .week-item {
            background: white;
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .week-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .week-item.assigned {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #d5f4e6, #ffffff);
        }

        .week-item.vacation {
            border-left-color: #f39c12;
            background: linear-gradient(135deg, #fef5e7, #ffffff);
        }

        .week-item.conflict {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #fadbd8, #ffffff);
            animation: conflictPulse 3s infinite;
        }

        @keyframes conflictPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); }
        }

        .week-date {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .week-assignment {
            font-weight: bold;
            color: #2c3e50;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .team-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .team-member {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .team-member:hover {
            border-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .member-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .member-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.5em;
            color: #3498db;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .legend-color.assigned { background: #27ae60; }
        .legend-color.vacation { background: #f39c12; }
        .legend-color.conflict { background: #e74c3c; }
        .legend-color.unassigned { background: #dee2e6; }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            margin: 5% auto;
            padding: 40px;
            border-radius: 24px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            animation: scaleIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close {
            color: #64748b;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(248, 250, 252, 0.5);
        }

        .close:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            transform: scale(1.1) rotate(90deg);
        }

        .form-group {
            margin-bottom: 24px;
            animation: slideInLeft 0.4s ease-out;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e293b;
            font-size: 15px;
        }

        .form-group input, 
        .form-group select {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
            background: rgba(255,255,255,1);
        }

        .binome-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 10000;
        }

        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
        .notification.info { background: #3498db; }
        .notification.warning { background: #f39c12; }

        .notification.show {
            transform: translateX(0);
        }

        /* Progress bar */
        .progress-bar {
            width: 200px;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-10px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                padding: 20px;
                gap: 20px;
            }
            
            .sidebar {
                width: 100%;
                position: static;
                order: 2;
            }
            
            .main-panel {
                order: 1;
            }
            
            .conflict-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .calendar-grid {
                grid-template-columns: repeat(12, 280px);
                min-width: 3360px;
            }
            
            .binome-selector {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .conflict-stats {
                grid-template-columns: 1fr;
            }
            
            .toolbar-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Scroll bar stylé */
        .calendar-scroll-container::-webkit-scrollbar {
            height: 8px;
        }

        .calendar-scroll-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
        }

        .calendar-scroll-container::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }

        .calendar-scroll-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(90deg, #5a67d8 0%, #68d391 100%);
        }

        .conflicts-list::-webkit-scrollbar {
            width: 6px;
        }

        .conflicts-list::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 3px;
        }

        .conflicts-list::-webkit-scrollbar-thumb {
            background: #cccccc;
            border-radius: 3px;
        }

        /* Import/Export styles */
        .import-export-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background: #495057;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="connection-status disconnected" id="connectionStatus">
            🔴 Backend déconnecté
        </div>
        
        <div class="header">
            <h1>🗓️ Planning Manager - Système Intégré</h1>
            <p>Gestion des équipes référents Permis S avec détection automatique des conflits</p>
        </div>

        <div class="toolbar">
            <div class="toolbar-group">
                <div class="year-selector">
                    <button onclick="changeYear(-1)">‹</button>
                    <span id="currentYear">2025</span>
                    <button onclick="changeYear(1)">›</button>
                </div>
            </div>
            
            <div class="toolbar-group">
                <button class="btn btn-primary" onclick="showAssignmentModal()">
                    ➕ Assigner Semaine
                </button>
                <button class="btn btn-warning" onclick="showVacationModal()">
                    🏖️ Gérer Vacances
                </button>
                <button class="btn btn-success" onclick="autoAssign()">
                    🤖 Attribution Auto
                </button>
                <button class="btn btn-danger" onclick="resolveAllConflicts()">
                    🚨 Résoudre Conflits
                </button>
            </div>
            
            <div class="toolbar-group">
                <button class="btn btn-info" onclick="showMemberScheduleModal()">
                    👤 Planning Individuel
                </button>
                <button class="btn btn-primary" onclick="exportCalendar()">
                    📅 Export Agenda
                </button>
                <button class="btn btn-success" onclick="exportToExcel()">
                    📊 Export Excel
                </button>
                <button class="btn btn-warning" onclick="showDataManagement()">
                    💾 Sauvegardes
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- Sidebar améliorée avec gestion des conflits -->
            <div class="sidebar">
                <!-- Dashboard des conflits -->
                <div class="sidebar-section">
                    <h3>🚨 Détection des Conflits</h3>
                    <div class="conflict-stats">
                        <div class="stat-conflict critical">
                            <div class="stat-number" id="criticalCount">0</div>
                            <div class="stat-label">🔥 CRITIQUES</div>
                        </div>
                        <div class="stat-conflict moderate">
                            <div class="stat-number" id="moderateCount">0</div>
                            <div class="stat-label">⚠️ MODÉRÉS</div>
                        </div>
                        <div class="stat-conflict warning">
                            <div class="stat-number" id="warningCount">0</div>
                            <div class="stat-label">⏰ ATTENTION</div>
                        </div>
                        <div class="stat-conflict upcoming">
                            <div class="stat-number" id="upcomingCount">0</div>
                            <div class="stat-label">📅 À VENIR</div>
                        </div>
                    </div>
                </div>

                <!-- Alertes proactives -->
                <div class="sidebar-section">
                    <h3>🚨 Alertes Proactives</h3>
                    <div class="alerts-timeline" id="alertsTimeline">
                        <!-- Généré par JavaScript -->
                    </div>
                </div>

                <!-- Résolveur IA -->
                <div class="sidebar-section">
                    <h3>🤖 Résolveur IA</h3>
                    <div id="aiResolver">
                        <div class="ai-resolver">
                            <div class="resolver-header">
                                <span class="ai-icon">🧠</span>
                                <span>Analyse en cours...</span>
                            </div>
                            <div class="solutions-list" id="solutionsList">
                                <!-- Généré par JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat IA amélioré -->
                <div class="sidebar-section">
                    <h3>🤖 Assistant IA</h3>
                    <div class="ai-chat-container">
                        <div class="ai-chat-messages" id="aiChatMessages">
                            <div class="chat-message ai-message">
                                <div class="message-header">
                                    <span class="message-author">🤖 Assistant</span>
                                    <span class="message-time">--:--</span>
                                </div>
                                <div class="message-content">
                                    Bonjour ! Je peux vous aider à :<br>
                                    • Détecter les conflits<br>
                                    • Proposer des solutions<br>
                                    • Assigner des semaines<br>
                                    • Gérer les vacances<br>
                                    • Analyser l'équité<br>
                                    • Afficher les plannings individuels<br><br>
                                    Tapez votre demande ci-dessous !
                                </div>
                            </div>
                        </div>
                        <div class="ai-chat-input">
                            <input type="text" id="aiChatInput" placeholder="Ex: Montre le planning de Référent 1..." />
                            <button onclick="sendChatMessage()" class="btn btn-primary" style="padding: 8px 12px; font-size: 0.8em;">
                                Envoyer
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistiques rapides -->
                <div class="sidebar-section">
                    <h3>📊 Résumé</h3>
                    <div class="quick-stats">
                        <div class="quick-stat">
                            <span>Progression</span>
                            <span class="quick-stat-value" id="sidebarProgress">0%</span>
                        </div>
                        <div class="quick-stat">
                            <span>Assignées</span>
                            <span class="quick-stat-value" id="sidebarAssigned">0/52</span>
                        </div>
                        <div class="quick-stat">
                            <span>Conflits</span>
                            <span class="quick-stat-value" id="sidebarConflicts">0</span>
                        </div>
                        <div class="quick-stat">
                            <span>Équité</span>
                            <span class="quick-stat-value" id="sidebarEquity">-/10</span>
                        </div>
                    </div>
                </div>

                <!-- Actions rapides -->
                <div class="sidebar-section">
                    <h3>⚡ Actions Rapides</h3>
                    <div style="display: grid; gap: 8px;">
                        <button class="btn btn-success" style="width: 100%; font-size: 0.85em; padding: 8px;" onclick="detectConflictsAuto()">
                            🔍 Scanner Conflits
                        </button>
                        <button class="btn btn-warning" style="width: 100%; font-size: 0.85em; padding: 8px;" onclick="showConflictsList()">
                            📋 Voir Tous les Conflits
                        </button>
                        <button class="btn btn-primary" style="width: 100%; font-size: 0.85em; padding: 8px;" onclick="exportConflictsReport()">
                            📊 Rapport Conflits
                        </button>
                        <button class="btn btn-danger" style="width: 100%; font-size: 0.85em; padding: 8px;" onclick="autoResolveConflicts()">
                            🤖 Résolution Auto
                        </button>
                    </div>
                </div>
            </div>

            <!-- Panel principal -->
            <div class="main-panel">
                <!-- Import/Export Section -->
                <div class="import-export-section" id="dataManagementSection" style="display: none;">
                    <h3>💾 Gestion des Données</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <h4>Sauvegarder</h4>
                            <button class="btn btn-primary" onclick="exportJSON()" style="width: 100%; margin-bottom: 8px;">
                                📄 Export JSON
                            </button>
                            <button class="btn btn-success" onclick="exportCSV()" style="width: 100%; margin-bottom: 8px;">
                                📋 Export CSV
                            </button>
                            <button class="btn btn-info" onclick="exportFullBackup()" style="width: 100%;">
                                💾 Backup Complet
                            </button>
                        </div>
                        <div>
                            <h4>Charger</h4>
                            <div class="file-input-wrapper">
                                <label for="jsonImport" class="file-input-label">
                                    📂 Charger JSON
                                </label>
                                <input type="file" id="jsonImport" accept=".json" onchange="importJSONWithValidation(event)">
                            </div>
                            <div class="file-input-wrapper" style="margin-top: 8px;">
                                <label for="csvImport" class="file-input-label">
                                    📊 Charger CSV
                                </label>
                                <input type="file" id="csvImport" accept=".csv" onchange="importCSV(event)">
                            </div>
                            <button class="btn btn-warning" onclick="syncToGoogleDrive()" style="width: 100%; margin-top: 8px;">
                                ☁️ Sync Google Drive
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Planning individuel des référents -->
                <div class="member-schedule" id="memberSchedulePanel" style="display: none;">
                    <div class="dashboard-header">
                        <h2>👤 Planning Individuel</h2>
                        <button class="btn btn-danger" onclick="closeMemberSchedule()">✖ Fermer</button>
                    </div>
                    <div class="member-selector">
                        <label>Sélectionner un membre :</label>
                        <select id="memberScheduleSelect" onchange="displayMemberSchedule()">
                            <option value="">Choisir...</option>
                        </select>
                        <button class="btn btn-primary" onclick="printMemberSchedule()">🖨️ Imprimer</button>
                    </div>
                    <div class="schedule-timeline" id="memberScheduleTimeline">
                        <!-- Généré par JavaScript -->
                    </div>
                </div>

                <!-- Statistiques -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalWeeks">52</h3>
                        <p>Semaines Total</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="assignedWeeks">0</h3>
                        <p>Semaines Assignées</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="conflictWeeks">0</h3>
                        <p>Conflits Détectés</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="progressPercent">0%</h3>
                        <p>Avancement</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="equityScore">-</h3>
                        <p>Équité (/10)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="vacationWeeks">0</h3>
                        <p>Périodes Vacances</p>
                    </div>
                </div>

                <!-- Liste des conflits détaillée (cachée par défaut) -->
                <div class="conflicts-dashboard" id="conflictsPanel" style="display: none;">
                    <div class="dashboard-header">
                        <h2>📊 Détail des Conflits Détectés</h2>
                        <button class="btn btn-primary" onclick="refreshConflicts()">🔄 Actualiser</button>
                    </div>
                    <div class="conflicts-list" id="conflictsList">
                        <!-- Généré par JavaScript -->
                    </div>
                </div>

                <!-- Légende -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color assigned"></div>
                        <span>Assignée</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color vacation"></div>
                        <span>Vacances</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color conflict"></div>
                        <span>Conflit</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color unassigned"></div>
                        <span>Non assignée</span>
                    </div>
                </div>

                <!-- Calendrier avec détection de conflits -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h2>Planning Annuel <span id="displayYear">2025</span></h2>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; color: #e65100;">
                        ⚠️ <strong>Détection automatique des conflits activée</strong> - Les semaines avec conflits apparaissent en rouge avec animation
                    </div>
                    
                    <div class="calendar-scroll-container">
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Généré par JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Équipe détaillée -->
                <div class="team-panel">
                    <h2 style="margin-bottom: 25px; color: #2c3e50;">📊 Statistiques d'Équipe</h2>
                    <div class="team-grid" id="teamGrid">
                        <!-- Généré par JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="assignmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>➕ Assigner une Semaine</h2>
                <span class="close" onclick="closeModal('assignmentModal')">&times;</span>
            </div>
            <form id="assignmentForm">
                <div class="form-group">
                    <label>Semaine :</label>
                    <input type="week" id="weekInput" required>
                </div>
                
                <div class="form-group">
                    <label>Binôme :</label>
                    <div class="binome-selector">
                        <select id="member1" required>
                            <option value="">Sélectionner...</option>
                        </select>
                        <select id="member2" required>
                            <option value="">Sélectionner...</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Backup :</label>
                    <select id="backupMember" required>
                        <option value="">Sélectionner...</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                    <button type="button" class="btn btn-danger" onclick="closeModal('assignmentModal')">Annuler</button>
                    <button type="submit" class="btn btn-success">Assigner</button>
                </div>
            </form>
        </div>
    </div>

    <div id="vacationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🏖️ Gérer les Vacances</h2>
                <span class="close" onclick="closeModal('vacationModal')">&times;</span>
            </div>
            <form id="vacationForm">
                <div class="form-group">
                    <label>Membre de l'équipe :</label>
                    <select id="vacationMember" required>
                        <option value="">Sélectionner...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Date de début :</label>
                    <input type="date" id="vacationStart" required>
                </div>
                
                <div class="form-group">
                    <label>Date de fin :</label>
                    <input type="date" id="vacationEnd" required>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                    <button type="button" class="btn btn-danger" onclick="closeModal('vacationModal')">Annuler</button>
                    <button type="submit" class="btn btn-success">Ajouter Vacances</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de conflit détaillé -->
    <div id="conflictModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">🔥 Conflit Détaillé</h2>
                <span class="close" onclick="closeConflictModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Contenu généré par JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal planning individuel -->
    <div id="memberScheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>👤 Planning Individuel</h2>
                <span class="close" onclick="closeModal('memberScheduleModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>Sélectionner un membre de l'équipe :</label>
                <select id="modalMemberSelect" onchange="showMemberScheduleInModal()">
                    <option value="">Choisir...</option>
                </select>
            </div>
            <div id="modalScheduleContent" style="max-height: 400px; overflow-y: auto;">
                <!-- Contenu généré par JavaScript -->
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-primary" onclick="exportMemberSchedule()">📅 Export ICS</button>
                <button class="btn btn-success" onclick="printMemberSchedule()">🖨️ Imprimer</button>
                <button class="btn btn-danger" onclick="closeModal('memberScheduleModal')">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION ET VARIABLES GLOBALES
        // ========================================
        
        // Configuration backend IA
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxpVjFoBroB1f-xkb6iKRr-Boc6DRyZ6MPFSK1PSeCwNKHNFrnnpqNnAfQZN9KzufrfCA/exec';
        let backendConnected = false;
        let aiChatHistory = [];
        
        // Configuration Hugging Face (optionnel)
        const HUGGINGFACE_API_KEY = ''; // Ajoutez votre clé API ici si vous voulez utiliser HF
        const HUGGINGFACE_MODEL = 'microsoft/DialoGPT-medium'; // ou autre modèle

        // Configuration de l'équipe
        const team = [
            'Référent 1', 'Référent 2', 'Référent 3', 'Référent 4', 'Référent 5',
            'Référent 6', 'Référent 7', 'Référent 8', 'Référent 9', 'Référent 10'
        ];

        // Binômes prédéfinis
        const predefinedBinomes = [
            ['Référent 1', 'Référent 2', 'Référent 10'],
            ['Référent 3', 'Référent 4', 'Référent 1'],
            ['Référent 5', 'Référent 6', 'Référent 2'],
            ['Référent 7', 'Référent 8', 'Référent 3'],
            ['Référent 9', 'Référent 10', 'Référent 5']
        ];

        let currentYear = 2025;
        let assignments = {};
        let vacations = {};
        let detectedConflicts = [];
        let alerts = [];

        // ========================================
        // NOUVELLES FONCTIONNALITÉS
        // ========================================

        // Planning individuel
        function showMemberScheduleModal() {
            const select = document.getElementById('modalMemberSelect');
            select.innerHTML = '<option value="">Choisir...</option>';
            team.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                select.appendChild(option);
            });
            document.getElementById('memberScheduleModal').style.display = 'block';
        }

        function showMemberScheduleInModal() {
            const member = document.getElementById('modalMemberSelect').value;
            if (!member) return;

            const content = document.getElementById('modalScheduleContent');
            content.innerHTML = getMemberScheduleHTML(member);
        }

        function getMemberScheduleHTML(member) {
            const schedule = getMemberSchedule(member);
            
            if (schedule.length === 0) {
                return '<p style="text-align: center; color: #666; padding: 20px;">Aucune assignation pour ce membre.</p>';
            }

            return `
                <h3 style="margin-bottom: 15px;">Planning de ${member} - ${currentYear}</h3>
                <div style="display: grid; gap: 10px;">
                    ${schedule.map(item => `
                        <div class="schedule-item ${item.type}">
                            <div class="schedule-date">Semaine ${item.week}</div>
                            <div class="schedule-role">
                                <strong>${item.role}</strong>
                                ${item.partners ? `<div class="schedule-partners">Avec : ${item.partners.join(', ')}</div>` : ''}
                                <div style="font-size: 0.8em; color: #666;">${item.dates}</div>
                                ${item.hasConflict ? '<div style="color: #e74c3c; font-weight: bold; font-size: 0.8em;">⚠️ Conflit détecté</div>' : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4>Résumé</h4>
                    <p>• Assignations principales : ${schedule.filter(s => s.role === 'Principal').length}</p>
                    <p>• Assignations backup : ${schedule.filter(s => s.role === 'Backup').length}</p>
                    <p>• Périodes de vacances : ${vacations[member]?.length || 0}</p>
                    <p>• Conflits détectés : ${schedule.filter(s => s.hasConflict).length}</p>
                </div>
            `;
        }

        function getMemberSchedule(member) {
            const schedule = [];

            // Parcourir toutes les assignations
            Object.entries(assignments).forEach(([weekKey, assignment]) => {
                const weekNum = parseInt(weekKey.split('-W')[1]);
                const weekStart = getDateFromWeek(currentYear, weekNum);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                const hasConflict = detectedConflicts.some(c => c.id === weekKey);

                if (assignment.member1 === member || assignment.member2 === member) {
                    const partners = [assignment.member1, assignment.member2].filter(m => m !== member);
                    schedule.push({
                        week: weekNum,
                        dates: `${formatDate(weekStart)} - ${formatDate(weekEnd)}`,
                        role: 'Principal',
                        partners: partners,
                        type: hasConflict ? 'conflict' : 'assigned',
                        hasConflict: hasConflict
                    });
                } else if (assignment.backup === member) {
                    schedule.push({
                        week: weekNum,
                        dates: `${formatDate(weekStart)} - ${formatDate(weekEnd)}`,
                        role: 'Backup',
                        partners: [assignment.member1, assignment.member2],
                        type: hasConflict ? 'conflict' : 'backup',
                        hasConflict: hasConflict
                    });
                }
            });

            // Ajouter les vacances
            if (vacations[member]) {
                vacations[member].forEach(vacation => {
                    const start = new Date(vacation.start);
                    const end = new Date(vacation.end);
                    const weekNum = getWeekNumber(start);
                    
                    schedule.push({
                        week: weekNum,
                        dates: `${formatDate(start)} - ${formatDate(end)}`,
                        role: 'Vacances',
                        type: 'vacation',
                        hasConflict: false
                    });
                });
            }

            // Trier par numéro de semaine
            schedule.sort((a, b) => a.week - b.week);

            return schedule;
        }

        function displayMemberSchedule() {
            const member = document.getElementById('memberScheduleSelect').value;
            if (!member) return;

            const timeline = document.getElementById('memberScheduleTimeline');
            timeline.innerHTML = getMemberScheduleHTML(member);
        }

        function closeMemberSchedule() {
            document.getElementById('memberSchedulePanel').style.display = 'none';
        }

        function printMemberSchedule() {
            const member = document.getElementById('modalMemberSelect').value || document.getElementById('memberScheduleSelect').value;
            if (!member) {
                showNotification('Veuillez sélectionner un membre', 'warning');
                return;
            }

            const content = getMemberScheduleHTML(member);
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Planning ${member} - ${currentYear}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .schedule-item { margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Export vers formats calendrier
        function exportCalendar() {
            showNotification('Export du calendrier en cours...', 'info');
            
            // Créer le fichier ICS
            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Planning Manager//FR',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH'
            ];

            Object.entries(assignments).forEach(([weekKey, assignment]) => {
                const weekNum = parseInt(weekKey.split('-W')[1]);
                const weekStart = getDateFromWeek(currentYear, weekNum);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                const event = [
                    'BEGIN:VEVENT',
                    `DTSTART:${formatDateICS(weekStart)}`,
                    `DTEND:${formatDateICS(weekEnd)}`,
                    `SUMMARY:Équipe: ${assignment.member1} + ${assignment.member2}`,
                    `DESCRIPTION:Backup: ${assignment.backup}`,
                    `UID:${weekKey}@planning-manager`,
                    'END:VEVENT'
                ];

                icsContent = icsContent.concat(event);
            });

            icsContent.push('END:VCALENDAR');

            const blob = new Blob([icsContent.join('\r\n')], { type: 'text/calendar' });
            downloadFile(blob, `planning-${currentYear}.ics`);
            
            showNotification('✅ Calendrier exporté !', 'success');
        }

        function exportMemberSchedule() {
            const member = document.getElementById('modalMemberSelect').value;
            if (!member) {
                showNotification('Veuillez sélectionner un membre', 'warning');
                return;
            }

            const schedule = getMemberSchedule(member);
            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Planning Manager//FR',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH'
            ];

            schedule.forEach(item => {
                if (item.role !== 'Vacances') {
                    const weekStart = getDateFromWeek(currentYear, item.week);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);

                    const event = [
                        'BEGIN:VEVENT',
                        `DTSTART:${formatDateICS(weekStart)}`,
                        `DTEND:${formatDateICS(weekEnd)}`,
                        `SUMMARY:${item.role} - Semaine ${item.week}`,
                        `DESCRIPTION:${item.partners ? 'Avec: ' + item.partners.join(', ') : ''}`,
                        `UID:${member}-week${item.week}@planning-manager`,
                        'END:VEVENT'
                    ];

                    icsContent = icsContent.concat(event);
                }
            });

            icsContent.push('END:VCALENDAR');

            const blob = new Blob([icsContent.join('\r\n')], { type: 'text/calendar' });
            downloadFile(blob, `planning-${member.replace(' ', '-')}-${currentYear}.ics`);
            
            showNotification(`✅ Planning de ${member} exporté !`, 'success');
        }

        function formatDateICS(date) {
            return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        }

        // Export Excel
        function exportToExcel() {
            showNotification('Génération du fichier Excel...', 'info');

            // Créer un tableau pour Excel
            const data = [
                ['PLANNING ANNUEL ' + currentYear],
                [],
                ['Semaine', 'Dates', 'Membre 1', 'Membre 2', 'Backup', 'Conflits']
            ];

            for (let week = 1; week <= 52; week++) {
                const weekKey = `${currentYear}-W${week}`;
                const weekStart = getDateFromWeek(currentYear, week);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                const assignment = assignments[weekKey];
                const conflict = detectedConflicts.find(c => c.id === weekKey);
                
                data.push([
                    `Semaine ${week}`,
                    `${formatDate(weekStart)} - ${formatDate(weekEnd)}`,
                    assignment?.member1 || '',
                    assignment?.member2 || '',
                    assignment?.backup || '',
                    conflict ? `${conflict.severity.toUpperCase()} - ${conflict.conflicts.length} conflit(s)` : ''
                ]);
            }

            // Ajouter une feuille pour les statistiques
            data.push([]);
            data.push(['STATISTIQUES']);
            data.push(['Membre', 'Assignations Principales', 'Assignations Backup', 'Jours de Vacances', 'Charge (%)']);
            
            team.forEach(member => {
                const stats = getTeamMemberStats(member);
                data.push([
                    member,
                    stats.assigned,
                    stats.backup,
                    stats.vacationDays,
                    stats.workload
                ]);
            });

            // Convertir en CSV pour Excel
            downloadCSV(data, `planning-complet-${currentYear}.csv`);
            
            showNotification('✅ Fichier Excel généré !', 'success');
        }

        // Import/Export JSON
        function exportJSON() {
            const data = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                year: currentYear,
                assignments: assignments,
                vacations: vacations,
                team: team,
                predefinedBinomes: predefinedBinomes
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            downloadFile(blob, `planning-backup-${currentYear}-${new Date().toISOString().split('T')[0]}.json`);
            
            showNotification('✅ Sauvegarde JSON créée !', 'success');
        }

        function importJSON(event) {
            importJSONWithValidation(event);
        }

        // Export CSV complet
        function exportCSV() {
            const data = [
                ['PLANNING SAUVEGARDE'],
                ['Date export', new Date().toLocaleString('fr-FR')],
                ['Année', currentYear],
                [],
                ['ASSIGNATIONS'],
                ['Semaine', 'Membre 1', 'Membre 2', 'Backup']
            ];

            Object.entries(assignments).forEach(([weekKey, assignment]) => {
                const weekNum = weekKey.split('-W')[1];
                data.push([
                    weekNum,
                    assignment.member1,
                    assignment.member2,
                    assignment.backup
                ]);
            });

            data.push([]);
            data.push(['VACANCES']);
            data.push(['Membre', 'Début', 'Fin']);

            Object.entries(vacations).forEach(([member, memberVacations]) => {
                memberVacations.forEach(vacation => {
                    data.push([member, vacation.start, vacation.end]);
                });
            });

            downloadCSV(data, `planning-sauvegarde-${currentYear}-${new Date().toISOString().split('T')[0]}.csv`);
            
            showNotification('✅ Sauvegarde CSV créée !', 'success');
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const lines = e.target.result.split('\n');
                    const newAssignments = {};
                    const newVacations = {};
                    let section = '';
                    let year = currentYear;

                    lines.forEach(line => {
                        const cells = line.split(',').map(cell => cell.trim());
                        
                        if (cells[0] === 'Année' && cells[1]) {
                            year = parseInt(cells[1]);
                        } else if (cells[0] === 'ASSIGNATIONS') {
                            section = 'assignments';
                        } else if (cells[0] === 'VACANCES') {
                            section = 'vacations';
                        } else if (section === 'assignments' && cells[0] && !isNaN(cells[0])) {
                            const weekNum = parseInt(cells[0]);
                            if (cells[1] && cells[2] && cells[3]) {
                                newAssignments[`${year}-W${weekNum}`] = {
                                    member1: cells[1],
                                    member2: cells[2],
                                    backup: cells[3]
                                };
                            }
                        } else if (section === 'vacations' && cells[0] && cells[0] !== 'Membre') {
                            const member = cells[0];
                            if (!newVacations[member]) {
                                newVacations[member] = [];
                            }
                            if (cells[1] && cells[2]) {
                                newVacations[member].push({
                                    start: cells[1],
                                    end: cells[2]
                                });
                            }
                        }
                    });

                    if (confirm(`Importer les données ?\nCeci remplacera toutes les données actuelles.`)) {
                        currentYear = year;
                        assignments = newAssignments;
                        vacations = newVacations;
                        
                        saveToStorage();
                        generateCalendar();
                        generateTeamGrid();
                        updateStats();
                        detectConflictsAuto();
                        
                        showNotification('✅ Données CSV importées !', 'success');
                    }
                } catch (error) {
                    showNotification('❌ Erreur lors de l\'import CSV : ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function showDataManagement() {
            const section = document.getElementById('dataManagementSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function downloadFile(blob, filename) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ========================================
        // GESTION DES CONFLITS INTÉGRÉE
        // ========================================

        function detectConflictsAuto() {
            showNotification('🔍 Détection des conflits en cours...', 'info');
            
            detectedConflicts = [];
            alerts = [];
            
            // Détecter les conflits de vacances
            Object.entries(assignments).forEach(([weekKey, assignment]) => {
                const weekNum = parseInt(weekKey.split('-W')[1]);
                const weekStart = getDateFromWeek(currentYear, weekNum);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                const conflicts = [];
                
                // Vérifier les conflits pour chaque membre du binôme
                [assignment.member1, assignment.member2, assignment.backup].forEach(member => {
                    if (vacations[member]) {
                        vacations[member].forEach(vacation => {
                            const vacStart = new Date(vacation.start);
                            const vacEnd = new Date(vacation.end);
                            
                            if (weekStart <= vacEnd && weekEnd >= vacStart) {
                                conflicts.push({
                                    member: member,
                                    reason: 'Congés',
                                    dates: `${vacation.start} - ${vacation.end}`,
                                    severity: member === assignment.backup ? 'warning' : 'critical'
                                });
                            }
                        });
                    }
                });
                
                if (conflicts.length > 0) {
                    const severity = conflicts.some(c => c.severity === 'critical') ? 'critical' : 
                                   conflicts.length > 1 ? 'moderate' : 'warning';
                    
                    const conflict = {
                        id: weekKey,
                        week: weekNum,
                        dates: `${formatDate(weekStart)} - ${formatDate(weekEnd)}`,
                        severity: severity,
                        assigned: [assignment.member1, assignment.member2],
                        backup: assignment.backup,
                        conflicts: conflicts,
                        coverage: calculateCoverage(conflicts, assignment),
                        impact: getImpactDescription(severity, conflicts.length),
                        solutions: generateSolutions(weekKey, assignment, conflicts)
                    };
                    
                    detectedConflicts.push(conflict);
                    
                    // Générer une alerte
                    alerts.push({
                        type: severity === 'critical' ? 'urgent' : 'warning',
                        icon: severity === 'critical' ? '🚨' : '⚠️',
                        title: `Conflit ${severity} détecté`,
                        description: `Semaine ${weekNum} - ${conflicts.length} membre(s) indisponible(s)`,
                        time: 'À l\'instant',
                        weekKey: weekKey
                    });
                }
            });
            
            // Détecter les problèmes d'équité
            const equityIssues = detectEquityIssues();
            equityIssues.forEach(issue => {
                alerts.push({
                    type: 'info',
                    icon: '⚖️',
                    title: 'Problème d\'équité détecté',
                    description: issue.description,
                    time: 'Analyse continue'
                });
            });
            
            updateConflictStats();
            generateAlertsTimeline();
            generateSolutions();
            generateCalendar(); // Redessiner le calendrier avec les conflits
            
            const conflictCount = detectedConflicts.length;
            showNotification(`✅ Scan terminé: ${conflictCount} conflit(s) détecté(s)`, 
                           conflictCount > 0 ? 'warning' : 'success');
        }

        function calculateCoverage(conflicts, assignment) {
            const totalMembers = 3; // binôme + backup
            const unavailableMembers = conflicts.length;
            const availableMembers = totalMembers - unavailableMembers;
            return Math.round((availableMembers / totalMembers) * 100);
        }

        function getImpactDescription(severity, conflictCount) {
            if (severity === 'critical') {
                return conflictCount > 1 ? 'Service compromis' : 'Charge accrue sur l\'équipe';
            } else if (severity === 'moderate') {
                return 'Réorganisation nécessaire';
            } else {
                return 'Impact mineur - Surveillance requise';
            }
        }

        function generateSolutions(weekKey, assignment, conflicts) {
            const solutions = [];
            const weekNum = parseInt(weekKey.split('-W')[1]);
            
            // Solution 1: Réassignation automatique
            const availableMembers = team.filter(member => 
                !conflicts.some(c => c.member === member) &&
                member !== assignment.member1 && 
                member !== assignment.member2 && 
                member !== assignment.backup
            );
            
            if (availableMembers.length >= 2) {
                solutions.push({
                    type: 'optimal',
                    score: 95,
                    title: `Réassigner ${availableMembers[0]} + ${availableMembers[1]}`,
                    details: 'Membres disponibles identifiés, réassignation possible',
                    action: 'reassign',
                    data: { member1: availableMembers[0], member2: availableMembers[1], backup: availableMembers[2] || assignment.backup }
                });
            }
            
            // Solution 2: Décaler les congés
            const vacationConflicts = conflicts.filter(c => c.reason === 'Congés');
            if (vacationConflicts.length > 0) {
                solutions.push({
                    type: 'good',
                    score: 78,
                    title: 'Négocier report de congés',
                    details: `Demander à ${vacationConflicts[0].member} de décaler ses congés`,
                    action: 'negotiate',
                    data: { member: vacationConflicts[0].member, week: weekNum }
                });
            }
            
            // Solution 3: Backup alternatif
            const availableBackups = team.filter(member => 
                !conflicts.some(c => c.member === member) &&
                member !== assignment.member1 && 
                member !== assignment.member2
            );
            
            if (availableBackups.length > 0) {
                solutions.push({
                    type: 'fallback',
                    score: 65,
                    title: `Backup alternatif: ${availableBackups[0]}`,
                    details: 'Solution de secours avec surveillance accrue',
                    action: 'backup_change',
                    data: { newBackup: availableBackups[0] }
                });
            }
            
            return solutions;
        }

        function detectEquityIssues() {
            const issues = [];
            const memberStats = {};
            
            // Calculer les statistiques pour chaque membre
            team.forEach(member => {
                memberStats[member] = getTeamMemberStats(member);
            });
            
            // Détecter les déséquilibres
            const avgAssignments = Object.values(memberStats).reduce((sum, stats) => sum + stats.assigned, 0) / team.length;
            
            Object.entries(memberStats).forEach(([member, stats]) => {
                if (stats.assigned > avgAssignments * 1.3) {
                    issues.push({
                        member: member,
                        type: 'overload',
                        description: `${member} est surchargé (${stats.assigned} vs ${Math.round(avgAssignments)} attendu)`
                    });
                } else if (stats.assigned < avgAssignments * 0.7 && avgAssignments > 2) {
                    issues.push({
                        member: member,
                        type: 'underload',
                        description: `${member} est sous-utilisé (${stats.assigned} vs ${Math.round(avgAssignments)} attendu)`
                    });
                }
            });
            
            return issues;
        }

        function updateConflictStats() {
            const critical = detectedConflicts.filter(c => c.severity === 'critical').length;
            const moderate = detectedConflicts.filter(c => c.severity === 'moderate').length;
            const warning = detectedConflicts.filter(c => c.severity === 'warning').length;
            const upcoming = detectedConflicts.filter(c => {
                const currentWeek = getCurrentWeek();
                return c.week > currentWeek && c.week <= currentWeek + 4;
            }).length;

            document.getElementById('criticalCount').textContent = critical;
            document.getElementById('moderateCount').textContent = moderate;
            document.getElementById('warningCount').textContent = warning;
            document.getElementById('upcomingCount').textContent = upcoming;
        }

        function generateAlertsTimeline() {
            const container = document.getElementById('alertsTimeline');
            container.innerHTML = '';

            if (alerts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; font-style: italic; padding: 20px;">Aucune alerte active</div>';
                return;
            }

            alerts.slice(0, 5).forEach((alert, index) => {
                const alertElement = document.createElement('div');
                alertElement.className = `alert-item ${alert.type}`;
                alertElement.style.animationDelay = `${index * 0.1}s`;

                alertElement.innerHTML = `
                    <div class="alert-icon">${alert.icon}</div>
                    <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-description">${alert.description}</div>
                        <div class="alert-time">${alert.time}</div>
                    </div>
                `;

                // Ajouter un clic pour aller au conflit
                if (alert.weekKey) {
                    alertElement.style.cursor = 'pointer';
                    alertElement.onclick = () => showConflictDetails(alert.weekKey);
                }

                container.appendChild(alertElement);
            });
        }

        function generateSolutions() {
            const container = document.getElementById('solutionsList');
            
            if (detectedConflicts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: white; opacity: 0.8; padding: 15px;">Aucun conflit détecté</div>';
                return;
            }

            // Prendre les solutions du conflit le plus critique
            const criticalConflict = detectedConflicts.find(c => c.severity === 'critical') || detectedConflicts[0];
            
            container.innerHTML = criticalConflict.solutions.slice(0, 3).map((solution, idx) => `
                <div class="solution-item" onclick="applySolution('${criticalConflict.id}', ${idx})">
                    <div class="solution-header">
                        <span>${solution.title}</span>
                        <span class="solution-score ${solution.type}">${solution.score}%</span>
                    </div>
                    <div class="solution-details">${solution.details}</div>
                </div>
            `).join('');
        }

        function showConflictsList() {
            const panel = document.getElementById('conflictsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            
            if (panel.style.display === 'block') {
                generateConflictsList();
            }
        }

        function generateConflictsList() {
            const container = document.getElementById('conflictsList');
            container.innerHTML = '';

            if (detectedConflicts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; font-style: italic; padding: 30px;">Aucun conflit détecté. Excellent travail ! 🎉</div>';
                return;
            }

            detectedConflicts.forEach((conflict, index) => {
                const conflictElement = createConflictElement(conflict, index);
                container.appendChild(conflictElement);
            });
        }

        function createConflictElement(conflict, index) {
            const div = document.createElement('div');
            div.className = `conflict-item ${conflict.severity}`;
            div.style.animationDelay = `${index * 0.1}s`;

            div.innerHTML = `
                <div class="conflict-header" onclick="toggleConflictDetails('${conflict.id}')">
                    <div>
                        <div class="conflict-title">📅 Semaine ${conflict.week} • ${conflict.dates}</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 3px;">
                            Équipe: ${conflict.assigned.join(' + ')} | Backup: ${conflict.backup}
                        </div>
                    </div>
                    <div class="conflict-severity ${conflict.severity}">
                        ${conflict.severity.toUpperCase()}
                    </div>
                </div>
                <div class="conflict-details" id="details-${conflict.id}">
                    ${generateConflictDetails(conflict)}
                </div>
            `;

            return div;
        }

        function generateConflictDetails(conflict) {
            return `
                <div style="margin-bottom: 15px;">
                    <h4>⚡ Analyse d'Impact</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 8px;">
                        <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                            <div style="font-weight: bold; color: #e67e22;">${conflict.severity.toUpperCase()}</div>
                            <div style="font-size: 0.8em;">Sévérité</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                            <div style="font-weight: bold; color: ${conflict.coverage < 50 ? '#e74c3c' : conflict.coverage < 75 ? '#f39c12' : '#27ae60'}">
                                ${conflict.coverage}%
                            </div>
                            <div style="font-size: 0.8em;">Couverture</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                            <div style="font-weight: bold; color: #3498db;">${conflict.conflicts.length}</div>
                            <div style="font-size: 0.8em;">Conflits</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <strong>Impact:</strong> ${conflict.impact}
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <h4>🏖️ Détail des Conflits</h4>
                    <div style="margin-top: 8px;">
                        ${conflict.conflicts.map(c => `
                            <div style="background: #fff3e0; padding: 8px; border-radius: 4px; margin-bottom: 5px; border-left: 3px solid #f39c12;">
                                <strong>${c.member}</strong> - ${c.reason} (${c.dates})
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <h4>🤖 Solutions Recommandées</h4>
                    <div style="margin-top: 8px;">
                        ${conflict.solutions.map((solution, idx) => `
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; border: 1px solid #dee2e6;" onclick="applySolution('${conflict.id}', ${idx})">
                                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 5px;">
                                    <strong style="flex: 1;">${solution.title}</strong>
                                    <span style="background: ${solution.type === 'optimal' ? '#4caf50' : solution.type === 'good' ? '#ff9800' : '#f44336'}; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.7em;">
                                        ${solution.score}%
                                    </span>
                                </div>
                                <div style="font-size: 0.8em; color: #666;">${solution.details}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-success" style="font-size: 0.8em; padding: 6px 12px;" onclick="applySolution('${conflict.id}', 0)">
