<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Manager Pro - Gestion Compl√®te</title>
    <style>
        /* Reset et styles de base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 20px;
            font-weight: bold;
            color: white;
        }

        .year-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .year-btn:hover {
            background: white;
            color: #764ba2;
        }

        /* Toolbar */
        .toolbar {
            background: #2c3e50;
            padding: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
        }

        .danger-zone {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            border-radius: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-primary { background: #3498db; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-dark { background: #34495e; color: white; }

        /* Tabs */
        .tabs-container {
            padding: 30px;
        }

        .tabs-nav {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-btn.manager-tab {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 12px 20px;
            border-radius: 8px 8px 0 0;
            margin-left: auto;
        }

        .tab-btn.manager-tab:hover {
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Metrics Dashboard */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
            transition: transform 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card.critical {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .metric-card.warning {
            border-left-color: #f39c12;
            background: #fffbf0;
        }

        .metric-card.success {
            border-left-color: #27ae60;
            background: #f0fff4;
        }

        .metric-value {
            font-size: 36px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .metric-label {
            color: #7f8c8d;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-trend {
            margin-top: 10px;
            font-size: 12px;
            color: #95a5a6;
        }

        /* Config Panel */
        .config-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .config-label {
            font-weight: bold;
            color: #2c3e50;
        }

        .config-input {
            padding: 8px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            width: 100px;
            text-align: center;
            font-weight: bold;
        }

        /* Conflict Panel */
        .conflict-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .conflict-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .severity-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .severity-1 { background: #fff3cd; color: #856404; }
        .severity-2 { background: #ffeaa7; color: #d68910; }
        .severity-3 { background: #ffcccc; color: #c0392b; }

        /* Stats bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid transparent;
        }

        .stat-box.good { border-color: #27ae60; }
        .stat-box.warning { border-color: #f39c12; }
        .stat-box.danger { border-color: #e74c3c; }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        /* Calendar views */
        .calendar-year {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .month-block {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .month-header {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .weeks-container {
            padding: 10px;
        }

        .week-row {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .week-row:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .week-row.assigned {
            background: #e8f5e9;
            border-left: 4px solid #27ae60;
        }

        .week-row.conflict {
            background: #ffebee;
            border-left: 4px solid #e74c3c;
            font-weight: bold;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: 15px;
            position: relative;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 20px 30px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 2000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: linear-gradient(135deg, #27ae60, #229954); }
        .notification.error { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .notification.warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .notification.info { background: linear-gradient(135deg, #3498db, #2980b9); }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Planning Manager Pro</h1>
            <div class="year-selector">
                <button class="year-btn" onclick="changeYear(-1)">‚óÄ</button>
                <span id="currentYear">2025</span>
                <button class="year-btn" onclick="changeYear(1)">‚ñ∂</button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="autoFillWithBalance()">‚ö° Remplissage Intelligent</button>
                <button class="btn btn-primary" onclick="showAssignModal()">‚ûï Assigner Semaine</button>
                <button class="btn btn-warning" onclick="showVacationModal()">üèñÔ∏è Ajouter Absence</button>
                <button class="btn btn-info" onclick="exportAll()">üíæ Export JSON</button>
                <button class="btn btn-info" onclick="showImportModal()">üì• Import JSON</button>
                <button class="btn btn-info" onclick="exportCalendars()">üìÖ Export Calendriers</button>
                <button class="btn btn-dark" onclick="showTeamEditModal()">üë• √âditer √âquipe</button>
            </div>
            <div class="danger-zone">
                <span style="color: #e74c3c; font-weight: bold; align-self: center;">‚ö†Ô∏è ZONE DANGER:</span>
                <button class="btn btn-danger" onclick="confirmReboot()">üîÑ REBOOT TOTAL</button>
                <button class="btn btn-danger" onclick="clearAllVacations()">üóëÔ∏è Effacer Absences</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="tabs-container">
            <!-- Tabs Navigation -->
            <div class="tabs-nav">
                <button class="tab-btn active" onclick="switchTab(event, 'planning')">üìÖ Planning</button>
                <button class="tab-btn" onclick="switchTab(event, 'absences')">üèñÔ∏è Absences</button>
                <button class="tab-btn" onclick="switchTab(event, 'conflicts')">‚ö†Ô∏è Conflits</button>
                <button class="tab-btn" onclick="switchTab(event, 'team')">üë• √âquipe</button>
                <button class="tab-btn" onclick="switchTab(event, 'importexport')">üì§ Import/Export</button>
                <button class="tab-btn manager-tab" onclick="switchTab(event, 'management')">üéØ GESTION MANAG√âRIALE</button>
            </div>

            <!-- Planning Tab -->
            <div id="planningTab" class="tab-content active">
                <div class="stats-bar">
                    <div class="stat-box good">
                        <div class="stat-number" id="weeksAssigned">0</div>
                        <div class="stat-label">Semaines Assign√©es</div>
                    </div>
                    <div class="stat-box warning">
                        <div class="stat-number" id="totalAbsences">0</div>
                        <div class="stat-label">P√©riodes d'Absence</div>
                    </div>
                    <div class="stat-box danger">
                        <div class="stat-number" id="conflictsCount">0</div>
                        <div class="stat-label">Conflits Actifs</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="progressPercent">0%</div>
                        <div class="stat-label">Progression</div>
                    </div>
                </div>

                <div class="calendar-year" id="yearView">
                    <!-- G√©n√©r√© dynamiquement -->
                </div>
            </div>

            <!-- Absences Tab -->
            <div id="absencesTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">Gestion des Absences</h2>
                <div id="absencesContainer">
                    <!-- G√©n√©r√© dynamiquement -->
                </div>
            </div>

            <!-- Conflicts Tab -->
            <div id="conflictsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">Centre de R√©solution des Conflits</h2>
                <button class="btn btn-danger" style="margin-bottom: 20px;" onclick="resolveAllConflicts()">
                    üîß R√©soudre Tous Automatiquement
                </button>
                <div id="conflictList">
                    <!-- G√©n√©r√© dynamiquement -->
                </div>
            </div>

            <!-- Team Tab -->
            <div id="teamTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">Tableau de l'√âquipe</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>R√©f√©rent</th>
                            <th>Semaines Principal</th>
                            <th>Semaines Backup</th>
                            <th>Jours Absence</th>
                            <th>Charge (%)</th>
                            <th>Score √âquilibre</th>
                        </tr>
                    </thead>
                    <tbody id="teamTableBody">
                        <!-- G√©n√©r√© dynamiquement -->
                    </tbody>
                </table>
            </div>

            <!-- Import/Export Tab -->
            <div id="importexportTab" class="tab-content">
                <h2 style="margin-bottom: 30px; color: #2c3e50;">üì§ Centre d'Import/Export</h2>
                
                <!-- Section Export -->
                <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #ecf0f1;">
                        üì§ Export des Donn√©es
                    </h3>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Export JSON -->
                        <div style="border: 2px solid #3498db; border-radius: 10px; padding: 20px; background: linear-gradient(to right, white, #3498db15);">
                            <h4 style="color: #3498db; margin-bottom: 10px;">üíæ Export JSON Complet</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                Sauvegarde compl√®te du planning incluant toutes les assignations, absences, configuration et noms d'√©quipe.
                                Format id√©al pour les backups et le partage.
                            </p>
                            <button class="btn btn-primary" onclick="exportAll()" style="width: 100%;">
                                üíæ T√©l√©charger le fichier JSON
                            </button>
                        </div>
                        
                        <!-- Export Calendriers -->
                        <div style="border: 2px solid #27ae60; border-radius: 10px; padding: 20px; background: linear-gradient(to right, white, #27ae6015);">
                            <h4 style="color: #27ae60; margin-bottom: 10px;">üìÖ Export Calendriers Individuels</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                G√©n√®re un fichier .ics pour chaque membre de l'√©quipe avec ses p√©riodes de piquet et absences.
                                Compatible avec Outlook, Google Calendar, Apple Calendar, etc.
                            </p>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                                <small style="color: #666;">
                                    <strong>Contenu des calendriers :</strong><br>
                                    ‚Ä¢ üü¢ Semaines en tant que r√©f√©rent principal<br>
                                    ‚Ä¢ üü† Semaines en tant que backup<br>
                                    ‚Ä¢ üèñÔ∏è P√©riodes d'absence<br>
                                    ‚Ä¢ ‚è∞ Rappels automatiques (J-1)
                                </small>
                            </div>
                            <button class="btn btn-success" onclick="exportCalendars()" style="width: 100%;">
                                üìÖ G√©n√©rer les ${TEAM.length} calendriers
                            </button>
                        </div>
                        
                        <!-- Export Excel/CSV -->
                        <div style="border: 2px solid #f39c12; border-radius: 10px; padding: 20px; background: linear-gradient(to right, white, #f39c1215);">
                            <h4 style="color: #f39c12; margin-bottom: 10px;">üìä Export Excel/CSV</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                Export au format CSV pour analyse dans Excel ou Google Sheets.
                                Contient toutes les assignations de l'ann√©e en format tabulaire.
                            </p>
                            <button class="btn btn-warning" onclick="exportCSV()" style="width: 100%;">
                                üìä T√©l√©charger le fichier CSV
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Section Import -->
                <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #ecf0f1;">
                        üì• Import des Donn√©es
                    </h3>
                    
                    <div style="border: 2px solid #e74c3c; border-radius: 10px; padding: 20px; background: linear-gradient(to right, white, #e74c3c15);">
                        <h4 style="color: #e74c3c; margin-bottom: 10px;">üì• Import depuis JSON</h4>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffc107;">
                            <p style="margin: 0; color: #856404;">
                                <strong>‚ö†Ô∏è Attention :</strong> L'import remplacera TOUTES les donn√©es actuelles du planning.
                                Assurez-vous d'avoir une sauvegarde si n√©cessaire.
                            </p>
                        </div>
                        
                        <p style="color: #666; margin-bottom: 15px;">
                            Restaurez un planning pr√©c√©demment export√©. Le fichier doit √™tre au format JSON g√©n√©r√© par cette application.
                        </p>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <strong style="color: #2c3e50;">Donn√©es qui seront import√©es :</strong>
                            <ul style="margin: 10px 0 0 20px; color: #666;">
                                <li>Toutes les assignations de semaines</li>
                                <li>Toutes les p√©riodes d'absence</li>
                                <li>Les noms personnalis√©s de l'√©quipe</li>
                                <li>La configuration des seuils de gravit√©</li>
                                <li>L'ann√©e du planning</li>
                            </ul>
                        </div>
                        
                        <input type="file" 
                               id="importFileInput" 
                               accept=".json" 
                               style="display: none;"
                               onchange="handleDirectImport(this)">
                        
                        <button class="btn btn-danger" 
                                onclick="document.getElementById('importFileInput').click()" 
                                style="width: 100%;">
                            üì• S√©lectionner un fichier JSON √† importer
                        </button>
                    </div>
                </div>
                
                <!-- Historique -->
                <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-top: 30px;">
                    <h4 style="color: #666; margin-bottom: 15px;">üìù Informations Syst√®me</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Version :</strong> 3.1
                        </div>
                        <div>
                            <strong>Ann√©e en cours :</strong> ${currentYear}
                        </div>
                        <div>
                            <strong>Membres d'√©quipe :</strong> ${TEAM.length}
                        </div>
                        <div>
                            <strong>Derni√®re sauvegarde :</strong> <span id="lastSaveTime">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Management Tab -->
            <div id="managementTab" class="tab-content">
                <h2 style="margin-bottom: 30px; color: #2c3e50;">üéØ Tableau de Bord Manag√©rial</h2>
                
                <!-- M√©triques Essentielles -->
                <h3 style="margin-bottom: 20px;">üìà M√©triques Essentielles</h3>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="coverageRate">0%</div>
                        <div class="metric-label">Taux de Couverture</div>
                        <div class="metric-trend" id="coverageTrend">52 semaines totales</div>
                    </div>
                    <div class="metric-card critical" id="conflictCard">
                        <div class="metric-value" id="conflictCount">0</div>
                        <div class="metric-label">Conflits Actifs</div>
                        <div class="metric-trend" id="conflictTrend">√Ä r√©soudre</div>
                    </div>
                    <div class="metric-card warning">
                        <div class="metric-value" id="absenceRate">0%</div>
                        <div class="metric-label">Taux d'Absence Global</div>
                        <div class="metric-trend" id="absenceTrend">Sur l'ann√©e</div>
                    </div>
                    <div class="metric-card success">
                        <div class="metric-value" id="balanceScore">0</div>
                        <div class="metric-label">Score d'√âquilibre</div>
                        <div class="metric-trend">√âcart min-max</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgWorkload">0</div>
                        <div class="metric-label">Charge Moyenne</div>
                        <div class="metric-trend">Semaines/personne</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="criticalWeeks">0</div>
                        <div class="metric-label">Semaines Critiques</div>
                        <div class="metric-trend">Gravit√© ‚â• 2</div>
                    </div>
                </div>

                <!-- Configuration des Seuils -->
                <div class="config-panel">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">‚öôÔ∏è Configuration des Seuils de Gravit√©</h3>
                    <div class="config-item">
                        <span class="config-label">üü° Gravit√© 1 : Nombre de membres absents</span>
                        <input type="number" class="config-input" id="severity1" value="1" min="1" max="3">
                    </div>
                    <div class="config-item">
                        <span class="config-label">üü† Gravit√© 2 : Nombre de membres absents</span>
                        <input type="number" class="config-input" id="severity2" value="2" min="1" max="3">
                    </div>
                    <div class="config-item">
                        <span class="config-label">üî¥ Gravit√© 3 : Nombre de membres absents</span>
                        <input type="number" class="config-input" id="severity3" value="3" min="1" max="3">
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="applySeverityConfig()">
                        Appliquer Configuration
                    </button>
                </div>

                <!-- Analyse des Conflits -->
                <div class="conflict-panel">
                    <div class="conflict-header">
                        <h3>üö® Analyse D√©taill√©e des Conflits</h3>
                        <button class="btn btn-danger" onclick="resolveAllConflicts()">
                            üîß R√©solution Automatique Globale
                        </button>
                    </div>
                    <div id="managerConflictList">
                        <!-- G√©n√©r√© dynamiquement -->
                    </div>
                </div>

                <!-- Vue d'ensemble annuelle -->
                <div style="background: white; border-radius: 15px; padding: 25px; margin-top: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px;">üìä Vue d'Ensemble Annuelle</h3>
                    <div id="yearOverview">
                        <!-- G√©n√©r√© dynamiquement -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="assignModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assignModal')">&times;</span>
            <div class="modal-header">
                <h2>üìÖ Assigner une Semaine</h2>
            </div>
            <form onsubmit="saveAssignment(event)">
                <div class="form-group">
                    <label>Semaine</label>
                    <input type="week" id="weekInput" required>
                </div>
                <div class="form-group">
                    <label>Bin√¥me</label>
                    <div class="form-row">
                        <select id="member1" required>
                            <option value="">Membre 1</option>
                        </select>
                        <select id="member2" required>
                            <option value="">Membre 2</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Backup</label>
                    <select id="backup" required>
                        <option value="">S√©lectionner</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Enregistrer</button>
            </form>
        </div>
    </div>

    <div class="modal" id="vacationModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('vacationModal')">&times;</span>
            <div class="modal-header">
                <h2>üèñÔ∏è Ajouter une Absence</h2>
            </div>
            <form onsubmit="saveVacation(event)">
                <div class="form-group">
                    <label>R√©f√©rent</label>
                    <select id="vacationMember" required>
                        <option value="">S√©lectionner</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date de d√©but</label>
                    <input type="date" id="vacationStart" required>
                </div>
                <div class="form-group">
                    <label>Date de fin</label>
                    <input type="date" id="vacationEnd" required>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Enregistrer</button>
            </form>
        </div>
    </div>

    <!-- Modal Import JSON -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('importModal')">&times;</span>
            <div class="modal-header">
                <h2>üì• Importer un Planning</h2>
            </div>
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #ffc107;">
                <p style="margin: 0; color: #856404;">
                    <strong>‚ö†Ô∏è Attention :</strong> L'import remplacera TOUTES les donn√©es actuelles (assignations, absences, noms d'√©quipe, configuration).
                </p>
            </div>
            <form onsubmit="handleImport(event)">
                <div class="form-group">
                    <label>Fichier JSON</label>
                    <input type="file" id="importFile" accept=".json" required style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px;">
                </div>
                <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button type="button" class="btn btn-dark" onclick="closeModal('importModal')">
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-success">
                        üì• Importer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Edition Equipe -->
    <div class="modal" id="teamEditModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('teamEditModal')">&times;</span>
            <div class="modal-header">
                <h2>üë• √âditer les Noms des R√©f√©rents</h2>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; color: #666;">
                    <strong>üí° Conseil :</strong> Modifiez les noms des r√©f√©rents pour correspondre √† votre √©quipe r√©elle. 
                    Les modifications seront appliqu√©es partout dans l'application.
                </p>
            </div>
            <form onsubmit="saveTeamNames(event)">
                <div id="teamEditList" style="display: grid; gap: 10px;">
                    <!-- G√©n√©r√© dynamiquement -->
                </div>
                <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button type="button" class="btn btn-warning" onclick="resetTeamNames()">
                        üîÑ R√©initialiser les noms
                    </button>
                    <button type="submit" class="btn btn-success">
                        ‚úÖ Enregistrer les modifications
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Configuration
        let TEAM = [
            'R√©f√©rent 1', 'R√©f√©rent 2', 'R√©f√©rent 3', 'R√©f√©rent 4', 'R√©f√©rent 5',
            'R√©f√©rent 6', 'R√©f√©rent 7', 'R√©f√©rent 8', 'R√©f√©rent 9'
        ];

        // √âtat global
        let currentYear = new Date().getFullYear();
        let assignments = {};
        let vacations = {};
        let conflicts = [];
        let severityConfig = {
            level1: 1,
            level2: 2,
            level3: 3
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadData();
            populateSelects();
            updateAllDisplays();
            detectConflicts();
        }

        function loadData() {
            const saved = localStorage.getItem('planningData');
            if (saved) {
                const data = JSON.parse(saved);
                
                // Charger les noms de l'√©quipe si sauvegard√©s
                if (data.teamNames) {
                    TEAM = data.teamNames;
                    // S'assurer qu'on a exactement 9 membres
                    while (TEAM.length < 9) {
                        TEAM.push(`R√©f√©rent ${TEAM.length + 1}`);
                    }
                    while (TEAM.length > 9) {
                        TEAM.pop();
                    }
                }
                
                // Migrer les anciennes donn√©es avec les nouveaux noms si n√©cessaire
                const oldAssignments = data.assignments || {};
                const oldVacations = data.vacations || {};
                
                assignments = {};
                vacations = {};
                
                // Migrer les assignments
                Object.entries(oldAssignments).forEach(([key, value]) => {
                    assignments[key] = value;
                });
                
                // Migrer les vacations
                Object.entries(oldVacations).forEach(([key, value]) => {
                    // Ne garder que les vacations pour les 9 premiers membres
                    if (TEAM.includes(key) || TEAM.indexOf(key) < 9) {
                        vacations[key] = value;
                    }
                });
                
                currentYear = data.year || currentYear;
                severityConfig = data.severityConfig || severityConfig;
            }
            document.getElementById('currentYear').textContent = currentYear;
            
            // Mettre √† jour les inputs de configuration
            document.getElementById('severity1').value = severityConfig.level1;
            document.getElementById('severity2').value = severityConfig.level2;
            document.getElementById('severity3').value = severityConfig.level3;
        }

        function saveData() {
            const data = {
                year: currentYear,
                assignments: assignments,
                vacations: vacations,
                severityConfig: severityConfig,
                teamNames: TEAM,
                lastModified: new Date().toISOString()
            };
            localStorage.setItem('planningData', JSON.stringify(data));
        }

        function confirmReboot() {
            if (confirm('‚ö†Ô∏è ATTENTION: Cette action effacera TOUTES les donn√©es (assignations, absences, configurations).\n\n√ätes-vous s√ªr de vouloir continuer?')) {
                if (confirm('üî¥ DERNI√àRE CONFIRMATION: Toutes les donn√©es seront perdues d√©finitivement. Continuer?')) {
                    rebootSystem();
                }
            }
        }

        function rebootSystem() {
            assignments = {};
            vacations = {};
            conflicts = [];
            severityConfig = {
                level1: 1,
                level2: 2,
                level3: 3
            };
            
            saveData();
            updateAllDisplays();
            showNotification('üîÑ SYST√àME R√âINITIALIS√â - Toutes les donn√©es ont √©t√© effac√©es', 'warning');
        }

        function clearAllVacations() {
            if (confirm('‚ö†Ô∏è Effacer toutes les absences de tous les r√©f√©rents?')) {
                vacations = {};
                saveData();
                detectConflicts();
                updateAllDisplays();
                showNotification('üóëÔ∏è Toutes les absences ont √©t√© effac√©es', 'warning');
            }
        }

        function applySeverityConfig() {
            const s1 = parseInt(document.getElementById('severity1').value);
            const s2 = parseInt(document.getElementById('severity2').value);
            const s3 = parseInt(document.getElementById('severity3').value);
            
            if (s1 < s2 && s2 <= s3) {
                severityConfig = {
                    level1: s1,
                    level2: s2,
                    level3: s3
                };
                saveData();
                detectConflicts();
                updateAllDisplays();
                showNotification('‚úÖ Configuration des seuils appliqu√©e', 'success');
            } else {
                showNotification('‚ùå Les seuils doivent √™tre croissants (Gravit√© 1 < Gravit√© 2 ‚â§ Gravit√© 3)', 'error');
                // Restaurer les valeurs
                document.getElementById('severity1').value = severityConfig.level1;
                document.getElementById('severity2').value = severityConfig.level2;
                document.getElementById('severity3').value = severityConfig.level3;
            }
        }

        function detectConflicts() {
            conflicts = [];
            
            Object.entries(assignments).forEach(([weekKey, assignment]) => {
                const weekNum = parseInt(weekKey.split('-W')[1]);
                const year = parseInt(weekKey.split('-W')[0]);
                const weekDates = getWeekDates(year, weekNum);
                
                let weekConflicts = [];
                
                [assignment.member1, assignment.member2, assignment.backup].forEach(member => {
                    if (vacations[member]) {
                        vacations[member].forEach(vacation => {
                            const vacStart = new Date(vacation.start);
                            const vacEnd = new Date(vacation.end);
                            
                            if (datesOverlap(weekDates.start, weekDates.end, vacStart, vacEnd)) {
                                weekConflicts.push({
                                    week: weekNum,
                                    member: member,
                                    role: member === assignment.backup ? 'Backup' : 'Principal',
                                    vacationStart: vacation.start,
                                    vacationEnd: vacation.end
                                });
                            }
                        });
                    }
                });
                
                if (weekConflicts.length > 0) {
                    let severity = 1;
                    if (weekConflicts.length >= severityConfig.level3) {
                        severity = 3;
                    } else if (weekConflicts.length >= severityConfig.level2) {
                        severity = 2;
                    }
                    
                    weekConflicts.forEach(conflict => {
                        conflict.severity = severity;
                        conflict.totalAbsent = weekConflicts.length;
                        conflicts.push(conflict);
                    });
                }
            });
            
            return conflicts;
        }

        function updateAllDisplays() {
            updateStats();
            updateMetrics();
            updateConflictDisplay();
            updateTeamTable();
            updateYearView();
            updateAbsencesView();
            updateManagerialDashboard();
        }

        function updateStats() {
            const totalWeeks = 52;
            const assignedWeeks = Object.keys(assignments).filter(key => 
                key.startsWith(`${currentYear}-W`)
            ).length;
            
            const totalAbsences = Object.values(vacations).reduce((sum, v) => sum + v.length, 0);
            const conflictCount = [...new Set(conflicts.map(c => c.week))].length;
            const progress = Math.round((assignedWeeks / totalWeeks) * 100);
            
            document.getElementById('weeksAssigned').textContent = assignedWeeks;
            document.getElementById('totalAbsences').textContent = totalAbsences;
            document.getElementById('conflictsCount').textContent = conflictCount;
            document.getElementById('progressPercent').textContent = progress + '%';
        }

        function updateMetrics() {
            // Taux de couverture
            const totalWeeks = 52;
            const assignedWeeks = Object.keys(assignments).filter(key => 
                key.startsWith(`${currentYear}-W`)
            ).length;
            const coverageRate = Math.round((assignedWeeks / totalWeeks) * 100);
            
            document.getElementById('coverageRate').textContent = coverageRate + '%';
            document.getElementById('coverageTrend').textContent = `${assignedWeeks}/${totalWeeks} semaines`;
            
            // Conflits
            const uniqueConflictWeeks = [...new Set(conflicts.map(c => c.week))];
            document.getElementById('conflictCount').textContent = uniqueConflictWeeks.length;
            
            const severity3Count = uniqueConflictWeeks.filter(week => 
                conflicts.find(c => c.week === week && c.severity === 3)
            ).length;
            const severity2Count = uniqueConflictWeeks.filter(week => 
                conflicts.find(c => c.week === week && c.severity === 2)
            ).length;
            
            document.getElementById('conflictTrend').textContent = 
                severity3Count > 0 ? `${severity3Count} critiques` : 
                severity2Count > 0 ? `${severity2Count} majeurs` : 
                'Aucun critique';
            
            // Modifier la couleur de la carte
            const conflictCard = document.getElementById('conflictCard');
            if (conflictCard) {
                conflictCard.className = 'metric-card';
                if (uniqueConflictWeeks.length === 0) {
                    conflictCard.classList.add('success');
                } else if (severity3Count > 0) {
                    conflictCard.classList.add('critical');
                } else if (severity2Count > 0) {
                    conflictCard.classList.add('warning');
                }
            }
            
            // Taux d'absence
            let totalAbsenceDays = 0;
            Object.values(vacations).forEach(memberVacations => {
                memberVacations.forEach(vac => {
                    const days = Math.ceil((new Date(vac.end) - new Date(vac.start)) / (1000 * 60 * 60 * 24)) + 1;
                    totalAbsenceDays += days;
                });
            });
            const absenceRate = Math.round((totalAbsenceDays / (365 * TEAM.length)) * 100);
            document.getElementById('absenceRate').textContent = absenceRate + '%';
            document.getElementById('absenceTrend').textContent = `${totalAbsenceDays} jours total`;
            
            // Score d'√©quilibre
            const workloads = calculateWorkloads();
            const workloadValues = Object.values(workloads).map(w => w.total);
            const maxWorkload = Math.max(...workloadValues);
            const minWorkload = Math.min(...workloadValues);
            const balanceScore = Math.round((maxWorkload - minWorkload) * 10) / 10;
            document.getElementById('balanceScore').textContent = balanceScore;
            
            // Charge moyenne
            const totalPositions = assignedWeeks * 3; // 3 positions par semaine
            const avgWorkload = assignedWeeks > 0 ? 
                Math.round((totalPositions / TEAM.length) * 10) / 10 : 0;
            document.getElementById('avgWorkload').textContent = avgWorkload;
            
            // Semaines critiques
            const criticalWeeks = [...new Set(conflicts.filter(c => c.severity >= 2).map(c => c.week))].length;
            document.getElementById('criticalWeeks').textContent = criticalWeeks;
        }

        function calculateWorkloads() {
            const workloads = {};
            
            TEAM.forEach(member => {
                workloads[member] = {
                    principal: 0,
                    backup: 0,
                    total: 0
                };
            });
            
            Object.values(assignments).forEach(assignment => {
                if (workloads[assignment.member1]) workloads[assignment.member1].principal++;
                if (workloads[assignment.member2]) workloads[assignment.member2].principal++;
                if (workloads[assignment.backup]) workloads[assignment.backup].backup++;
            });
            
            Object.keys(workloads).forEach(member => {
                workloads[member].total = workloads[member].principal + (workloads[member].backup * 0.5);
            });
            
            return workloads;
        }

        function updateConflictDisplay() {
            const container = document.getElementById('conflictList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (conflicts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #27ae60;">
                        <h3>‚úÖ Aucun conflit d√©tect√©</h3>
                        <p>Le planning est optimal</p>
                    </div>
                `;
                return;
            }
            
            const conflictsByWeek = {};
            conflicts.forEach(conflict => {
                if (!conflictsByWeek[conflict.week]) {
                    conflictsByWeek[conflict.week] = [];
                }
                conflictsByWeek[conflict.week].push(conflict);
            });
            
            const sortedWeeks = Object.keys(conflictsByWeek).sort((a, b) => {
                const severityA = conflictsByWeek[a][0].severity;
                const severityB = conflictsByWeek[b][0].severity;
                return severityB - severityA;
            });
            
            sortedWeeks.forEach(week => {
                const weekConflicts = conflictsByWeek[week];
                const severity = weekConflicts[0].severity;
                const totalAbsent = weekConflicts[0].totalAbsent;
                
                const conflictDiv = document.createElement('div');
                conflictDiv.style.cssText = 'border: 2px solid #e74c3c; border-radius: 10px; padding: 20px; margin-bottom: 15px; background: #fff5f5;';
                
                let severityBadge = '';
                if (severity === 1) severityBadge = '<span class="severity-badge severity-1">Gravit√© 1</span>';
                else if (severity === 2) severityBadge = '<span class="severity-badge severity-2">Gravit√© 2</span>';
                else severityBadge = '<span class="severity-badge severity-3">GRAVIT√â 3</span>';
                
                conflictDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #c0392b;">Semaine ${week}</h3>
                        ${severityBadge}
                    </div>
                    <p style="margin-bottom: 10px;"><strong>${totalAbsent} membre(s) absent(s)</strong></p>
                    <ul style="margin-bottom: 15px;">
                        ${weekConflicts.map(c => `
                            <li>${c.member} (${c.role}) - ${formatDateFR(new Date(c.vacationStart))} au ${formatDateFR(new Date(c.vacationEnd))}</li>
                        `).join('')}
                    </ul>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-danger" onclick="resolveConflict(${week})">üîß R√©soudre</button>
                        <button class="btn btn-primary" onclick="editWeek(${week})">‚úèÔ∏è Modifier</button>
                    </div>
                `;
                
                container.appendChild(conflictDiv);
            });
        }

        function updateManagerialDashboard() {
            // Update conflict list in management tab
            const managerConflictList = document.getElementById('managerConflictList');
            if (managerConflictList) {
                managerConflictList.innerHTML = document.getElementById('conflictList').innerHTML;
            }
            
            // Update year overview
            updateYearOverview();
        }

        function updateYearOverview() {
            const container = document.getElementById('yearOverview');
            if (!container) return;
            
            container.innerHTML = '';
            
            const monthsGrid = document.createElement('div');
            monthsGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;';
            
            const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                          'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            
            months.forEach((month, index) => {
                const monthCard = document.createElement('div');
                monthCard.style.cssText = 'background: #f8f9fa; border: 1px solid #ecf0f1; border-radius: 10px; padding: 15px;';
                
                const weeks = getWeeksInMonth(currentYear, index);
                const monthAssignments = weeks.filter(w => assignments[`${currentYear}-W${w.number}`]).length;
                const monthConflicts = weeks.filter(w => conflicts.some(c => c.week === w.number)).length;
                
                monthCard.innerHTML = `
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">${month}</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Couverture: ${monthAssignments}/${weeks.length}</span>
                        <span style="color: ${monthConflicts > 0 ? '#e74c3c' : '#27ae60'};">
                            ${monthConflicts > 0 ? `‚ö†Ô∏è ${monthConflicts} conflits` : '‚úÖ OK'}
                        </span>
                    </div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        ${weeks.map(w => {
                            const hasAssignment = assignments[`${currentYear}-W${w.number}`];
                            const hasConflict = conflicts.some(c => c.week === w.number);
                            const severity = hasConflict ? conflicts.find(c => c.week === w.number).severity : 0;
                            
                            let color = '#95a5a6';
                            if (hasConflict) {
                                color = severity === 3 ? '#e74c3c' : severity === 2 ? '#f39c12' : '#f1c40f';
                            } else if (hasAssignment) {
                                color = '#27ae60';
                            }
                            
                            return `<div style="width: 30px; height: 30px; background: ${color}; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold; cursor: pointer;" onclick="editWeek(${w.number})" title="Semaine ${w.number}">${w.number}</div>`;
                        }).join('')}
                    </div>
                `;
                
                monthsGrid.appendChild(monthCard);
            });
            
            container.appendChild(monthsGrid);
        }

        function updateYearView() {
            const container = document.getElementById('yearView');
            if (!container) return;
            
            container.innerHTML = '';
            
            const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                          'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            
            months.forEach((month, index) => {
                const monthBlock = document.createElement('div');
                monthBlock.className = 'month-block';
                
                const header = document.createElement('div');
                header.className = 'month-header';
                header.textContent = month;
                monthBlock.appendChild(header);
                
                const weeksContainer = document.createElement('div');
                weeksContainer.className = 'weeks-container';
                
                const weeks = getWeeksInMonth(currentYear, index);
                
                weeks.forEach(week => {
                    const weekRow = document.createElement('div');
                    weekRow.className = 'week-row';
                    
                    const weekKey = `${currentYear}-W${week.number}`;
                    const assignment = assignments[weekKey];
                    const weekConflicts = conflicts.filter(c => c.week === week.number);
                    
                    if (weekConflicts.length > 0) {
                        weekRow.classList.add('conflict');
                    } else if (assignment) {
                        weekRow.classList.add('assigned');
                    }
                    
                    weekRow.innerHTML = `
                        <span style="font-weight: bold;">S${week.number}</span>
                        <span>${assignment ? `${assignment.member1} + ${assignment.member2}` : 'Non assign√©e'}</span>
                        ${weekConflicts.length > 0 ? '<span style="color: #e74c3c;">‚ö†Ô∏è</span>' : ''}
                    `;
                    
                    weekRow.onclick = () => editWeek(week.number);
                    weeksContainer.appendChild(weekRow);
                });
                
                monthBlock.appendChild(weeksContainer);
                container.appendChild(monthBlock);
            });
        }

        function updateAbsencesView() {
            const container = document.getElementById('absencesContainer');
            if (!container) return;
            
            container.innerHTML = '';
            container.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;';
            
            TEAM.forEach(member => {
                const card = document.createElement('div');
                card.style.cssText = 'border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f8f9fa;';
                
                const memberVacations = vacations[member] || [];
                const totalDays = memberVacations.reduce((sum, vac) => {
                    return sum + Math.ceil((new Date(vac.end) - new Date(vac.start)) / (1000 * 60 * 60 * 24)) + 1;
                }, 0);
                
                card.innerHTML = `
                    <h4 style="color: #2c3e50; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #3498db;">
                        ${member} (${totalDays} jours)
                    </h4>
                    ${memberVacations.length === 0 ? 
                        '<p style="color: #666; font-style: italic;">Aucune absence</p>' :
                        memberVacations.map(vac => `
                            <div style="background: white; padding: 10px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                                <span>${formatDateFR(new Date(vac.start))} - ${formatDateFR(new Date(vac.end))}</span>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteVacation('${member}', '${vac.start}', '${vac.end}')">üóëÔ∏è</button>
                            </div>
                        `).join('')
                    }
                `;
                
                container.appendChild(card);
            });
        }

        function updateTeamTable() {
            const tbody = document.getElementById('teamTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            const workloads = calculateWorkloads();
            
            TEAM.forEach(member => {
                const workload = workloads[member];
                const absenceDays = vacations[member] ? 
                    vacations[member].reduce((sum, vac) => {
                        return sum + Math.ceil((new Date(vac.end) - new Date(vac.start)) / (1000 * 60 * 60 * 24)) + 1;
                    }, 0) : 0;
                
                const chargePercent = Math.round((workload.total / 52) * 100);
                const avgWorkload = Object.values(workloads).reduce((sum, w) => sum + w.total, 0) / TEAM.length;
                const balanceScore = Math.round(Math.abs(workload.total - avgWorkload) * 10) / 10;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${member}</strong></td>
                    <td>${workload.principal}</td>
                    <td>${workload.backup}</td>
                    <td>${absenceDays}</td>
                    <td>${chargePercent}%</td>
                    <td>${balanceScore}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function switchTab(event, tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            if (tab === 'management') {
                updateManagerialDashboard();
            } else if (tab === 'importexport') {
                updateImportExportInfo();
            }
        }

        function updateImportExportInfo() {
            // Mettre √† jour les informations syst√®me
            const lastSave = localStorage.getItem('planningData');
            if (lastSave) {
                const data = JSON.parse(lastSave);
                if (data.lastModified) {
                    const date = new Date(data.lastModified);
                    document.getElementById('lastSaveTime').textContent = formatDateTimeFR(date);
                }
            }
            
            // Mettre √† jour le nombre de calendriers
            const calendarBtn = document.querySelector('#importexportTab .btn-success');
            if (calendarBtn) {
                calendarBtn.innerHTML = `üìÖ G√©n√©rer les ${TEAM.length} calendriers`;
            }
        }

        function formatDateTimeFR(date) {
            const options = { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return date.toLocaleDateString('fr-FR', options);
        }

        function exportCSV() {
            let csv = 'Semaine,Date D√©but,Date Fin,Membre 1,Membre 2,Backup,Statut\n';
            
            for (let week = 1; week <= 52; week++) {
                const weekKey = `${currentYear}-W${week}`;
                const weekDates = getWeekDates(currentYear, week);
                const assignment = assignments[weekKey];
                const hasConflict = conflicts.some(c => c.week === week);
                
                const startStr = formatDateCSV(weekDates.start);
                const endStr = formatDateCSV(weekDates.end);
                
                if (assignment) {
                    const status = hasConflict ? 'Conflit' : 'OK';
                    csv += `${week},${startStr},${endStr},${assignment.member1},${assignment.member2},${assignment.backup},${status}\n`;
                } else {
                    csv += `${week},${startStr},${endStr},-,-,-,Non assign√©e\n`;
                }
            }
            
            // Ajouter une section pour les absences
            csv += '\n\nABSENCES\n';
            csv += 'R√©f√©rent,Date D√©but,Date Fin,Jours\n';
            
            Object.entries(vacations).forEach(([member, absences]) => {
                absences.forEach(absence => {
                    const days = Math.ceil((new Date(absence.end) - new Date(absence.start)) / (1000 * 60 * 60 * 24)) + 1;
                    csv += `${member},${absence.start},${absence.end},${days}\n`;
                });
            });
            
            // T√©l√©charger le fichier
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `planning_${currentYear}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showNotification('üìä Export CSV g√©n√©r√© avec succ√®s', 'success');
        }

        function formatDateCSV(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${d}/${m}/${y}`;
        }

        function handleDirectImport(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validation
                    if (!importedData.assignments || !importedData.year) {
                        throw new Error('Format de fichier invalide');
                    }
                    
                    // Afficher un r√©sum√© avant import
                    const assignmentCount = Object.keys(importedData.assignments).length;
                    const vacationCount = importedData.vacations ? 
                        Object.values(importedData.vacations).reduce((sum, v) => sum + v.length, 0) : 0;
                    
                    const message = `Voulez-vous importer ce planning ?\n\n` +
                        `üìÖ Ann√©e : ${importedData.year}\n` +
                        `üìã Assignations : ${assignmentCount} semaines\n` +
                        `üèñÔ∏è Absences : ${vacationCount} p√©riodes\n` +
                        `üë• √âquipe : ${importedData.teamNames ? importedData.teamNames.length : 'Non d√©finie'} membres\n\n` +
                        `‚ö†Ô∏è Cela remplacera TOUTES les donn√©es actuelles.`;
                    
                    if (!confirm(message)) {
                        input.value = ''; // Reset file input
                        return;
                    }
                    
                    // Importer les donn√©es
                    currentYear = importedData.year || currentYear;
                    assignments = importedData.assignments || {};
                    vacations = importedData.vacations || {};
                    severityConfig = importedData.severityConfig || severityConfig;
                    
                    if (importedData.teamNames && Array.isArray(importedData.teamNames)) {
                        TEAM = importedData.teamNames;
                    } else if (importedData.team && Array.isArray(importedData.team)) {
                        TEAM = importedData.team;
                    }
                    
                    // Mettre √† jour l'interface
                    document.getElementById('currentYear').textContent = currentYear;
                    
                    if (severityConfig) {
                        document.getElementById('severity1').value = severityConfig.level1 || 1;
                        document.getElementById('severity2').value = severityConfig.level2 || 2;
                        document.getElementById('severity3').value = severityConfig.level3 || 3;
                    }
                    
                    // Sauvegarder et rafra√Æchir
                    saveData();
                    populateSelects();
                    detectConflicts();
                    updateAllDisplays();
                    
                    showNotification(
                        `‚úÖ Import r√©ussi ! Planning ${importedData.year} charg√© avec ${assignmentCount} assignations.`, 
                        'success'
                    );
                    
                    // Reset file input
                    input.value = '';
                    
                } catch (error) {
                    console.error('Erreur d\'import:', error);
                    showNotification('‚ùå Erreur lors de l\'import : ' + error.message, 'error');
                    input.value = '';
                }
            };
            
            reader.onerror = function() {
                showNotification('‚ùå Erreur de lecture du fichier', 'error');
                input.value = '';
            };
            
            reader.readAsText(file);
        }

        function autoFillWithBalance() {
            if (!confirm('Remplir automatiquement l\'ann√©e avec une r√©partition √©quilibr√©e pour 9 r√©f√©rents?')) return;
            
            // Avec 9 r√©f√©rents et 3 postes par semaine (2 principaux + 1 backup)
            // Sur 52 semaines : 52 * 3 = 156 positions totales
            // 156 / 9 = 17.33 positions par personne en moyenne
            
            // Strat√©gie : rotation syst√©matique pour √©quilibrer
            // Chaque r√©f√©rent aura environ 11-12 semaines en principal et 5-6 en backup
            
            const memberAssignments = {};
            TEAM.forEach(member => {
                memberAssignments[member] = {
                    principal: 0,
                    backup: 0,
                    lastWeek: 0
                };
            });
            
            for (let week = 1; week <= 52; week++) {
                const weekKey = `${currentYear}-W${week}`;
                
                // Trouver les membres avec le moins d'assignations qui ne sont pas trop proches
                const availableForPrincipal = [...TEAM].sort((a, b) => {
                    const scoreA = memberAssignments[a].principal * 2 + memberAssignments[a].backup;
                    const scoreB = memberAssignments[b].principal * 2 + memberAssignments[b].backup;
                    // √âviter d'assigner quelqu'un deux semaines de suite
                    if (week - memberAssignments[a].lastWeek < 3) return 1;
                    if (week - memberAssignments[b].lastWeek < 3) return -1;
                    return scoreA - scoreB;
                });
                
                // S√©lectionner les deux premiers pour le r√¥le principal
                const member1 = availableForPrincipal[0];
                const member2 = availableForPrincipal[1];
                
                // Trouver le backup parmi les restants (pr√©f√©rence √† ceux avec moins de backups)
                const availableForBackup = TEAM.filter(m => m !== member1 && m !== member2)
                    .sort((a, b) => {
                        // Prioriser ceux avec moins de backups
                        const backupDiff = memberAssignments[a].backup - memberAssignments[b].backup;
                        if (backupDiff !== 0) return backupDiff;
                        // Puis ceux avec moins d'assignations totales
                        const totalA = memberAssignments[a].principal + memberAssignments[a].backup;
                        const totalB = memberAssignments[b].principal + memberAssignments[b].backup;
                        return totalA - totalB;
                    });
                
                const backup = availableForBackup[0];
                
                // Enregistrer l'assignation
                assignments[weekKey] = {
                    member1: member1,
                    member2: member2,
                    backup: backup
                };
                
                // Mettre √† jour les compteurs
                memberAssignments[member1].principal++;
                memberAssignments[member1].lastWeek = week;
                memberAssignments[member2].principal++;
                memberAssignments[member2].lastWeek = week;
                memberAssignments[backup].backup++;
                memberAssignments[backup].lastWeek = week;
            }
            
            // Afficher un rapport de distribution
            console.log('Distribution finale:');
            TEAM.forEach(member => {
                const stats = memberAssignments[member];
                const total = stats.principal + stats.backup;
                console.log(`${member}: ${stats.principal} principal + ${stats.backup} backup = ${total} total`);
            });
            
            saveData();
            detectConflicts();
            updateAllDisplays();
            showNotification('‚úÖ Planning rempli avec r√©partition optimis√©e pour 9 r√©f√©rents !', 'success');
        }

        function resolveConflict(weekNum) {
            const weekKey = `${currentYear}-W${weekNum}`;
            const weekConflicts = conflicts.filter(c => c.week === weekNum);
            const conflictMembers = weekConflicts.map(c => c.member);
            const currentAssignment = assignments[weekKey];
            
            // Analyser les membres disponibles
            const available = TEAM.filter(member => {
                if (conflictMembers.includes(member)) return false;
                
                if (!vacations[member]) return true;
                
                const weekDates = getWeekDates(currentYear, weekNum);
                return !vacations[member].some(vac => {
                    const vacStart = new Date(vac.start);
                    const vacEnd = new Date(vac.end);
                    return datesOverlap(weekDates.start, weekDates.end, vacStart, vacEnd);
                });
            });
            
            // G√©n√©rer plusieurs solutions possibles
            const solutions = generateSolutions(available, weekNum);
            
            if (solutions.length > 0) {
                // Choisir la meilleure solution
                const bestSolution = solutions[0];
                
                // Afficher les solutions propos√©es
                showSolutionModal(weekNum, solutions, conflictMembers, currentAssignment);
            } else {
                showNotification(`‚ùå Aucune solution possible pour la semaine ${weekNum} (${available.length} membres disponibles)`, 'error');
            }
        }

        function generateSolutions(available, weekNum) {
            const solutions = [];
            const workloads = calculateWorkloads();
            
            // Trier par charge de travail croissante
            available.sort((a, b) => workloads[a].total - workloads[b].total);
            
            // Solution 1: √âquilibrage optimal (membres avec moins de charge)
            if (available.length >= 3) {
                solutions.push({
                    type: '√âquilibrage Optimal',
                    description: 'S√©lection bas√©e sur la charge de travail minimale',
                    member1: available[0],
                    member2: available[1],
                    backup: available[2],
                    score: 100,
                    color: '#27ae60'
                });
            }
            
            // Solution 2: Rotation maximale (√©viter les m√™mes bin√¥mes)
            if (available.length >= 6) {
                solutions.push({
                    type: 'Rotation Maximale',
                    description: '√âvite la r√©p√©tition des m√™mes bin√¥mes',
                    member1: available[3],
                    member2: available[4],
                    backup: available[5],
                    score: 85,
                    color: '#3498db'
                });
            }
            
            // Solution 3: Mix exp√©rience (si on avait des niveaux d'exp√©rience)
            if (available.length >= 4) {
                const shuffled = [...available].sort(() => Math.random() - 0.5);
                solutions.push({
                    type: 'R√©partition Al√©atoire',
                    description: 'Distribution al√©atoire pour varier les √©quipes',
                    member1: shuffled[0],
                    member2: shuffled[1],
                    backup: shuffled[2],
                    score: 70,
                    color: '#f39c12'
                });
            }
            
            // Calculer un score pour chaque solution
            solutions.forEach(sol => {
                const m1Load = workloads[sol.member1].total;
                const m2Load = workloads[sol.member2].total;
                const bLoad = workloads[sol.backup].total;
                const avgLoad = (m1Load + m2Load + bLoad) / 3;
                
                // Ajuster le score en fonction de l'√©quilibre
                sol.adjustedScore = Math.round(sol.score - (avgLoad * 2));
            });
            
            // Trier par score ajust√©
            solutions.sort((a, b) => b.adjustedScore - a.adjustedScore);
            
            return solutions;
        }

        function showSolutionModal(weekNum, solutions, conflictMembers, currentAssignment) {
            // Cr√©er un modal pour afficher les solutions
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <div class="modal-header">
                        <h2>üéØ Solutions Propos√©es - Semaine ${weekNum}</h2>
                    </div>
                    
                    <div style="background: #fff5f5; border: 2px solid #e74c3c; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="color: #c0392b; margin-bottom: 10px;">‚ö†Ô∏è Conflit D√©tect√©</h4>
                        <p><strong>Membres en conflit :</strong> ${conflictMembers.join(', ')}</p>
                        <p><strong>Assignation actuelle :</strong> ${currentAssignment.member1} + ${currentAssignment.member2} (Backup: ${currentAssignment.backup})</p>
                    </div>
                    
                    <h3 style="margin-bottom: 15px;">‚ú® Solutions Recommand√©es par le Syst√®me</h3>
                    
                    <div style="display: grid; gap: 15px;">
                        ${solutions.map((sol, index) => `
                            <div style="border: 2px solid ${sol.color}; border-radius: 10px; padding: 20px; background: linear-gradient(to right, rgba(255,255,255,0.9), ${sol.color}15); cursor: pointer; transition: all 0.3s;"
                                 onmouseover="this.style.transform='translateX(10px)'"
                                 onmouseout="this.style.transform='translateX(0)'">
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h4 style="color: ${sol.color};">
                                        ${index === 0 ? '‚≠ê RECOMMAND√â - ' : ''}${sol.type}
                                    </h4>
                                    <span style="background: ${sol.color}; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">
                                        Score: ${sol.adjustedScore}/100
                                    </span>
                                </div>
                                
                                <p style="color: #666; font-style: italic; margin-bottom: 10px;">${sol.description}</p>
                                
                                <div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                                    <strong>√âquipe propos√©e :</strong><br>
                                    ‚Ä¢ Principal 1 : <strong>${sol.member1}</strong> (charge actuelle: ${Math.round(calculateWorkloads()[sol.member1].total)})<br>
                                    ‚Ä¢ Principal 2 : <strong>${sol.member2}</strong> (charge actuelle: ${Math.round(calculateWorkloads()[sol.member2].total)})<br>
                                    ‚Ä¢ Backup : <strong>${sol.backup}</strong> (charge actuelle: ${Math.round(calculateWorkloads()[sol.backup].total)})
                                </div>
                                
                                <button class="btn btn-success" style="width: 100%;" onclick="applySolution(${weekNum}, '${sol.member1}', '${sol.member2}', '${sol.backup}', this)">
                                    ${index === 0 ? '‚úÖ Appliquer cette solution (Recommand√©e)' : '‚úîÔ∏è Appliquer cette solution'}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p style="color: #666; margin: 0;">
                            <strong>üí° Conseil :</strong> Le syst√®me recommande la premi√®re solution car elle offre le meilleur √©quilibre de charge de travail entre les membres disponibles.
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function applySolution(weekNum, member1, member2, backup, button) {
            const weekKey = `${currentYear}-W${weekNum}`;
            
            assignments[weekKey] = {
                member1: member1,
                member2: member2,
                backup: backup
            };
            
            saveData();
            detectConflicts();
            updateAllDisplays();
            
            // Fermer le modal
            button.closest('.modal').remove();
            
            showNotification(`‚úÖ Solution appliqu√©e pour la semaine ${weekNum}`, 'success');
        }

        function resolveAllConflicts() {
            const uniqueWeeks = [...new Set(conflicts.map(c => c.week))];
            
            if (uniqueWeeks.length === 0) {
                showNotification('‚ÑπÔ∏è Aucun conflit √† r√©soudre', 'info');
                return;
            }
            
            // Trier par gravit√© d√©croissante
            uniqueWeeks.sort((a, b) => {
                const severityA = conflicts.find(c => c.week === a).severity;
                const severityB = conflicts.find(c => c.week === b).severity;
                return severityB - severityA;
            });
            
            // Cr√©er un rapport de r√©solution
            const resolutionReport = {
                total: uniqueWeeks.length,
                resolved: [],
                failed: [],
                solutions: []
            };
            
            uniqueWeeks.forEach(week => {
                const weekKey = `${currentYear}-W${week}`;
                const weekConflicts = conflicts.filter(c => c.week === week);
                const conflictMembers = weekConflicts.map(c => c.member);
                
                // Trouver les membres disponibles
                const available = TEAM.filter(member => {
                    if (conflictMembers.includes(member)) return false;
                    
                    if (!vacations[member]) return true;
                    
                    const weekDates = getWeekDates(currentYear, week);
                    return !vacations[member].some(vac => {
                        const vacStart = new Date(vac.start);
                        const vacEnd = new Date(vac.end);
                        return datesOverlap(weekDates.start, weekDates.end, vacStart, vacEnd);
                    });
                });
                
                if (available.length >= 3) {
                    // G√©n√©rer et appliquer la meilleure solution
                    const solutions = generateSolutions(available, week);
                    const bestSolution = solutions[0];
                    
                    assignments[weekKey] = {
                        member1: bestSolution.member1,
                        member2: bestSolution.member2,
                        backup: bestSolution.backup
                    };
                    
                    resolutionReport.resolved.push(week);
                    resolutionReport.solutions.push({
                        week: week,
                        solution: bestSolution,
                        conflictMembers: conflictMembers
                    });
                } else {
                    resolutionReport.failed.push({
                        week: week,
                        reason: `Seulement ${available.length} membres disponibles`,
                        conflictMembers: conflictMembers
                    });
                }
            });
            
            saveData();
            detectConflicts();
            updateAllDisplays();
            
            // Afficher le rapport de r√©solution
            showResolutionReport(resolutionReport);
        }

        function showResolutionReport(report) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <div class="modal-header">
                        <h2>üìä Rapport de R√©solution Automatique</h2>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #2c3e50;">${report.total}</div>
                            <div style="color: #666;">Conflits Totaux</div>
                        </div>
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #27ae60;">${report.resolved.length}</div>
                            <div style="color: #666;">R√©solus</div>
                        </div>
                        <div style="background: #f8d7da; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #e74c3c;">${report.failed.length}</div>
                            <div style="color: #666;">Non R√©solus</div>
                        </div>
                    </div>
                    
                    ${report.resolved.length > 0 ? `
                        <h3 style="color: #27ae60; margin-bottom: 15px;">‚úÖ Conflits R√©solus (${report.resolved.length})</h3>
                        <div style="display: grid; gap: 10px; margin-bottom: 20px;">
                            ${report.solutions.map(sol => `
                                <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;">
                                    <strong>Semaine ${sol.week}</strong><br>
                                    <span style="color: #666;">Conflits pr√©c√©dents : ${sol.conflictMembers.join(', ')}</span><br>
                                    <span style="color: #155724;">
                                        <strong>Solution appliqu√©e (${sol.solution.type}) :</strong><br>
                                        ${sol.solution.member1} + ${sol.solution.member2} (Backup: ${sol.solution.backup})
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${report.failed.length > 0 ? `
                        <h3 style="color: #e74c3c; margin-bottom: 15px;">‚ùå Conflits Non R√©solus (${report.failed.length})</h3>
                        <div style="display: grid; gap: 10px; margin-bottom: 20px;">
                            ${report.failed.map(fail => `
                                <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c;">
                                    <strong>Semaine ${fail.week}</strong><br>
                                    <span style="color: #666;">Membres en conflit : ${fail.conflictMembers.join(', ')}</span><br>
                                    <span style="color: #721c24;">Raison : ${fail.reason}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <p style="margin: 0;">
                            <strong>üìà R√©sum√© :</strong> Le syst√®me a r√©solu automatiquement 
                            <strong>${Math.round((report.resolved.length / report.total) * 100)}%</strong> des conflits 
                            en utilisant l'algorithme d'√©quilibrage optimal de charge de travail.
                        </p>
                    </div>
                    
                    <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="this.parentElement.parentElement.remove()">
                        Fermer le rapport
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function deleteVacation(member, start, end) {
            if (!confirm('Supprimer cette absence?')) return;
            
            vacations[member] = vacations[member].filter(v => 
                !(v.start === start && v.end === end)
            );
            
            saveData();
            detectConflicts();
            updateAllDisplays();
            showNotification('‚úÖ Absence supprim√©e', 'success');
        }

        function exportCalendars() {
            let exportCount = 0;
            
            TEAM.forEach(member => {
                let icsContent = 'BEGIN:VCALENDAR\r\n';
                icsContent += 'VERSION:2.0\r\n';
                icsContent += 'PRODID:-//Planning Manager Pro//FR\r\n';
                icsContent += 'CALSCALE:GREGORIAN\r\n';
                icsContent += 'METHOD:PUBLISH\r\n';
                icsContent += `X-WR-CALNAME:Planning ${member} - ${currentYear}\r\n`;
                icsContent += `X-WR-TIMEZONE:Europe/Paris\r\n`;
                
                // Parcourir toutes les semaines de l'ann√©e
                Object.entries(assignments).forEach(([weekKey, assignment]) => {
                    if (!weekKey.startsWith(`${currentYear}-W`)) return;
                    
                    const weekNum = parseInt(weekKey.split('-W')[1]);
                    const weekDates = getWeekDates(currentYear, weekNum);
                    
                    // D√©terminer le r√¥le du membre
                    let role = null;
                    let eventColor = '';
                    
                    if (assignment.member1 === member || assignment.member2 === member) {
                        role = 'R√©f√©rent Principal';
                        eventColor = 'GREEN';
                    } else if (assignment.backup === member) {
                        role = 'Backup';
                        eventColor = 'ORANGE';
                    }
                    
                    if (role) {
                        // Cr√©er l'√©v√©nement
                        const uid = `${weekKey}-${member.replace(/\s+/g, '_')}@planningpro`;
                        const stamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                        
                        // Dates au format iCalendar (YYYYMMDD)
                        const startDate = formatDateICS(weekDates.start);
                        const endDate = formatDateICS(new Date(weekDates.end.getTime() + 86400000)); // +1 jour pour inclure le dimanche
                        
                        icsContent += 'BEGIN:VEVENT\r\n';
                        icsContent += `UID:${uid}\r\n`;
                        icsContent += `DTSTAMP:${stamp}\r\n`;
                        icsContent += `DTSTART;VALUE=DATE:${startDate}\r\n`;
                        icsContent += `DTEND;VALUE=DATE:${endDate}\r\n`;
                        icsContent += `SUMMARY:${role} - Semaine ${weekNum}\r\n`;
                        icsContent += `DESCRIPTION:Semaine ${weekNum} (${formatDateFR(weekDates.start)} au ${formatDateFR(weekDates.end)})\\n`;
                        icsContent += `√âquipe: ${assignment.member1} + ${assignment.member2}\\n`;
                        icsContent += `Backup: ${assignment.backup}\\n`;
                        icsContent += `R√¥le: ${role}\r\n`;
                        icsContent += `CATEGORIES:${role}\r\n`;
                        icsContent += `X-APPLE-TRAVEL-ADVISORY-BEHAVIOR:AUTOMATIC\r\n`;
                        
                        // Ajouter une alarme 1 jour avant
                        icsContent += 'BEGIN:VALARM\r\n';
                        icsContent += 'TRIGGER:-P1D\r\n';
                        icsContent += 'ACTION:DISPLAY\r\n';
                        icsContent += `DESCRIPTION:Rappel: ${role} demain (Semaine ${weekNum})\r\n`;
                        icsContent += 'END:VALARM\r\n';
                        
                        icsContent += 'END:VEVENT\r\n';
                    }
                });
                
                // Ajouter les p√©riodes d'absence comme √©v√©nements
                if (vacations[member]) {
                    vacations[member].forEach((vacation, index) => {
                        const uid = `vacation-${member.replace(/\s+/g, '_')}-${index}@planningpro`;
                        const stamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                        
                        const startDate = formatDateICS(new Date(vacation.start));
                        const endDate = formatDateICS(new Date(new Date(vacation.end).getTime() + 86400000));
                        
                        icsContent += 'BEGIN:VEVENT\r\n';
                        icsContent += `UID:${uid}\r\n`;
                        icsContent += `DTSTAMP:${stamp}\r\n`;
                        icsContent += `DTSTART;VALUE=DATE:${startDate}\r\n`;
                        icsContent += `DTEND;VALUE=DATE:${endDate}\r\n`;
                        icsContent += `SUMMARY:üèñÔ∏è Absence - ${member}\r\n`;
                        icsContent += `DESCRIPTION:P√©riode d'absence\r\n`;
                        icsContent += `CATEGORIES:ABSENCE\r\n`;
                        icsContent += 'END:VEVENT\r\n';
                    });
                }
                
                icsContent += 'END:VCALENDAR';
                
                // Cr√©er et t√©l√©charger le fichier
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const fileName = `planning_${member.replace(/\s+/g, '_')}_${currentYear}.ics`;
                link.download = fileName;
                
                // Petit d√©lai entre chaque t√©l√©chargement pour √©viter les blocages
                setTimeout(() => {
                    link.click();
                    exportCount++;
                    
                    if (exportCount === TEAM.length) {
                        setTimeout(() => {
                            showNotification(`üìÖ ${exportCount} calendriers export√©s avec succ√®s !`, 'success');
                        }, 500);
                    }
                }, exportCount * 100);
            });
        }

        function formatDateICS(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }

        function handleImport(event) {
            event.preventDefault();
            
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('‚ùå Veuillez s√©lectionner un fichier', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validation basique
                    if (!importedData.assignments || !importedData.year) {
                        throw new Error('Format de fichier invalide');
                    }
                    
                    // Confirmation finale
                    if (!confirm(`Importer le planning de l'ann√©e ${importedData.year} ?\n\nCela remplacera TOUTES les donn√©es actuelles.`)) {
                        return;
                    }
                    
                    // Importer les donn√©es
                    currentYear = importedData.year || currentYear;
                    assignments = importedData.assignments || {};
                    vacations = importedData.vacations || {};
                    severityConfig = importedData.severityConfig || severityConfig;
                    
                    // Importer les noms d'√©quipe si pr√©sents
                    if (importedData.teamNames && Array.isArray(importedData.teamNames)) {
                        TEAM = importedData.teamNames;
                    } else if (importedData.team && Array.isArray(importedData.team)) {
                        TEAM = importedData.team;
                    }
                    
                    // Mettre √† jour l'ann√©e affich√©e
                    document.getElementById('currentYear').textContent = currentYear;
                    
                    // Mettre √† jour la configuration
                    if (severityConfig) {
                        document.getElementById('severity1').value = severityConfig.level1 || 1;
                        document.getElementById('severity2').value = severityConfig.level2 || 2;
                        document.getElementById('severity3').value = severityConfig.level3 || 3;
                    }
                    
                    // Sauvegarder et rafra√Æchir
                    saveData();
                    populateSelects();
                    detectConflicts();
                    updateAllDisplays();
                    closeModal('importModal');
                    
                    // Afficher les statistiques d'import
                    const assignmentCount = Object.keys(assignments).length;
                    const vacationCount = Object.values(vacations).reduce((sum, v) => sum + v.length, 0);
                    
                    showNotification(
                        `‚úÖ Import r√©ussi ! ${assignmentCount} assignations et ${vacationCount} absences import√©es pour ${currentYear}`, 
                        'success'
                    );
                    
                } catch (error) {
                    console.error('Erreur d\'import:', error);
                    showNotification('‚ùå Erreur lors de l\'import : ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification('‚ùå Erreur de lecture du fichier', 'error');
            };
            
            reader.readAsText(file);
        }

        function exportAll() {
            const data = {
                version: '3.1',
                exportDate: new Date().toISOString(),
                year: currentYear,
                assignments: assignments,
                vacations: vacations,
                severityConfig: severityConfig,
                teamNames: TEAM,
                metrics: {
                    coverageRate: document.getElementById('coverageRate').textContent,
                    conflictCount: document.getElementById('conflictCount').textContent,
                    absenceRate: document.getElementById('absenceRate').textContent,
                    balanceScore: document.getElementById('balanceScore').textContent,
                    avgWorkload: document.getElementById('avgWorkload').textContent,
                    criticalWeeks: document.getElementById('criticalWeeks').textContent
                },
                conflicts: conflicts
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `planning_${currentYear}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('üíæ Export JSON g√©n√©r√© avec succ√®s', 'success');
        }

        // Fonctions utilitaires
        function getWeekDates(year, weekNum) {
            const jan1 = new Date(year, 0, 1);
            const jan1Day = jan1.getDay() || 7;
            
            let firstThursday = new Date(year, 0, 1);
            if (jan1Day <= 4) {
                firstThursday.setDate(jan1.getDate() + (4 - jan1Day));
            } else {
                firstThursday.setDate(jan1.getDate() + (11 - jan1Day));
            }
            
            const firstMonday = new Date(firstThursday);
            firstMonday.setDate(firstThursday.getDate() - 3);
            
            const weekStart = new Date(firstMonday);
            weekStart.setDate(firstMonday.getDate() + (weekNum - 1) * 7);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            return { start: weekStart, end: weekEnd };
        }

        function getWeeksInMonth(year, month) {
            const weeks = [];
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            let current = new Date(firstDay);
            
            while (current <= lastDay) {
                const weekNum = getWeekNumber(current);
                if (!weeks.find(w => w.number === weekNum)) {
                    weeks.push({
                        number: weekNum,
                        start: new Date(current)
                    });
                }
                current.setDate(current.getDate() + 7);
            }
            
            return weeks;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function datesOverlap(start1, end1, start2, end2) {
            return start1 <= end2 && end1 >= start2;
        }

        function formatDateFR(date) {
            const options = { day: '2-digit', month: 'short' };
            return date.toLocaleDateString('fr-FR', options);
        }

        function changeYear(delta) {
            currentYear += delta;
            document.getElementById('currentYear').textContent = currentYear;
            loadData();
            detectConflicts();
            updateAllDisplays();
        }

        function populateSelects() {
            const selects = ['member1', 'member2', 'backup', 'vacationMember'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">S√©lectionner</option>';
                    TEAM.forEach(member => {
                        select.innerHTML += `<option value="${member}">${member}</option>`;
                    });
                }
            });
        }

        function showAssignModal() {
            document.getElementById('assignModal').style.display = 'block';
        }

        function showVacationModal() {
            document.getElementById('vacationModal').style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function editWeek(weekNum) {
            const weekKey = `${currentYear}-W${weekNum.toString().padStart(2, '0')}`;
            document.getElementById('weekInput').value = weekKey;
            
            const assignment = assignments[weekKey];
            if (assignment) {
                document.getElementById('member1').value = assignment.member1;
                document.getElementById('member2').value = assignment.member2;
                document.getElementById('backup').value = assignment.backup;
            } else {
                document.getElementById('member1').value = '';
                document.getElementById('member2').value = '';
                document.getElementById('backup').value = '';
            }
            
            showAssignModal();
        }

        function saveAssignment(event) {
            event.preventDefault();
            
            const weekValue = document.getElementById('weekInput').value;
            const member1 = document.getElementById('member1').value;
            const member2 = document.getElementById('member2').value;
            const backup = document.getElementById('backup').value;
            
            if (member1 === member2 || member1 === backup || member2 === backup) {
                showNotification('‚ùå Les membres doivent √™tre diff√©rents', 'error');
                return;
            }
            
            assignments[weekValue] = { member1, member2, backup };
            
            saveData();
            closeModal('assignModal');
            detectConflicts();
            updateAllDisplays();
            showNotification('‚úÖ Assignation enregistr√©e', 'success');
        }

        function saveVacation(event) {
            event.preventDefault();
            
            const member = document.getElementById('vacationMember').value;
            const start = document.getElementById('vacationStart').value;
            const end = document.getElementById('vacationEnd').value;
            
            if (new Date(end) < new Date(start)) {
                showNotification('‚ùå Date de fin invalide', 'error');
                return;
            }
            
            if (!vacations[member]) {
                vacations[member] = [];
            }
            
            vacations[member].push({ start, end });
            
            const days = Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)) + 1;
            
            saveData();
            closeModal('vacationModal');
            detectConflicts();
            updateAllDisplays();
            showNotification(`‚úÖ ${days} jours d'absence enregistr√©s pour ${member}`, 'success');
        }

        function showTeamEditModal() {
            const modal = document.getElementById('teamEditModal');
            const list = document.getElementById('teamEditList');
            
            // S'assurer que TEAM a bien 9 membres
            while (TEAM.length < 9) {
                TEAM.push(`R√©f√©rent ${TEAM.length + 1}`);
            }
            while (TEAM.length > 9) {
                TEAM.pop();
            }
            
            list.innerHTML = TEAM.map((member, index) => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                    <span style="font-weight: bold; color: #666; width: 30px;">${index + 1}.</span>
                    <input type="text" 
                           id="teamMember${index}" 
                           value="${member}" 
                           required
                           style="flex: 1; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 16px;"
                           placeholder="Nom du r√©f√©rent ${index + 1}">
                </div>
            `).join('');
            
            modal.style.display = 'block';
        }

        function saveTeamNames(event) {
            event.preventDefault();
            
            const oldNames = [...TEAM];
            const newNames = [];
            const nameMapping = {};
            
            // Collecter les nouveaux noms
            for (let i = 0; i < TEAM.length; i++) {
                const newName = document.getElementById(`teamMember${i}`).value.trim();
                if (!newName) {
                    showNotification('‚ùå Tous les noms doivent √™tre remplis', 'error');
                    return;
                }
                newNames.push(newName);
                nameMapping[oldNames[i]] = newName;
            }
            
            // V√©rifier les doublons
            const uniqueNames = new Set(newNames);
            if (uniqueNames.size !== newNames.length) {
                showNotification('‚ùå Les noms doivent √™tre uniques', 'error');
                return;
            }
            
            // Mettre √† jour l'√©quipe
            TEAM = newNames;
            
            // Migrer les assignments
            const newAssignments = {};
            Object.entries(assignments).forEach(([key, value]) => {
                newAssignments[key] = {
                    member1: nameMapping[value.member1] || value.member1,
                    member2: nameMapping[value.member2] || value.member2,
                    backup: nameMapping[value.backup] || value.backup
                };
            });
            assignments = newAssignments;
            
            // Migrer les vacations
            const newVacations = {};
            Object.entries(vacations).forEach(([oldName, vacationList]) => {
                const newName = nameMapping[oldName] || oldName;
                newVacations[newName] = vacationList;
            });
            vacations = newVacations;
            
            // Sauvegarder et mettre √† jour
            saveData();
            populateSelects();
            detectConflicts();
            updateAllDisplays();
            closeModal('teamEditModal');
            
            showNotification('‚úÖ Noms de l\'√©quipe mis √† jour avec succ√®s', 'success');
        }

        function resetTeamNames() {
            if (!confirm('R√©initialiser tous les noms par d√©faut (R√©f√©rent 1, R√©f√©rent 2, etc.) ?')) return;
            
            const defaultNames = [
                'R√©f√©rent 1', 'R√©f√©rent 2', 'R√©f√©rent 3', 'R√©f√©rent 4', 'R√©f√©rent 5',
                'R√©f√©rent 6', 'R√©f√©rent 7', 'R√©f√©rent 8', 'R√©f√©rent 9'
            ];
            
            for (let i = 0; i < defaultNames.length; i++) {
                const input = document.getElementById(`teamMember${i}`);
                if (input) input.value = defaultNames[i];
            }
            
            showNotification('üîÑ Noms r√©initialis√©s (cliquez sur Enregistrer pour appliquer)', 'info');
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Fermer les modals en cliquant dehors
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>
