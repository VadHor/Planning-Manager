<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Manager Pro - Gestion Compl√®te</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 32px;
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 20px;
            font-weight: bold;
        }

        .year-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .year-btn:hover {
            background: white;
            color: #764ba2;
        }

        .toolbar {
            background: #2c3e50;
            padding: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-success { background: #27ae60; color: white; }
        .btn-primary { background: #3498db; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-dark { background: #34495e; color: white; }
        .btn-danger { background: #e74c3c; color: white; }

        .tabs-container {
            padding: 30px;
        }

        .tabs-nav {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #27ae60;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .calendar-year {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .month-block {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .month-header {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .weeks-container {
            padding: 10px;
        }

        .week-row {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .week-row:hover {
            background: #f8f9fa;
        }

        .week-row.assigned {
            background: #e8f5e9;
            border-left: 4px solid #27ae60;
        }

        .week-row.conflict {
            background: #ffebee;
            border-left: 4px solid #e74c3c;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: 15px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 20px 30px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 2000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
        .notification.warning { background: #f39c12; }
        .notification.info { background: #3498db; }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .partnership-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .partnership-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
        }

        .heatmap-grid {
            display: grid;
            gap: 2px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
        }

        .heatmap-cell {
            padding: 8px;
            text-align: center;
            font-weight: bold;
            color: white;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Planning Manager Pro</h1>
            <div class="year-selector">
                <button class="year-btn" onclick="changeYear(-1)">‚óÄ</button>
                <span id="currentYear">2025</span>
                <button class="year-btn" onclick="changeYear(1)">‚ñ∂</button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <button class="btn btn-success" onclick="autoFillWithBalance()">‚ö° Remplissage Intelligent</button>
            <button class="btn btn-success" onclick="fillWithPredefinedPairs()">üéØ Remplir avec Bin√¥mes</button>
            <button class="btn btn-primary" onclick="showAssignModal()">‚ûï Assigner Semaine</button>
            <button class="btn btn-warning" onclick="showVacationModal()">üèñÔ∏è Ajouter Absence</button>
            <button class="btn btn-info" onclick="exportAll()">üíæ Export JSON</button>
            <button class="btn btn-success" onclick="showImportModal()">üìÇ Import JSON</button>
            <button class="btn btn-info" onclick="exportCalendars()">üìÖ Export Calendriers</button>
            <button class="btn btn-dark" onclick="showTeamEditModal()">üë• √âditer √âquipe</button>
            <button class="btn btn-info" onclick="showPartnershipAnalysis()">üìä Analyser Bin√¥mes</button>
            <button class="btn btn-danger" onclick="confirmReboot()">üîÑ REBOOT</button>
        </div>

        <!-- Main Content -->
        <div class="tabs-container">
            <!-- Tabs Navigation -->
            <div class="tabs-nav">
                <button class="tab-btn active" onclick="switchTab('planning')">üìÖ Planning</button>
                <button class="tab-btn" onclick="switchTab('absences')">üèñÔ∏è Absences</button>
                <button class="tab-btn" onclick="switchTab('conflicts')">‚ö†Ô∏è Conflits</button>
                <button class="tab-btn" onclick="switchTab('team')">üë• √âquipe</button>
                <button class="tab-btn" onclick="switchTab('binomes')">üéØ Config Bin√¥mes</button>
                <button class="tab-btn" onclick="switchTab('partnerships')">ü§ù Analyse Bin√¥mes</button>
            </div>

            <!-- Planning Tab -->
            <div id="planningTab" class="tab-content active">
                <div class="stats-bar">
                    <div class="stat-box">
                        <div class="stat-number" id="weeksAssigned">0</div>
                        <div class="stat-label">Semaines Assign√©es</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="totalAbsences">0</div>
                        <div class="stat-label">P√©riodes d'Absence</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="conflictsCount">0</div>
                        <div class="stat-label">Conflits Actifs</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="progressPercent">0%</div>
                        <div class="stat-label">Progression</div>
                    </div>
                </div>
                <div class="calendar-year" id="yearView"></div>
            </div>

            <!-- Absences Tab -->
            <div id="absencesTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">Gestion des Absences</h2>
                <div id="absencesContainer"></div>
            </div>

            <!-- Conflicts Tab -->
            <div id="conflictsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">Centre de R√©solution des Conflits</h2>
                <div id="conflictList"></div>
            </div>

            <!-- Team Tab -->
            <div id="teamTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">Tableau de l'√âquipe</h2>
                <table>
                    <thead>
                        <tr>
                            <th>R√©f√©rent</th>
                            <th>Semaines Principal</th>
                            <th>Semaines Backup</th>
                            <th>Jours Absence</th>
                            <th>Charge (%)</th>
                        </tr>
                    </thead>
                    <tbody id="teamTableBody"></tbody>
                </table>
            </div>

            <!-- Config Bin√¥mes Tab -->
            <div id="binomesTab" class="tab-content">
                <h2 style="margin-bottom: 30px; color: #2c3e50;">üéØ Configuration des Bin√¥mes Pr√©d√©finis</h2>
                
                <div style="background: #e8f5e9; border: 2px solid #27ae60; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                    <h4 style="color: #27ae60; margin-bottom: 10px;">üí° Comment √ßa fonctionne ?</h4>
                    <p style="color: #2c3e50; margin: 0;">
                        D√©finissez vos bin√¥mes pr√©f√©r√©s ci-dessous, puis utilisez le bouton <strong>"üéØ Remplir avec Bin√¥mes"</strong> 
                        dans la barre d'outils. L'algorithme fera tourner intelligemment vos bin√¥mes sur l'ann√©e enti√®re 
                        en √©vitant les r√©p√©titions et en √©quilibrant les charges.
                    </p>
                </div>

                <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin: 0;">üìù Vos Bin√¥mes Pr√©d√©finis</h3>
                        <button class="btn btn-primary" onclick="addPredefinedPair()">+ Ajouter un Bin√¥me</button>
                    </div>
                    
                    <div id="predefinedPairsList" style="display: grid; gap: 15px;">
                        <!-- G√©n√©r√© dynamiquement -->
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ecf0f1;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn btn-warning" onclick="resetPredefinedPairs()">üîÑ Bin√¥mes par D√©faut</button>
                            <button class="btn btn-success" onclick="savePredefinedPairs()">‚úÖ Sauvegarder Configuration</button>
                        </div>
                    </div>
                </div>

                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin-top: 30px;">
                    <h4 style="color: #856404; margin-bottom: 15px;">‚öôÔ∏è Conseils d'optimisation</h4>
                    <ul style="color: #856404; margin: 0; padding-left: 20px;">
                        <li><strong>√âquilibre :</strong> Essayez de cr√©er des bin√¥mes avec des niveaux d'exp√©rience compl√©mentaires</li>
                        <li><strong>Diversit√© :</strong> L'algorithme fera tourner vos bin√¥mes automatiquement</li>
                        <li><strong>Backup :</strong> Les backups seront assign√©s automatiquement parmi les membres libres</li>
                        <li><strong>Flexibilit√© :</strong> Vous pouvez toujours modifier manuellement apr√®s le remplissage</li>
                    </ul>
                </div>
            </div>

            <!-- Partnership Analysis Tab -->
            <div id="partnershipsTab" class="tab-content">
                <h2 style="margin-bottom: 30px; color: #2c3e50;">ü§ù Analyse des Bin√¥mes</h2>
                
                <div class="stats-bar">
                    <div class="stat-box">
                        <div class="stat-number" id="totalPartnerships">0</div>
                        <div class="stat-label">Bin√¥mes Diff√©rents</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="maxPartnership">0</div>
                        <div class="stat-label">Partenariat Max</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="diversityScore">0%</div>
                        <div class="stat-label">Score Diversit√©</div>
                    </div>
                </div>

                <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">üî• Matrice de Collaboration</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        Cette matrice montre le nombre de fois o√π chaque paire de r√©f√©rents a travaill√© ensemble.
                    </p>
                    <div id="collaborationHeatmap"></div>
                </div>

                <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">üìã D√©tail des Partenariats</h3>
                    <div id="partnershipDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="assignModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assignModal')">&times;</span>
            <h2>üìÖ Assigner une Semaine</h2>
            <form onsubmit="saveAssignment(event)">
                <div class="form-group">
                    <label>Semaine</label>
                    <input type="week" id="weekInput" required>
                </div>
                <div class="form-group">
                    <label>Bin√¥me</label>
                    <div class="form-row">
                        <select id="member1" required>
                            <option value="">Membre 1</option>
                        </select>
                        <select id="member2" required>
                            <option value="">Membre 2</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Backup</label>
                    <select id="backup" required>
                        <option value="">S√©lectionner</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Enregistrer</button>
            </form>
        </div>
    </div>

    <div class="modal" id="vacationModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('vacationModal')">&times;</span>
            <h2>üèñÔ∏è Ajouter une Absence</h2>
            <form onsubmit="saveVacation(event)">
                <div class="form-group">
                    <label>R√©f√©rent</label>
                    <select id="vacationMember" required>
                        <option value="">S√©lectionner</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date de d√©but</label>
                    <input type="date" id="vacationStart" required>
                </div>
                <div class="form-group">
                    <label>Date de fin</label>
                    <input type="date" id="vacationEnd" required>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Enregistrer</button>
            </form>
        </div>
    </div>

    <div class="modal" id="teamEditModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('teamEditModal')">&times;</span>
            <h2>üë• √âditer les Noms des R√©f√©rents</h2>
            <form onsubmit="saveTeamNames(event)">
                <div id="teamEditList" style="display: grid; gap: 10px;"></div>
                <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button type="button" class="btn btn-warning" onclick="resetTeamNames()">üîÑ R√©initialiser</button>
                    <button type="submit" class="btn btn-success">‚úÖ Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="importModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('importModal')">&times;</span>
            <h2>üìÇ Importer des Donn√©es JSON</h2>
            
            <div style="background: #e8f5e9; border: 2px solid #27ae60; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h4 style="color: #27ae60; margin-bottom: 10px;">üí° Instructions</h4>
                <ul style="color: #2c3e50; margin: 0; padding-left: 20px;">
                    <li>S√©lectionnez un fichier JSON export√© pr√©c√©demment</li>
                    <li>Toutes les donn√©es actuelles seront remplac√©es</li>
                    <li>Une sauvegarde automatique sera cr√©√©e avant l'import</li>
                </ul>
            </div>
            
            <form onsubmit="importData(event)">
                <div class="form-group">
                    <label>Fichier JSON</label>
                    <input type="file" id="jsonFileInput" accept=".json" required
                           style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px;">
                </div>
                
                <div id="importPreview" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">üìã Aper√ßu des donn√©es</h4>
                    <div id="importSummary"></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-warning" onclick="createBackup()">üíæ Cr√©er Sauvegarde</button>
                    <button type="submit" class="btn btn-success" id="importBtn" disabled>üìÇ Importer</button>
                </div>
            </form>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Variables globales
        let TEAM = ['R√©f√©rent 1', 'R√©f√©rent 2', 'R√©f√©rent 3', 'R√©f√©rent 4', 'R√©f√©rent 5', 'R√©f√©rent 6', 'R√©f√©rent 7', 'R√©f√©rent 8', 'R√©f√©rent 9'];
        let currentYear = 2025;
        let assignments = {};
        let vacations = {};
        let conflicts = [];
        let predefinedPairs = [];

        // Fonction pour calculer le num√©ro de semaine ISO d'une date
        function getISOWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // Fonction pour obtenir toutes les semaines d'un mois donn√©
        function getWeeksInMonth(year, month) {
            const weeks = [];
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Trouver le premier lundi du mois (ou le lundi de la semaine qui contient le 1er)
            let currentDate = new Date(firstDay);
            
            // Reculer au lundi de la semaine qui contient le 1er du mois
            while (currentDate.getDay() !== 1) {
                currentDate.setDate(currentDate.getDate() - 1);
            }
            
            // Collecter toutes les semaines qui touchent ce mois
            while (currentDate <= lastDay || (currentDate.getMonth() === month && currentDate.getDate() <= 7)) {
                const weekNum = getISOWeekNumber(currentDate);
                
                // V√©rifier si cette semaine touche le mois en cours
                const weekStart = new Date(currentDate);
                const weekEnd = new Date(currentDate);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                if ((weekStart.getMonth() === month || weekEnd.getMonth() === month) ||
                    (weekStart < firstDay && weekEnd >= firstDay) ||
                    (weekStart <= lastDay && weekEnd > lastDay)) {
                    
                    if (!weeks.includes(weekNum) && weekNum >= 1 && weekNum <= 53) {
                        weeks.push(weekNum);
                    }
                }
                
                currentDate.setDate(currentDate.getDate() + 7);
            }
            
            return weeks.sort((a, b) => a - b);
        }

        // Fonction pour obtenir les dates de d√©but et fin d'une semaine
        function getWeekDates(year, weekNum) {
            const jan4 = new Date(year, 0, 4);
            const jan4Day = jan4.getDay() || 7;
            const firstMonday = new Date(jan4);
            firstMonday.setDate(jan4.getDate() - jan4Day + 1);
            
            const weekStart = new Date(firstMonday);
            weekStart.setDate(firstMonday.getDate() + (weekNum - 1) * 7);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            return { start: weekStart, end: weekEnd };
        }

        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
            document.getElementById('jsonFileInput').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importBtn').disabled = true;
        }

        function createBackup() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const backupData = {
                version: '3.1-backup',
                backupDate: new Date().toISOString(),
                year: currentYear,
                assignments: assignments,
                vacations: vacations,
                teamNames: TEAM,
                predefinedPairs: predefinedPairs
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_planning_${timestamp}.json`;
            link.click();
            
            showNotification('üíæ Sauvegarde cr√©√©e avec succ√®s', 'success');
        }

        // Gestionnaire pour le changement de fichier
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application initialis√©e avec correction des semaines');
            loadData();
            populateSelects();
            updateAllDisplays();
            
            // Ajouter l'√©v√©nement pour l'input file
            const fileInput = document.getElementById('jsonFileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('importPreview').style.display = 'none';
                document.getElementById('importBtn').disabled = true;
                return;
            }
            
            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                showNotification('‚ùå Veuillez s√©lectionner un fichier JSON valide', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    validateAndPreviewImport(data);
                } catch (error) {
                    showNotification('‚ùå Fichier JSON invalide: ' + error.message, 'error');
                    document.getElementById('importPreview').style.display = 'none';
                    document.getElementById('importBtn').disabled = true;
                }
            };
            reader.readAsText(file);
        }

        function validateAndPreviewImport(data) {
            const preview = document.getElementById('importPreview');
            const summary = document.getElementById('importSummary');
            const importBtn = document.getElementById('importBtn');
            
            // Validation basique
            if (!data || typeof data !== 'object') {
                showNotification('‚ùå Structure de donn√©es invalide', 'error');
                preview.style.display = 'none';
                importBtn.disabled = true;
                return;
            }
            
            // Extraire les informations
            const year = data.year || 'Non sp√©cifi√©e';
            const teamNames = data.teamNames || [];
            const assignmentsCount = Object.keys(data.assignments || {}).length;
            const vacationsCount = Object.values(data.vacations || {}).reduce((sum, v) => sum + v.length, 0);
            const predefinedPairsCount = (data.predefinedPairs || []).length;
            const exportDate = data.exportDate || data.lastModified || 'Inconnue';
            
            // Afficher l'aper√ßu
            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong>üìÖ Ann√©e:</strong> ${year}<br>
                        <strong>üë• √âquipe:</strong> ${teamNames.length} membres<br>
                        <strong>üìù Assignations:</strong> ${assignmentsCount} semaines
                    </div>
                    <div>
                        <strong>üèñÔ∏è Absences:</strong> ${vacationsCount} p√©riodes<br>
                        <strong>üéØ Bin√¥mes:</strong> ${predefinedPairsCount} pr√©d√©finis<br>
                        <strong>üìä Export:</strong> ${new Date(exportDate).toLocaleDateString()}
                    </div>
                </div>
                
                ${teamNames.length > 0 ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <strong>üë• Membres de l'√©quipe:</strong><br>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                            ${teamNames.map(name => `<span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">${name}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            
            preview.style.display = 'block';
            importBtn.disabled = false;
            
            // Stocker les donn√©es pour l'import
            window.pendingImportData = data;
        }

        function importData(event) {
            event.preventDefault();
            
            if (!window.pendingImportData) {
                showNotification('‚ùå Aucune donn√©e √† importer', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ATTENTION: Cette action remplacera toutes les donn√©es actuelles.\n\nContinuer l\'import?')) {
                return;
            }
            
            const data = window.pendingImportData;
            
            try {
                // Importer les donn√©es
                if (data.teamNames && Array.isArray(data.teamNames)) {
                    TEAM = data.teamNames;
                }
                
                if (data.year) {
                    currentYear = data.year;
                    document.getElementById('currentYear').textContent = currentYear;
                }
                
                assignments = data.assignments || {};
                vacations = data.vacations || {};
                predefinedPairs = data.predefinedPairs || [];
                
                // Sauvegarder et mettre √† jour
                saveData();
                populateSelects();
                updateAllDisplays();
                
                closeModal('importModal');
                
                // Afficher un rapport d'import
                const assignmentsCount = Object.keys(assignments).length;
                const vacationsCount = Object.values(vacations).reduce((sum, v) => sum + v.length, 0);
                
                showNotification('‚úÖ Import r√©ussi !', 'success');
                
                setTimeout(() => {
                    alert(`üìÇ Import termin√© avec succ√®s !\n\n` +
                          `üìÖ Ann√©e: ${currentYear}\n` +
                          `üë• √âquipe: ${TEAM.length} membres\n` +
                          `üìù Assignations: ${assignmentsCount} semaines\n` +
                          `üèñÔ∏è Absences: ${vacationsCount} p√©riodes\n` +
                          `üéØ Bin√¥mes: ${predefinedPairs.length} pr√©d√©finis`);
                }, 1000);
                
            } catch (error) {
                console.error('Erreur lors de l\'import:', error);
                showNotification('‚ùå Erreur lors de l\'import: ' + error.message, 'error');
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application initialis√©e avec correction des semaines');
            loadData();
            populateSelects();
            updateAllDisplays();
        });

        // Gestion des donn√©es
        function loadData() {
            const saved = localStorage.getItem('planningData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.teamNames) TEAM = data.teamNames;
                    assignments = data.assignments || {};
                    vacations = data.vacations || {};
                    predefinedPairs = data.predefinedPairs || [];
                    currentYear = data.year || currentYear;
                    console.log('Donn√©es charg√©es:', data);
                } catch (e) {
                    console.error('Erreur chargement:', e);
                }
            }
            document.getElementById('currentYear').textContent = currentYear;
        }

        function saveData() {
            const data = {
                year: currentYear,
                assignments: assignments,
                vacations: vacations,
                teamNames: TEAM,
                predefinedPairs: predefinedPairs,
                lastModified: new Date().toISOString()
            };
            localStorage.setItem('planningData', JSON.stringify(data));
            console.log('Donn√©es sauvegard√©es');
        }

        // Gestion des onglets
        function switchTab(tabName) {
            console.log('Changement onglet:', tabName);
            
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activer l'onglet s√©lectionn√©
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Mettre √† jour le contenu si n√©cessaire
            if (tabName === 'partnerships') {
                updatePartnershipAnalysis();
            } else if (tabName === 'binomes') {
                updatePredefinedPairsList();
            }
        }

        // Mise √† jour des affichages
        function updateAllDisplays() {
            updateStats();
            updateYearView();
            updateAbsencesView();
            updateTeamTable();
            updateConflictDisplay();
            detectConflicts();
        }

        function updateStats() {
            const totalWeeks = 52;
            const assignedWeeks = Object.keys(assignments).filter(key => key.startsWith(`${currentYear}-W`)).length;
            const totalAbsences = Object.values(vacations).reduce((sum, v) => sum + v.length, 0);
            const conflictCount = conflicts.length;
            const progress = Math.round((assignedWeeks / totalWeeks) * 100);
            
            document.getElementById('weeksAssigned').textContent = assignedWeeks;
            document.getElementById('totalAbsences').textContent = totalAbsences;
            document.getElementById('conflictsCount').textContent = conflictCount;
            document.getElementById('progressPercent').textContent = progress + '%';
        }

        function calculateWorkloads() {
            const workloads = {};
            TEAM.forEach(member => {
                workloads[member] = { principal: 0, backup: 0, total: 0 };
            });
            
            Object.values(assignments).forEach(assignment => {
                if (workloads[assignment.member1]) workloads[assignment.member1].principal++;
                if (workloads[assignment.member2]) workloads[assignment.member2].principal++;
                if (workloads[assignment.backup]) workloads[assignment.backup].backup++;
            });
            
            Object.keys(workloads).forEach(member => {
                workloads[member].total = workloads[member].principal + (workloads[member].backup * 0.5);
            });
            
            return workloads;
        }

        function detectConflicts() {
            conflicts = [];
            // Logique de d√©tection des conflits simplifi√©e
            console.log('Conflits d√©tect√©s:', conflicts.length);
        }

        function updateYearView() {
            const container = document.getElementById('yearView');
            if (!container) return;
            
            container.innerHTML = '';
            const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            
            months.forEach((month, monthIndex) => {
                const monthBlock = document.createElement('div');
                monthBlock.className = 'month-block';
                
                const header = document.createElement('div');
                header.className = 'month-header';
                header.textContent = month;
                monthBlock.appendChild(header);
                
                const weeksContainer = document.createElement('div');
                weeksContainer.className = 'weeks-container';
                
                // Obtenir les vraies semaines de ce mois
                const weeksInMonth = getWeeksInMonth(currentYear, monthIndex);
                
                weeksInMonth.forEach(weekNum => {
                    const weekRow = document.createElement('div');
                    weekRow.className = 'week-row';
                    
                    const weekKey = `${currentYear}-W${weekNum.toString().padStart(2, '0')}`;
                    const assignment = assignments[weekKey];
                    
                    if (assignment) {
                        weekRow.classList.add('assigned');
                    }
                    
                    // Obtenir les dates de la semaine pour affichage
                    const weekDates = getWeekDates(currentYear, weekNum);
                    const startDate = weekDates.start.getDate();
                    const endDate = weekDates.end.getDate();
                    
                    weekRow.innerHTML = `
                        <span style="font-weight: bold;">S${weekNum} (${startDate}-${endDate})</span>
                        <span>${assignment ? `${assignment.member1} + ${assignment.member2}` : 'Non assign√©e'}</span>
                    `;
                    
                    weekRow.onclick = () => editWeek(weekNum);
                    weeksContainer.appendChild(weekRow);
                });
                
                monthBlock.appendChild(weeksContainer);
                container.appendChild(monthBlock);
            });
        }

        function updateAbsencesView() {
            const container = document.getElementById('absencesContainer');
            if (!container) return;
            
            container.innerHTML = '';
            container.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;';
            
            TEAM.forEach(member => {
                const card = document.createElement('div');
                card.style.cssText = 'border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f8f9fa;';
                
                const memberVacations = vacations[member] || [];
                
                card.innerHTML = `
                    <h4 style="color: #2c3e50; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #3498db;">
                        ${member} (${memberVacations.length} absences)
                    </h4>
                    ${memberVacations.length === 0 ? 
                        '<p style="color: #666; font-style: italic;">Aucune absence</p>' :
                        memberVacations.map(vac => `
                            <div style="background: white; padding: 10px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                                <span>${vac.start} - ${vac.end}</span>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteVacation('${member}', '${vac.start}', '${vac.end}')">üóëÔ∏è</button>
                            </div>
                        `).join('')
                    }
                `;
                
                container.appendChild(card);
            });
        }

        function updateTeamTable() {
            const tbody = document.getElementById('teamTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            const workloads = calculateWorkloads();
            
            TEAM.forEach(member => {
                const workload = workloads[member];
                const absenceDays = vacations[member] ? vacations[member].length * 7 : 0; // Approximation
                const chargePercent = Math.round((workload.total / 52) * 100);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${member}</strong></td>
                    <td>${workload.principal}</td>
                    <td>${workload.backup}</td>
                    <td>${absenceDays}</td>
                    <td>${chargePercent}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateConflictDisplay() {
            const container = document.getElementById('conflictList');
            if (!container) return;
            
            if (conflicts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #27ae60;">
                        <h3>‚úÖ Aucun conflit d√©tect√©</h3>
                        <p>Le planning est optimal</p>
                    </div>
                `;
            } else {
                container.innerHTML = '<p>Conflits d√©tect√©s √† r√©soudre.</p>';
            }
        }

        // Analyse des bin√¥mes
        function calculatePartnershipStats() {
            const partnerships = {};
            const memberStats = {};
            
            TEAM.forEach(member => {
                memberStats[member] = { collaborations: {} };
            });
            
            Object.values(assignments).forEach(assignment => {
                const member1 = assignment.member1;
                const member2 = assignment.member2;
                
                if (member1 && member2 && TEAM.includes(member1) && TEAM.includes(member2)) {
                    const partnershipKey = [member1, member2].sort().join(' + ');
                    
                    if (!partnerships[partnershipKey]) {
                        partnerships[partnershipKey] = { members: [member1, member2], count: 0 };
                    }
                    partnerships[partnershipKey].count++;
                    
                    if (!memberStats[member1].collaborations[member2]) {
                        memberStats[member1].collaborations[member2] = 0;
                    }
                    if (!memberStats[member2].collaborations[member1]) {
                        memberStats[member2].collaborations[member1] = 0;
                    }
                    memberStats[member1].collaborations[member2]++;
                    memberStats[member2].collaborations[member1]++;
                }
            });
            
            return { partnerships, memberStats };
        }

        function updatePartnershipAnalysis() {
            const { partnerships, memberStats } = calculatePartnershipStats();
            
            const totalPartnerships = Object.keys(partnerships).length;
            const maxPartnership = Object.values(partnerships).length > 0 ? 
                Math.max(...Object.values(partnerships).map(p => p.count)) : 0;
            
            const maxPossiblePartnerships = (TEAM.length * (TEAM.length - 1)) / 2;
            const diversityScore = Math.round((totalPartnerships / maxPossiblePartnerships) * 100);
            
            if (document.getElementById('totalPartnerships')) {
                document.getElementById('totalPartnerships').textContent = totalPartnerships;
                document.getElementById('maxPartnership').textContent = maxPartnership;
                document.getElementById('diversityScore').textContent = diversityScore + '%';
            }
            
            updateCollaborationHeatmap(memberStats);
            updatePartnershipDetails(partnerships);
        }

        function updateCollaborationHeatmap(memberStats) {
            const container = document.getElementById('collaborationHeatmap');
            if (!container) return;
            
            const maxCollaborations = Math.max(...TEAM.flatMap(member1 => 
                TEAM.map(member2 => member1 !== member2 ? (memberStats[member1]?.collaborations[member2] || 0) : 0)
            ));
            
            let gridHTML = '<div class="heatmap-grid" style="grid-template-columns: 100px repeat(' + TEAM.length + ', 1fr);">';
            
            // Header row
            gridHTML += '<div class="heatmap-cell" style="background: #34495e;"></div>';
            TEAM.forEach(member => {
                gridHTML += `<div class="heatmap-cell" style="background: #34495e;">${member.split(' ')[1] || member.substring(0, 3)}</div>`;
            });
            
            // Data rows
            TEAM.forEach(member1 => {
                gridHTML += `<div class="heatmap-cell" style="background: #34495e; text-align: left; padding-left: 5px;">${member1.split(' ')[1] || member1.substring(0, 3)}</div>`;
                TEAM.forEach(member2 => {
                    if (member1 === member2) {
                        gridHTML += '<div class="heatmap-cell" style="background: #95a5a6;">-</div>';
                    } else {
                        const count = memberStats[member1]?.collaborations[member2] || 0;
                        const intensity = maxCollaborations > 0 ? count / maxCollaborations : 0;
                        const color = getHeatmapColor(intensity);
                        gridHTML += `<div class="heatmap-cell" style="background: ${color};" title="${member1} + ${member2}: ${count} fois">${count}</div>`;
                    }
                });
            });
            
            gridHTML += '</div>';
            container.innerHTML = gridHTML;
        }

        function getHeatmapColor(intensity) {
            if (intensity === 0) return '#ecf0f1';
            if (intensity <= 0.3) return '#d5dbdb';
            if (intensity <= 0.6) return '#85c1e9';
            return '#3498db';
        }

        function updatePartnershipDetails(partnerships) {
            const container = document.getElementById('partnershipDetails');
            if (!container) return;
            
            const sortedPartnerships = Object.entries(partnerships).sort(([,a], [,b]) => b.count - a.count);
            
            if (sortedPartnerships.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Aucun bin√¥me assign√© pour le moment.</p>';
                return;
            }
            
            container.innerHTML = '<div class="partnership-grid">' +
                sortedPartnerships.map(([key, partnership]) => {
                    const [member1, member2] = partnership.members;
                    const isFrequent = partnership.count >= 3;
                    const borderColor = isFrequent ? '#e74c3c' : '#3498db';
                    
                    return `
                        <div class="partnership-card" style="border-left-color: ${borderColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="color: #2c3e50; margin: 0;">${member1} + ${member2}</h4>
                                <span style="background: ${borderColor}; color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 14px;">${partnership.count}x</span>
                            </div>
                            <div style="font-size: 14px; color: #666;">
                                ${isFrequent ? 
                                    '<span style="color: #e74c3c;">‚ö†Ô∏è Partenariat fr√©quent</span>' : 
                                    '<span style="color: #27ae60;">‚úì Partenariat √©quilibr√©</span>'
                                }
                            </div>
                        </div>
                    `;
                }).join('') + '</div>';
        }

        // Gestion des bin√¥mes pr√©d√©finis
        function updatePredefinedPairsList() {
            const container = document.getElementById('predefinedPairsList');
            if (!container) return;
            
            // Initialiser avec des bin√¥mes par d√©faut si vide
            if (predefinedPairs.length === 0) {
                resetPredefinedPairs();
                return;
            }
            
            container.innerHTML = predefinedPairs.map((pair, index) => `
                <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                    <span style="font-weight: bold; color: #666; width: 80px;">Bin√¥me ${index + 1}:</span>
                    
                    <select id="pair${index}_member1" style="flex: 1; padding: 8px; border: 2px solid #ecf0f1; border-radius: 5px;">
                        <option value="">Membre 1</option>
                        ${TEAM.map(member => `<option value="${member}" ${pair.member1 === member ? 'selected' : ''}>${member}</option>`).join('')}
                    </select>
                    
                    <span style="font-weight: bold; color: #3498db;">+</span>
                    
                    <select id="pair${index}_member2" style="flex: 1; padding: 8px; border: 2px solid #ecf0f1; border-radius: 5px;">
                        <option value="">Membre 2</option>
                        ${TEAM.map(member => `<option value="${member}" ${pair.member2 === member ? 'selected' : ''}>${member}</option>`).join('')}
                    </select>
                    
                    <button class="btn btn-danger" style="padding: 8px 12px; font-size: 12px;" onclick="removePredefinedPair(${index})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function addPredefinedPair() {
            predefinedPairs.push({ member1: '', member2: '' });
            updatePredefinedPairsList();
            showNotification('‚ûï Nouveau bin√¥me ajout√©', 'info');
        }

        function removePredefinedPair(index) {
            if (predefinedPairs.length <= 1) {
                showNotification('‚ùå Vous devez garder au moins un bin√¥me', 'error');
                return;
            }
            
            predefinedPairs.splice(index, 1);
            updatePredefinedPairsList();
            showNotification('üóëÔ∏è Bin√¥me supprim√©', 'warning');
        }

        function resetPredefinedPairs() {
            // Cr√©er des bin√¥mes par d√©faut intelligents
            predefinedPairs = [
                { member1: TEAM[0], member2: TEAM[1] },
                { member1: TEAM[2], member2: TEAM[3] },
                { member1: TEAM[4], member2: TEAM[5] },
                { member1: TEAM[6], member2: TEAM[7] }
            ];
            updatePredefinedPairsList();
            showNotification('üîÑ Bin√¥mes par d√©faut cr√©√©s', 'info');
        }

        function savePredefinedPairs() {
            const newPairs = [];
            
            for (let i = 0; i < predefinedPairs.length; i++) {
                const member1 = document.getElementById(`pair${i}_member1`).value;
                const member2 = document.getElementById(`pair${i}_member2`).value;
                
                if (!member1 || !member2) {
                    showNotification(`‚ùå Bin√¥me ${i + 1}: Veuillez s√©lectionner les deux membres`, 'error');
                    return;
                }
                
                if (member1 === member2) {
                    showNotification(`‚ùå Bin√¥me ${i + 1}: Les membres doivent √™tre diff√©rents`, 'error');
                    return;
                }
                
                // V√©rifier les doublons
                const pairKey = [member1, member2].sort().join('|');
                if (newPairs.some(p => [p.member1, p.member2].sort().join('|') === pairKey)) {
                    showNotification(`‚ùå Bin√¥me ${i + 1}: Ce bin√¥me existe d√©j√†`, 'error');
                    return;
                }
                
                newPairs.push({ member1, member2 });
            }
            
            predefinedPairs = newPairs;
            saveData();
            showNotification('‚úÖ Configuration des bin√¥mes sauvegard√©e !', 'success');
        }

        // Remplissage avec bin√¥mes pr√©d√©finis
        function fillWithPredefinedPairs() {
            if (predefinedPairs.length === 0) {
                showNotification('‚ùå Veuillez d\'abord configurer vos bin√¥mes dans l\'onglet "Config Bin√¥mes"', 'error');
                return;
            }
            
            // Validation des bin√¥mes
            for (let pair of predefinedPairs) {
                if (!pair.member1 || !pair.member2 || pair.member1 === pair.member2) {
                    showNotification('‚ùå Certains bin√¥mes sont mal configur√©s. V√©rifiez l\'onglet "Config Bin√¥mes"', 'error');
                    return;
                }
            }
            
            if (!confirm(`Remplir l'ann√©e avec vos ${predefinedPairs.length} bin√¥mes pr√©d√©finis ?\n\nCela utilisera une rotation intelligente de vos bin√¥mes.`)) return;
            
            const pairUsageCount = new Array(predefinedPairs.length).fill(0);
            const memberLastWeek = {};
            
            // Initialiser le suivi des derni√®res semaines
            TEAM.forEach(member => {
                memberLastWeek[member] = 0;
            });
            
            for (let week = 1; week <= 52; week++) {
                const weekKey = `${currentYear}-W${week.toString().padStart(2, '0')}`;
                
                // Trouver le bin√¥me le moins utilis√© dont les membres sont disponibles
                let bestPairIndex = -1;
                let minUsage = Infinity;
                
                for (let i = 0; i < predefinedPairs.length; i++) {
                    const pair = predefinedPairs[i];
                    const member1LastWeek = memberLastWeek[pair.member1] || 0;
                    const member2LastWeek = memberLastWeek[pair.member2] || 0;
                    
                    // √âviter d'assigner quelqu'un deux semaines de suite
                    if (week - member1LastWeek >= 2 && week - member2LastWeek >= 2) {
                        if (pairUsageCount[i] < minUsage) {
                            minUsage = pairUsageCount[i];
                            bestPairIndex = i;
                        }
                    }
                }
                
                // Si aucun bin√¥me n'est disponible, prendre le moins utilis√© quand m√™me
                if (bestPairIndex === -1) {
                    bestPairIndex = pairUsageCount.indexOf(Math.min(...pairUsageCount));
                }
                
                const selectedPair = predefinedPairs[bestPairIndex];
                
                // S√©lectionner le backup parmi les membres non utilis√©s cette semaine
                const usedMembers = [selectedPair.member1, selectedPair.member2];
                const availableForBackup = TEAM.filter(member => !usedMembers.includes(member))
                    .sort((a, b) => (memberLastWeek[a] || 0) - (memberLastWeek[b] || 0));
                
                const backup = availableForBackup[0];
                
                // Enregistrer l'assignation
                assignments[weekKey] = {
                    member1: selectedPair.member1,
                    member2: selectedPair.member2,
                    backup: backup
                };
                
                // Mettre √† jour les compteurs
                pairUsageCount[bestPairIndex]++;
                memberLastWeek[selectedPair.member1] = week;
                memberLastWeek[selectedPair.member2] = week;
                memberLastWeek[backup] = week;
            }
            
            saveData();
            updateAllDisplays();
            
            // Afficher un rapport
            const report = predefinedPairs.map((pair, index) => 
                `${pair.member1} + ${pair.member2}: ${pairUsageCount[index]} fois`
            ).join('\n');
            
            showNotification('‚úÖ Planning rempli avec vos bin√¥mes pr√©d√©finis !', 'success');
            
            setTimeout(() => {
                alert(`üéØ Rapport de r√©partition:\n\n${report}\n\nTotal: 52 semaines assign√©es`);
            }, 1000);
        }

        // Remplissage automatique avec rotation intelligente (fonction originale)
        function autoFillWithBalance() {
            if (!confirm('Remplir automatiquement l\'ann√©e avec une rotation intelligente des bin√¥mes?')) return;
            
            const memberAssignments = {};
            const partnershipHistory = {};
            
            TEAM.forEach(member => {
                memberAssignments[member] = { principal: 0, backup: 0, lastWeek: 0, partners: new Set() };
            });
            
            function getPartnershipScore(member1, member2) {
                const key = [member1, member2].sort().join('|');
                return partnershipHistory[key] || 0;
            }
            
            function updatePartnershipHistory(member1, member2) {
                const key = [member1, member2].sort().join('|');
                partnershipHistory[key] = (partnershipHistory[key] || 0) + 1;
                memberAssignments[member1].partners.add(member2);
                memberAssignments[member2].partners.add(member1);
            }
            
            for (let week = 1; week <= 52; week++) {
                const weekKey = `${currentYear}-W${week.toString().padStart(2, '0')}`;
                
                // Filtrer les membres disponibles (pas assign√©s la semaine pr√©c√©dente)
                const availableMembers = [...TEAM].filter(member => {
                    return week - memberAssignments[member].lastWeek >= 2;
                }).sort((a, b) => {
                    const scoreA = memberAssignments[a].principal * 2 + memberAssignments[a].backup;
                    const scoreB = memberAssignments[b].principal * 2 + memberAssignments[b].backup;
                    return scoreA - scoreB;
                });
                
                if (availableMembers.length < 3) {
                    availableMembers.push(...TEAM.filter(m => !availableMembers.includes(m)));
                }
                
                // Trouver le meilleur bin√¥me (moins utilis√© ensemble)
                let bestPair = null;
                let bestScore = Infinity;
                
                for (let i = 0; i < Math.min(6, availableMembers.length); i++) {
                    for (let j = i + 1; j < Math.min(6, availableMembers.length); j++) {
                        const member1 = availableMembers[i];
                        const member2 = availableMembers[j];
                        
                        const partnershipScore = getPartnershipScore(member1, member2);
                        const workloadScore = memberAssignments[member1].principal + memberAssignments[member2].principal;
                        const diversityBonus = memberAssignments[member1].partners.has(member2) ? 10 : 0;
                        
                        const totalScore = partnershipScore * 5 + workloadScore + diversityBonus;
                        
                        if (totalScore < bestScore) {
                            bestScore = totalScore;
                            bestPair = [member1, member2];
                        }
                    }
                }
                
                const [member1, member2] = bestPair || [availableMembers[0], availableMembers[1]];
                
                // S√©lectionner le backup
                const availableForBackup = TEAM.filter(m => m !== member1 && m !== member2)
                    .sort((a, b) => memberAssignments[a].backup - memberAssignments[b].backup);
                
                const backup = availableForBackup[0];
                
                // Enregistrer l'assignation
                assignments[weekKey] = { member1, member2, backup };
                
                // Mettre √† jour les compteurs
                memberAssignments[member1].principal++;
                memberAssignments[member1].lastWeek = week;
                memberAssignments[member2].principal++;
                memberAssignments[member2].lastWeek = week;
                memberAssignments[backup].backup++;
                memberAssignments[backup].lastWeek = week;
                
                updatePartnershipHistory(member1, member2);
            }
            
            saveData();
            updateAllDisplays();
            showNotification('‚úÖ Planning rempli avec rotation intelligente des bin√¥mes !', 'success');
        }

        function showPartnershipAnalysis() {
            switchTab('partnerships');
        }

        // Gestion des modals
        function populateSelects() {
            const selects = ['member1', 'member2', 'backup', 'vacationMember'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">S√©lectionner</option>';
                    TEAM.forEach(member => {
                        select.innerHTML += `<option value="${member}">${member}</option>`;
                    });
                }
            });
        }

        function showAssignModal() {
            document.getElementById('assignModal').style.display = 'block';
        }

        function showVacationModal() {
            document.getElementById('vacationModal').style.display = 'block';
        }

        function showTeamEditModal() {
            const modal = document.getElementById('teamEditModal');
            const list = document.getElementById('teamEditList');
            
            list.innerHTML = TEAM.map((member, index) => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                    <span style="font-weight: bold; color: #666; width: 30px;">${index + 1}.</span>
                    <input type="text" id="teamMember${index}" value="${member}" required
                           style="flex: 1; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px;"
                           placeholder="Nom du r√©f√©rent ${index + 1}">
                </div>
            `).join('');
            
            modal.style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function editWeek(weekNum) {
            const weekKey = `${currentYear}-W${weekNum.toString().padStart(2, '0')}`;
            document.getElementById('weekInput').value = weekKey;
            
            const assignment = assignments[weekKey];
            if (assignment) {
                document.getElementById('member1').value = assignment.member1;
                document.getElementById('member2').value = assignment.member2;
                document.getElementById('backup').value = assignment.backup;
            } else {
                document.getElementById('member1').value = '';
                document.getElementById('member2').value = '';
                document.getElementById('backup').value = '';
            }
            
            showAssignModal();
        }

        function saveAssignment(event) {
            event.preventDefault();
            
            const weekValue = document.getElementById('weekInput').value;
            const member1 = document.getElementById('member1').value;
            const member2 = document.getElementById('member2').value;
            const backup = document.getElementById('backup').value;
            
            if (member1 === member2 || member1 === backup || member2 === backup) {
                showNotification('‚ùå Les membres doivent √™tre diff√©rents', 'error');
                return;
            }
            
            assignments[weekValue] = { member1, member2, backup };
            
            saveData();
            closeModal('assignModal');
            updateAllDisplays();
            showNotification('‚úÖ Assignation enregistr√©e', 'success');
        }

        function saveVacation(event) {
            event.preventDefault();
            
            const member = document.getElementById('vacationMember').value;
            const start = document.getElementById('vacationStart').value;
            const end = document.getElementById('vacationEnd').value;
            
            if (new Date(end) < new Date(start)) {
                showNotification('‚ùå Date de fin invalide', 'error');
                return;
            }
            
            if (!vacations[member]) vacations[member] = [];
            vacations[member].push({ start, end });
            
            saveData();
            closeModal('vacationModal');
            updateAllDisplays();
            showNotification(`‚úÖ Absence enregistr√©e pour ${member}`, 'success');
        }

        function saveTeamNames(event) {
            event.preventDefault();
            
            const newNames = [];
            for (let i = 0; i < TEAM.length; i++) {
                const newName = document.getElementById(`teamMember${i}`).value.trim();
                if (!newName) {
                    showNotification('‚ùå Tous les noms doivent √™tre remplis', 'error');
                    return;
                }
                newNames.push(newName);
            }
            
            const uniqueNames = new Set(newNames);
            if (uniqueNames.size !== newNames.length) {
                showNotification('‚ùå Les noms doivent √™tre uniques', 'error');
                return;
            }
            
            TEAM = newNames;
            saveData();
            populateSelects();
            updatePredefinedPairsList(); // Mettre √† jour les bin√¥mes aussi
            updateAllDisplays();
            closeModal('teamEditModal');
            showNotification('‚úÖ Noms de l\'√©quipe mis √† jour', 'success');
        }

        function resetTeamNames() {
            const defaultNames = ['R√©f√©rent 1', 'R√©f√©rent 2', 'R√©f√©rent 3', 'R√©f√©rent 4', 'R√©f√©rent 5', 'R√©f√©rent 6', 'R√©f√©rent 7', 'R√©f√©rent 8', 'R√©f√©rent 9'];
            for (let i = 0; i < defaultNames.length; i++) {
                const input = document.getElementById(`teamMember${i}`);
                if (input) input.value = defaultNames[i];
            }
            showNotification('üîÑ Noms r√©initialis√©s', 'info');
        }

        function deleteVacation(member, start, end) {
            if (!confirm('Supprimer cette absence?')) return;
            
            vacations[member] = vacations[member].filter(v => !(v.start === start && v.end === end));
            saveData();
            updateAllDisplays();
            showNotification('‚úÖ Absence supprim√©e', 'success');
        }

        function exportAll() {
            const data = {
                version: '3.1',
                exportDate: new Date().toISOString(),
                year: currentYear,
                assignments: assignments,
                vacations: vacations,
                teamNames: TEAM
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `planning_${currentYear}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('üíæ Export JSON g√©n√©r√© avec succ√®s', 'success');
        }

        function exportCalendars() {
            let exportCount = 0;
            
            TEAM.forEach(member => {
                let icsContent = 'BEGIN:VCALENDAR\r\n';
                icsContent += 'VERSION:2.0\r\n';
                icsContent += 'PRODID:-//Planning Manager Pro//FR\r\n';
                icsContent += `X-WR-CALNAME:Planning ${member} - ${currentYear}\r\n`;
                
                Object.entries(assignments).forEach(([weekKey, assignment]) => {
                    if (!weekKey.startsWith(`${currentYear}-W`)) return;
                    
                    const weekNum = parseInt(weekKey.split('-W')[1]);
                    let role = null;
                    
                    if (assignment.member1 === member || assignment.member2 === member) {
                        role = 'R√©f√©rent Principal';
                    } else if (assignment.backup === member) {
                        role = 'Backup';
                    }
                    
                    if (role) {
                        const uid = `${weekKey}-${member.replace(/\s+/g, '_')}@planningpro`;
                        const weekDates = getWeekDates(currentYear, weekNum);
                        
                        // Formatter les dates pour ICS (YYYYMMDD)
                        const formatDateForICS = (date) => {
                            return date.getFullYear().toString() + 
                                   (date.getMonth() + 1).toString().padStart(2, '0') + 
                                   date.getDate().toString().padStart(2, '0');
                        };
                        
                        const startDate = formatDateForICS(weekDates.start);
                        const endDate = formatDateForICS(new Date(weekDates.end.getTime() + 24 * 60 * 60 * 1000)); // +1 jour pour exclusif
                        
                        icsContent += 'BEGIN:VEVENT\r\n';
                        icsContent += `UID:${uid}\r\n`;
                        icsContent += `DTSTART;VALUE=DATE:${startDate}\r\n`;
                        icsContent += `DTEND;VALUE=DATE:${endDate}\r\n`;
                        icsContent += `SUMMARY:${role} - Semaine ${weekNum}\r\n`;
                        icsContent += `DESCRIPTION:√âquipe: ${assignment.member1} + ${assignment.member2}, Backup: ${assignment.backup}\r\n`;
                        icsContent += 'END:VEVENT\r\n';
                    }
                });
                
                icsContent += 'END:VCALENDAR';
                
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a');
                const fileName = `planning_${member.replace(/\s+/g, '_')}_${currentYear}.ics`;
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                
                setTimeout(() => {
                    link.click();
                    exportCount++;
                    if (exportCount === TEAM.length) {
                        setTimeout(() => {
                            showNotification(`üìÖ ${exportCount} calendriers export√©s !`, 'success');
                        }, 500);
                    }
                }, exportCount * 100);
            });
        }

        function confirmReboot() {
            if (confirm('‚ö†Ô∏è ATTENTION: Cette action effacera TOUTES les donn√©es.\n\nContinuer?')) {
                assignments = {};
                vacations = {};
                conflicts = [];
                predefinedPairs = [];
                saveData();
                updateAllDisplays();
                showNotification('üîÑ Syst√®me r√©initialis√©', 'warning');
            }
        }

        function changeYear(delta) {
            currentYear += delta;
            document.getElementById('currentYear').textContent = currentYear;
            updateAllDisplays();
            saveData();
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Fermer les modals en cliquant dehors
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>
            
