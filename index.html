<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Manager - √âquipe R√©f√©rents Permis S</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
            gap: 15px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .year-selector button {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #6c757d;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .year-selector button:hover {
            background: #495057;
            transform: scale(1.1);
        }

        .main-content {
            padding: 30px;
            display: flex;
            gap: 20px;
        }

        .sidebar {
            width: 250px;
            flex-shrink: 0;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .main-panel {
            flex: 1;
            min-width: 0;
        }

        .sidebar h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .sidebar-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f1f3f4;
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .quick-stats {
            display: grid;
            gap: 10px;
        }

        .quick-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .quick-stat-value {
            font-weight: bold;
            color: #3498db;
        }

        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .calendar-scroll-container {
            overflow-x: auto;
            overflow-y: hidden;
            margin: 0 -25px;
            padding: 0 25px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(12, 300px);
            gap: 15px;
            min-width: 3600px;
        }

        .calendar-grid.year-view {
            grid-template-columns: repeat(4, 350px);
            min-width: 1400px;
        }

        .month-column {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            min-height: 400px;
            width: 100%;
        }

        .scroll-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            color: #6c757d;
            font-size: 0.9em;
        }

        .scroll-hint {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 1px solid #2196f3;
            border-radius: 20px;
            padding: 8px 16px;
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #1976d2;
        }

        .navigation-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .nav-btn {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .team-summary {
            display: grid;
            gap: 8px;
        }

        .team-member-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .member-name-short {
            font-weight: bold;
            color: #2c3e50;
        }

        .member-load {
            padding: 2px 6px;
            border-radius: 10px;
            color: white;
            font-size: 0.8em;
        }

        .load-balanced { background: #27ae60; }
        .load-under { background: #f39c12; }
        .load-over { background: #e74c3c; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 15px;
        }

        .month-column {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            min-height: 400px;
        }

        .month-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1em;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .week-item {
            background: white;
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .week-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .week-item.assigned {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #d5f4e6, #ffffff);
        }

        .week-item.vacation {
            border-left-color: #f39c12;
            background: linear-gradient(135deg, #fef5e7, #ffffff);
        }

        .week-item.conflict {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #fadbd8, #ffffff);
        }

        .week-date {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .week-assignment {
            font-weight: bold;
            color: #2c3e50;
        }

        .team-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .team-member {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .team-member:hover {
            border-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .member-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .member-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.5em;
            color: #3498db;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
        }

        .vacation-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input, 
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .binome-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .legend-color.assigned { background: #27ae60; }
        .legend-color.vacation { background: #f39c12; }
        .legend-color.conflict { background: #e74c3c; }
        .legend-color.unassigned { background: #dee2e6; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            margin: 5% auto;
            padding: 40px;
            border-radius: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            animation: scaleIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close {
            color: #64748b;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(248, 250, 252, 0.5);
        }

        .close:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            transform: scale(1.1) rotate(90deg);
        }

        .form-group {
            margin-bottom: 24px;
            animation: slideInLeft 0.4s ease-out;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e293b;
            font-size: 15px;
        }

        .form-group input, 
        .form-group select {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
            background: rgba(255,255,255,1);
        }

        .binome-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                padding: 20px;
                gap: 20px;
            }
            
            .sidebar {
                width: 100%;
                position: static;
                order: 2;
            }
            
            .main-panel {
                order: 1;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(12, 280px);
                min-width: 3360px;
            }
            
            .calendar-grid.year-view {
                grid-template-columns: repeat(4, 300px);
                min-width: 1200px;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
                padding: 20px;
            }
            
            .toolbar-group {
                justify-content: center;
            }
            
            .header {
                padding: 20px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 24px;
            }

            .container {
                margin: 10px;
                border-radius: 16px;
            }

            .legend {
                gap: 16px;
            }

            .navigation-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .calendar-grid {
                grid-template-columns: repeat(12, 240px);
                min-width: 2880px;
            }
            
            .calendar-grid.year-view {
                grid-template-columns: repeat(2, 260px);
                min-width: 520px;
            }
            
            .btn {
                font-size: 12px;
                padding: 8px 12px;
            }

            .sidebar {
                padding: 20px;
            }

            .main-content {
                padding: 16px;
            }

            .calendar-container {
                padding: 20px;
            }

            .team-panel {
                padding: 20px;
            }

            .binome-selector {
                grid-template-columns: 1fr;
            }
        }

        /* Animations d'entr√©e en s√©quence */
        .week-item:nth-child(1) { animation-delay: 0.1s; }
        .week-item:nth-child(2) { animation-delay: 0.15s; }
        .week-item:nth-child(3) { animation-delay: 0.2s; }
        .week-item:nth-child(4) { animation-delay: 0.25s; }
        .week-item:nth-child(5) { animation-delay: 0.3s; }

        .team-member:nth-child(1) { animation-delay: 0.1s; }
        .team-member:nth-child(2) { animation-delay: 0.2s; }
        .team-member:nth-child(3) { animation-delay: 0.3s; }
        .team-member:nth-child(4) { animation-delay: 0.4s; }
        .team-member:nth-child(5) { animation-delay: 0.5s; }

        /* Animations pour les stats qui se mettent √† jour */
        .updating {
            animation: pulse 0.5s ease-in-out;
        }

        /* Scroll bar styl√© */
        .calendar-scroll-container::-webkit-scrollbar {
            height: 8px;
        }

        .calendar-scroll-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
        }

        .calendar-scroll-container::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }

        .calendar-scroll-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(90deg, #5a67d8 0%, #68d391 100%);
        }

        /* Effet de focus states pour l'accessibilit√© */
        button:focus,
        .btn:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* Animations de succ√®s */
        @keyframes success {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: rgba(16, 185, 129, 0.1); }
            100% { transform: scale(1); }
        }

        .success-animation {
            animation: success 0.6s ease-out;
        }

        /* Loading states */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading {
            animation: spin 1s linear infinite;
        }

        /* Hover effect pour les boutons de navigation */
        .nav-btn:nth-child(1):hover { box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3); }
        .nav-btn:nth-child(2):hover { box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); }
        .nav-btn:nth-child(3):hover { box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3); }
        .nav-btn:nth-child(4):hover { box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3); }

        /* Effets de particules subtils */
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 119, 198, 0.02) 0%, transparent 50%);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóìÔ∏è Planning Manager</h1>
            <p>Gestion des √©quipes r√©f√©rents Permis S - BAL Collective</p>
        </div>

        <div class="toolbar">
            <div class="toolbar-group">
                <div class="year-selector">
                    <button onclick="changeYear(-1)">‚Äπ</button>
                    <span id="currentYear">2025</span>
                    <button onclick="changeYear(1)">‚Ä∫</button>
                </div>
            </div>
            
            <div class="toolbar-group">
                <button class="btn btn-primary" onclick="showAssignmentModal()">
                    ‚ûï Assigner Semaine
                </button>
                <button class="btn btn-warning" onclick="showVacationModal()">
                    üèñÔ∏è G√©rer Vacances
                </button>
                <button class="btn btn-success" onclick="autoAssign()">
                    ü§ñ Attribution Auto
                </button>
                <button class="btn btn-danger" onclick="exportToExcelComplete()">
                    üìä Export Excel
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- Barre lat√©rale -->
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>üìä R√©sum√©</h3>
                    <div class="quick-stats">
                        <div class="quick-stat">
                            <span>Progression</span>
                            <span class="quick-stat-value" id="sidebarProgress">0%</span>
                        </div>
                        <div class="quick-stat">
                            <span>Assign√©es</span>
                            <span class="quick-stat-value" id="sidebarAssigned">0/52</span>
                        </div>
                        <div class="quick-stat">
                            <span>Conflits</span>
                            <span class="quick-stat-value" id="sidebarConflicts">0</span>
                        </div>
                        <div class="quick-stat">
                            <span>√âquit√©</span>
                            <span class="quick-stat-value" id="sidebarEquity">-/10</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>üóìÔ∏è Navigation</h3>
                    <div class="navigation-buttons">
                        <button class="nav-btn" onclick="scrollToMonth(0)">Jan</button>
                        <button class="nav-btn" onclick="scrollToMonth(3)">Avr</button>
                        <button class="nav-btn" onclick="scrollToMonth(6)">Juil</button>
                        <button class="nav-btn" onclick="scrollToMonth(9)">Oct</button>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; font-size: 0.9em;" onclick="scrollToCurrentWeek()">
                        üìÖ Semaine Actuelle
                    </button>
                </div>

                <div class="sidebar-section">
                    <h3>üë• √âquipe</h3>
                    <div class="team-summary" id="teamSummary">
                        <!-- G√©n√©r√© par JavaScript -->
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>‚ö° Actions</h3>
                    <div style="display: grid; gap: 10px;">
                        <button class="btn btn-success" style="width: 100%; font-size: 0.9em;" onclick="autoAssign()">
                            ü§ñ Attribution Auto
                        </button>
                        <button class="btn btn-warning" style="width: 100%; font-size: 0.9em;" onclick="showVacationModal()">
                            üèñÔ∏è G√©rer Vacances
                        </button>
                        <button class="btn btn-primary" style="width: 100%; font-size: 0.9em;" onclick="exportAllCalendars()">
                            üìÖ Export Calendriers
                        </button>
                    </div>
                </div>
            </div>

            <!-- Panel principal -->
            <div class="main-panel">
                <!-- Statistiques -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalWeeks">52</h3>
                        <p>Semaines Total</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="assignedWeeks">0</h3>
                        <p>Semaines Assign√©es</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="conflictWeeks">0</h3>
                        <p>Conflits D√©tect√©s</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="progressPercent">0%</h3>
                        <p>Avancement</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="equityScore">-</h3>
                        <p>√âquit√© (/10)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="vacationWeeks">0</h3>
                        <p>P√©riodes Vacances</p>
                    </div>
                </div>

                <!-- L√©gende -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color assigned"></div>
                        <span>Assign√©e</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color vacation"></div>
                        <span>Vacances</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color conflict"></div>
                        <span>Conflit</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color unassigned"></div>
                        <span>Non assign√©e</span>
                    </div>
                </div>

                <!-- Calendrier -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h2>Planning Annuel <span id="displayYear">2025</span></h2>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="scroll-hint">
                        ‚Üê ‚Üí D√©filez horizontalement pour naviguer dans l'ann√©e
                    </div>
                    
                    <div class="calendar-scroll-container">
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- G√©n√©r√© par JavaScript -->
                        </div>
                    </div>
                    
                    <div class="scroll-indicator">
                        <span>üí° Utilisez les boutons de navigation ou faites d√©filer horizontalement</span>
                    </div>
                </div>

                <!-- √âquipe d√©taill√©e -->
                <div class="team-panel">
                    <h2 style="margin-bottom: 25px; color: #2c3e50;">üìä Statistiques d'√âquipe</h2>
                    <div class="team-grid" id="teamGrid">
                        <!-- G√©n√©r√© par JavaScript -->
                    </div>
                </div>

                <!-- Export -->
                <div class="export-section">
                    <h3>üìã Actions de Gestion</h3>
                    <p>Exportez votre planning ou sauvegardez vos donn√©es</p>
                    <div style="margin-top: 15px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="saveData()">üíæ Sauvegarder</button>
                        <button class="btn btn-success" onclick="loadData()">üìÇ Charger</button>
                        <button class="btn btn-warning" onclick="resetPlanning()">üîÑ Reset</button>
                        <button class="btn btn-primary" onclick="debugAssignments()">üîç Debug</button>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="exportAllCalendars()">üìÖ Export Calendriers Individuels</button>
                        <button class="btn btn-primary" onclick="toggleYearView()">üóìÔ∏è <span id="yearViewToggle">Vue Ann√©e Compl√®te</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="assignmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Assigner une Semaine</h2>
                <span class="close" onclick="closeModal('assignmentModal')">&times;</span>
            </div>
            <form id="assignmentForm">
                <div class="form-group">
                    <label>Semaine :</label>
                    <input type="week" id="weekInput" required>
                </div>
                
                <div class="form-group">
                    <label>Bin√¥me :</label>
                    <div class="binome-selector">
                        <select id="member1" required>
                            <option value="">S√©lectionner...</option>
                        </select>
                        <select id="member2" required>
                            <option value="">S√©lectionner...</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Backup :</label>
                    <select id="backupMember" required>
                        <option value="">S√©lectionner...</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                    <button type="button" class="btn btn-danger" onclick="closeModal('assignmentModal')">Annuler</button>
                    <button type="submit" class="btn btn-success">Assigner</button>
                </div>
            </form>
        </div>
    </div>

    <div id="vacationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üèñÔ∏è G√©rer les Vacances</h2>
                <span class="close" onclick="closeModal('vacationModal')">&times;</span>
            </div>
            <form id="vacationForm">
                <div class="form-group">
                    <label>Membre de l'√©quipe :</label>
                    <select id="vacationMember" required>
                        <option value="">S√©lectionner...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Date de d√©but :</label>
                    <input type="date" id="vacationStart" required>
                </div>
                
                <div class="form-group">
                    <label>Date de fin :</label>
                    <input type="date" id="vacationEnd" required>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                    <button type="button" class="btn btn-danger" onclick="closeModal('vacationModal')">Annuler</button>
                    <button type="submit" class="btn btn-success">Ajouter Vacances</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration de l'√©quipe
        const team = [
            'R√©f√©rent 1',
            'R√©f√©rent 2', 
            'R√©f√©rent 3',
            'R√©f√©rent 4',
            'R√©f√©rent 5',
            'R√©f√©rent 6',
            'R√©f√©rent 7',
            'R√©f√©rent 8',
            'R√©f√©rent 9',
            'R√©f√©rent 10'
        ];

        // Bin√¥mes pr√©d√©finis
        const predefinedBinomes = [
            ['R√©f√©rent 1', 'R√©f√©rent 2', 'R√©f√©rent 10'],
            ['R√©f√©rent 3', 'R√©f√©rent 4', 'R√©f√©rent 1'],
            ['R√©f√©rent 5', 'R√©f√©rent 6', 'R√©f√©rent 2'],
            ['R√©f√©rent 7', 'R√©f√©rent 8', 'R√©f√©rent 3'],
            ['R√©f√©rent 9', 'R√©f√©rent 10', 'R√©f√©rent 5']
        ];

        let currentYear = 2025;
        let assignments = {};
        let vacations = {};
        let isYearView = false;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            initializeSelects();
            generateCalendar();
            generateTeamGrid();
            updateStats();
        });

        function initializeSelects() {
            const selects = ['member1', 'member2', 'backupMember', 'vacationMember'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">S√©lectionner...</option>';
                team.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    select.appendChild(option);
                });
            });
        }

        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            grid.className = 'calendar-grid'; // Reset class
            
            const months = [
                'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
            ];
            
            months.forEach((month, monthIndex) => {
                const monthColumn = document.createElement('div');
                monthColumn.className = 'month-column';
                
                const header = document.createElement('div');
                header.className = 'month-header';
                header.textContent = month;
                monthColumn.appendChild(header);
                
                // G√©n√©rer les semaines du mois
                const weeks = getWeeksInMonth(currentYear, monthIndex);
                weeks.forEach(week => {
                    const weekItem = document.createElement('div');
                    weekItem.className = 'week-item';
                    
                    const weekKey = `${currentYear}-W${week.week}`;
                    const assignment = assignments[weekKey];
                    const hasVacation = checkVacationConflict(week.start);
                    
                    // Debug: afficher la cl√© et l'assignment
                    console.log(`Week ${week.week}: Key=${weekKey}, Assignment=`, assignment);
                    
                    if (assignment) {
                        weekItem.classList.add(hasVacation ? 'conflict' : 'assigned');
                    } else if (hasVacation) {
                        weekItem.classList.add('vacation');
                    }
                    
                    weekItem.innerHTML = `
                        <div class="week-date">Semaine ${week.week} (${formatDate(week.start)} - ${formatDate(week.end)})</div>
                        <div class="week-assignment">${assignment ? `${assignment.member1} + ${assignment.member2}` : 'Non assign√©e'}</div>
                        ${assignment ? `<div style="font-size: 0.8em; color: #6c757d;">Backup: ${assignment.backup}</div>` : ''}
                        <div style="font-size: 0.7em; color: #999;">Key: ${weekKey}</div>
                    `;
                    
                    weekItem.onclick = () => selectWeek(weekKey, week);
                    monthColumn.appendChild(weekItem);
                });
                
                grid.appendChild(monthColumn);
            });
            
            document.getElementById('currentYear').textContent = currentYear;
            document.getElementById('displayYear').textContent = currentYear;
        }

        function getWeeksInMonth(year, month) {
            const weeks = [];
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Trouver le lundi de la premi√®re semaine
            let current = new Date(firstDay);
            while (current.getDay() !== 1) {
                current.setDate(current.getDate() - 1);
            }
            
            while (current <= lastDay || current.getMonth() === month) {
                const weekStart = new Date(current);
                const weekEnd = new Date(current);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                const weekNumber = getWeekNumber(weekStart);
                
                weeks.push({
                    week: weekNumber,
                    start: new Date(weekStart),
                    end: new Date(weekEnd)
                });
                
                current.setDate(current.getDate() + 7);
                
                if (current.getMonth() > month && weeks.length > 0) {
                    break;
                }
            }
            
            return weeks;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
        }

        function generateTeamGrid() {
            const grid = document.getElementById('teamGrid');
            grid.innerHTML = '';
            
            team.forEach(member => {
                const stats = getTeamMemberStats(member);
                
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                
                // Colorer selon la charge de travail
                let borderColor = '#dee2e6';
                if (stats.workload > 125) borderColor = '#e74c3c'; // Surcharge
                else if (stats.workload < 75) borderColor = '#f39c12'; // Sous-charge
                else borderColor = '#27ae60'; // √âquilibr√©
                
                memberDiv.style.borderLeft = `4px solid ${borderColor}`;
                
                memberDiv.innerHTML = `
                    <div class="member-name">${member}</div>
                    <div class="member-stats">
                        <div class="stat">
                            <div class="stat-value">${stats.assigned}</div>
                            <div class="stat-label">Assign√©</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${stats.backup}</div>
                            <div class="stat-label">Backup</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${stats.vacationDays}</div>
                            <div class="stat-label">Cong√©s (j)</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <div style="font-size: 0.9em; color: #6c757d;">
                            Charge: ${stats.workload}%
                        </div>
                        <div style="font-size: 0.8em; padding: 4px 8px; border-radius: 12px; background: ${borderColor}; color: white;">
                            ${stats.status}
                        </div>
                    </div>
                    ${stats.nextAssignment ? `<div style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">Prochaine: Semaine ${stats.nextAssignment}</div>` : ''}
                `;
                
                grid.appendChild(memberDiv);
            });
        }

        function getTeamMemberStats(member) {
            let assigned = 0;
            let backup = 0;
            let vacationDays = 0;
            let nextAssignment = null;
            
            // Compter les assignations et trouver la prochaine
            const currentWeek = getCurrentWeek();
            Object.entries(assignments).forEach(([weekKey, assignment]) => {
                const weekNum = parseInt(weekKey.split('-W')[1]);
                
                if (assignment.member1 === member || assignment.member2 === member) {
                    assigned++;
                    if (weekNum > currentWeek && !nextAssignment) {
                        nextAssignment = weekNum;
                    }
                }
                if (assignment.backup === member) {
                    backup++;
                }
            });
            
            // Compter les jours de cong√©s
            if (vacations[member]) {
                vacations[member].forEach(vacation => {
                    const start = new Date(vacation.start);
                    const end = new Date(vacation.end);
                    const diffTime = Math.abs(end - start);
                    vacationDays += Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                });
            }
            
            const totalWeeks = Object.keys(assignments).length || 52;
            const expectedShare = totalWeeks / team.length; // Part √©quitable
            const workload = Math.round((assigned / expectedShare) * 100);
            
            // D√©terminer le statut
            let status = '√âquilibr√©';
            if (workload > 125) status = 'Surcharge';
            else if (workload < 75) status = 'Sous-charge';
            
            return { assigned, backup, vacationDays, workload, status, nextAssignment };
        }

        function getCurrentWeek() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 1);
            const days = Math.floor((now - start) / (24 * 60 * 60 * 1000));
            return Math.ceil((days + start.getDay() + 1) / 7);
        }

        function showAssignmentModal() {
            document.getElementById('assignmentModal').style.display = 'block';
        }

        function showVacationModal() {
            document.getElementById('vacationModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function selectWeek(weekKey, week) {
            console.log('SelectWeek called with:', weekKey, week); // Debug
            
            const weekInput = document.getElementById('weekInput');
            const weekNumber = week.week.toString().padStart(2, '0');
            weekInput.value = `${currentYear}-W${weekNumber}`;
            
            console.log('Set input value to:', weekInput.value); // Debug
            
            // Pr√©-remplir avec l'assignment existant si il y en a un
            const existingAssignment = assignments[weekKey];
            console.log('Existing assignment for', weekKey, ':', existingAssignment); // Debug
            
            if (existingAssignment) {
                document.getElementById('member1').value = existingAssignment.member1;
                document.getElementById('member2').value = existingAssignment.member2;
                document.getElementById('backupMember').value = existingAssignment.backup;
            } else {
                // Reset form si pas d'assignment existant
                document.getElementById('member1').value = '';
                document.getElementById('member2').value = '';
                document.getElementById('backupMember').value = '';
            }
            
            showAssignmentModal();
        }

        // Gestion des formulaires
        document.getElementById('assignmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const weekValue = document.getElementById('weekInput').value;
            const member1 = document.getElementById('member1').value;
            const member2 = document.getElementById('member2').value;
            const backup = document.getElementById('backupMember').value;
            
            console.log('Form values:', { weekValue, member1, member2, backup }); // Debug
            
            if (member1 === member2) {
                alert('Les deux membres du bin√¥me ne peuvent pas √™tre identiques !');
                return;
            }
            
            if (!member1 || !member2 || !backup) {
                alert('Veuillez remplir tous les champs !');
                return;
            }
            
            // Extraire l'ann√©e et la semaine du format HTML (2025-W01)
            const matches = weekValue.match(/(\d{4})-W(\d+)/);
            if (!matches) {
                alert('Format de semaine invalide !');
                return;
            }
            
            const year = matches[1];
            const weekNum = parseInt(matches[2]); // Convertir en nombre pour enlever le z√©ro
            const weekKey = `${year}-W${weekNum}`;
            
            console.log('Generated key:', weekKey); // Debug
            console.log('All assignments before:', assignments); // Debug
            
            assignments[weekKey] = { member1, member2, backup };
            
            console.log('All assignments after:', assignments); // Debug
            
            saveToStorage();
            generateCalendar();
            generateTeamGrid();
            updateStats();
            closeModal('assignmentModal');
            
            // Reset form
            document.getElementById('assignmentForm').reset();
        });

        document.getElementById('vacationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const member = document.getElementById('vacationMember').value;
            const start = document.getElementById('vacationStart').value;
            const end = document.getElementById('vacationEnd').value;
            
            if (!vacations[member]) {
                vacations[member] = [];
            }
            
            vacations[member].push({ start, end });
            
            saveToStorage();
            generateCalendar();
            generateTeamGrid();
            updateStats();
            closeModal('vacationModal');
            
            // Reset form
            document.getElementById('vacationForm').reset();
        });

        function checkVacationConflict(weekStart) {
            for (const member of team) {
                if (vacations[member]) {
                    for (const vacation of vacations[member]) {
                        const vacStart = new Date(vacation.start);
                        const vacEnd = new Date(vacation.end);
                        
                        if (weekStart >= vacStart && weekStart <= vacEnd) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        function autoAssign() {
            if (!confirm('Cela va √©craser les assignations existantes. Continuer ?')) {
                return;
            }
            
            assignments = {};
            let binomeIndex = 0;
            
            for (let week = 1; week <= 52; week++) {
                const weekKey = `${currentYear}-W${week}`;
                const weekStart = getDateFromWeek(currentYear, week);
                
                // V√©rifier les conflits de vacances
                let availableBinomes = predefinedBinomes.filter(binome => {
                    return !vacations[binome[0]] || !vacations[binome[0]].some(vacation => {
                        const vacStart = new Date(vacation.start);
                        const vacEnd = new Date(vacation.end);
                        return weekStart >= vacStart && weekStart <= vacEnd;
                    }) && (!vacations[binome[1]] || !vacations[binome[1]].some(vacation => {
                        const vacStart = new Date(vacation.start);
                        const vacEnd = new Date(vacation.end);
                        return weekStart >= vacStart && weekStart <= vacEnd;
                    }));
                });
                
                if (availableBinomes.length === 0) {
                    availableBinomes = predefinedBinomes; // Fallback
                }
                
                const binome = availableBinomes[binomeIndex % availableBinomes.length];
                assignments[weekKey] = {
                    member1: binome[0],
                    member2: binome[1],
                    backup: binome[2]
                };
                
                binomeIndex++;
            }
            
            saveToStorage();
            generateCalendar();
            generateTeamGrid();
            updateStats();
            alert('Attribution automatique termin√©e !');
        }

        function getDateFromWeek(year, week) {
            const jan1 = new Date(year, 0, 1);
            const days = (week - 1) * 7;
            return new Date(jan1.getTime() + days * 24 * 60 * 60 * 1000);
        }

        function scrollToMonth(monthIndex) {
            const scrollContainer = document.querySelector('.calendar-scroll-container');
            const monthWidth = 315; // 300px + 15px gap
            const targetPosition = monthIndex * monthWidth;
            
            scrollContainer.scrollTo({
                left: targetPosition,
                behavior: 'smooth'
            });
        }

        function scrollToCurrentWeek() {
            const currentWeek = getCurrentWeek();
            const currentMonth = new Date().getMonth();
            
            // Scroll vers le mois actuel
            scrollToMonth(currentMonth);
            
            // Optionnel: highlight de la semaine actuelle
            setTimeout(() => {
                const weekElements = document.querySelectorAll('.week-item');
                weekElements.forEach(el => {
                    const weekText = el.querySelector('.week-date').textContent;
                    if (weekText.includes(`Semaine ${currentWeek}`)) {
                        el.style.boxShadow = '0 0 15px rgba(52, 152, 219, 0.5)';
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }, 500);
        }

        function updateSidebar() {
            const totalWeeks = 52;
            const assignedWeeks = Object.keys(assignments).length;
            let conflictWeeks = 0;
            
            // Compter les conflits
            Object.keys(assignments).forEach(weekKey => {
                const weekNum = parseInt(weekKey.split('-W')[1]);
                const weekStart = getDateFromWeek(currentYear, weekNum);
                if (checkVacationConflict(weekStart)) {
                    conflictWeeks++;
                }
            });
            
            const progress = Math.round((assignedWeeks / totalWeeks) * 100);
            const equityScore = calculateEquityScore();
            
            // Mettre √† jour la sidebar
            document.getElementById('sidebarProgress').textContent = progress + '%';
            document.getElementById('sidebarAssigned').textContent = `${assignedWeeks}/52`;
            document.getElementById('sidebarConflicts').textContent = conflictWeeks;
            document.getElementById('sidebarEquity').textContent = equityScore + '/10';
            
            // Mettre √† jour le r√©sum√© d'√©quipe
            updateTeamSummary();
        }

        function updateTeamSummary() {
            const container = document.getElementById('teamSummary');
            container.innerHTML = '';
            
            team.forEach(member => {
                const stats = getTeamMemberStats(member);
                
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member-summary';
                
                let loadClass = 'load-balanced';
                if (stats.workload > 125) loadClass = 'load-over';
                else if (stats.workload < 75) loadClass = 'load-under';
                
                memberDiv.innerHTML = `
                    <span class="member-name-short">${member}</span>
                    <span class="member-load ${loadClass}">${stats.assigned}</span>
                `;
                
                container.appendChild(memberDiv);
            });
        }

        function updateStats() {
            const totalWeeks = 52;
            const assignedWeeks = Object.keys(assignments).length;
            let conflictWeeks = 0;
            
            // Compter les conflits (vacances vs assignations)
            Object.keys(assignments).forEach(weekKey => {
                const weekNum = parseInt(weekKey.split('-W')[1]);
                const weekStart = getDateFromWeek(currentYear, weekNum);
                if (checkVacationConflict(weekStart)) {
                    conflictWeeks++;
                }
            });
            
            const vacationWeeksCount = Object.values(vacations).reduce((total, memberVacations) => {
                return total + memberVacations.length;
            }, 0);
            
            const progress = Math.round((assignedWeeks / totalWeeks) * 100);
            
            // Calculer le score d'√©quit√© (r√©partition √©quilibr√©e)
            const equityScore = calculateEquityScore();
            
            document.getElementById('totalWeeks').textContent = totalWeeks;
            document.getElementById('assignedWeeks').textContent = assignedWeeks;
            document.getElementById('conflictWeeks').textContent = conflictWeeks;
            document.getElementById('progressPercent').textContent = progress + '%';
            document.getElementById('equityScore').textContent = equityScore + '/10';
            document.getElementById('vacationWeeks').textContent = vacationWeeksCount;
            document.getElementById('progressBar').style.width = progress + '%';
            
            // Colorer le score d'√©quit√©
            const equityElement = document.getElementById('equityScore');
            const equityCard = equityElement.closest('.stat-card');
            if (equityScore >= 8) {
                equityCard.style.background = 'linear-gradient(135deg, #27ae60, #229954)';
            } else if (equityScore >= 6) {
                equityCard.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
            } else {
                equityCard.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            }
            
            // Colorer les conflits
            const conflictElement = document.getElementById('conflictWeeks');
            const conflictCard = conflictElement.closest('.stat-card');
            if (conflictWeeks === 0) {
                conflictCard.style.background = 'linear-gradient(135deg, #27ae60, #229954)';
            } else if (conflictWeeks <= 2) {
                conflictCard.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
            } else {
                conflictCard.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            }
            
            // Mettre √† jour la sidebar
            updateSidebar();
        }

        function calculateEquityScore() {
            if (Object.keys(assignments).length === 0) return 0;
            
            // Compter les assignations par membre
            const memberCounts = {};
            team.forEach(member => {
                memberCounts[member] = 0;
            });
            
            Object.values(assignments).forEach(assignment => {
                memberCounts[assignment.member1]++;
                memberCounts[assignment.member2]++;
            });
            
            const counts = Object.values(memberCounts);
            const average = counts.reduce((sum, count) => sum + count, 0) / counts.length;
            
            // Calculer l'√©cart type
            const variance = counts.reduce((sum, count) => sum + Math.pow(count - average, 2), 0) / counts.length;
            const standardDeviation = Math.sqrt(variance);
            
            // Score d'√©quit√© : plus l'√©cart type est faible, plus le score est √©lev√©
            // Score max (10) quand √©cart type = 0, d√©cro√Æt avec l'√©cart type
            const maxScore = 10;
            const score = Math.max(0, Math.round(maxScore - (standardDeviation * 2)));
            
            return Math.min(maxScore, score);
        }

        function changeYear(delta) {
            currentYear += delta;
            generateCalendar();
            updateStats();
        }

        function exportToExcelCollective() {
            const data = [];
            
            // En-t√™tes
            data.push(['Semaine', 'Dates', 'Membre 1', 'Membre 2', 'Backup', 'Statut', 'Conflits']);
            
            // G√©n√©rer toutes les semaines de l'ann√©e
            for (let week = 1; week <= 52; week++) {
                const weekKey = `${currentYear}-W${week}`;
                const assignment = assignments[weekKey];
                const weekStart = getDateFromWeek(currentYear, week);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                const dateRange = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
                const hasVacation = checkVacationConflict(weekStart);
                
                let statut = 'Non assign√©e';
                let conflits = '';
                
                if (assignment) {
                    statut = 'Assign√©e';
                    if (hasVacation) {
                        statut = 'Conflit vacances';
                        conflits = 'Vacances en cours';
                    }
                }
                
                data.push([
                    `Semaine ${week}`,
                    dateRange,
                    assignment ? assignment.member1 : '',
                    assignment ? assignment.member2 : '',
                    assignment ? assignment.backup : '',
                    statut,
                    conflits
                ]);
            }
            
            downloadCSV(data, `planning-collectif-${currentYear}.csv`);
        }

        function exportToExcelIndividual() {
            // Cr√©er un fichier pour chaque membre
            team.forEach(member => {
                const data = [];
                const stats = getTeamMemberStats(member);
                
                // En-t√™tes avec stats
                data.push([`Planning individuel - ${member} (${currentYear})`]);
                data.push([`Semaines assign√©es: ${stats.assigned}`, `Semaines backup: ${stats.backup}`, `Jours de cong√©s: ${stats.vacationDays}`]);
                data.push([]); // Ligne vide
                
                // En-t√™tes du tableau
                data.push(['Semaine', 'Dates', 'R√¥le', 'Bin√¥me', 'Backup', 'Vacances']);
                
                // Parcourir toutes les semaines
                for (let week = 1; week <= 52; week++) {
                    const weekKey = `${currentYear}-W${week}`;
                    const assignment = assignments[weekKey];
                    const weekStart = getDateFromWeek(currentYear, week);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    const dateRange = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
                    
                    let role = '';
                    let binome = '';
                    let backup = '';
                    let vacances = '';
                    
                    // V√©rifier les vacances
                    if (vacations[member]) {
                        const inVacation = vacations[member].some(vacation => {
                            const vacStart = new Date(vacation.start);
                            const vacEnd = new Date(vacation.end);
                            return weekStart >= vacStart && weekStart <= vacEnd;
                        });
                        if (inVacation) vacances = 'En cong√©s';
                    }
                    
                    // V√©rifier le r√¥le dans l'assignation
                    if (assignment) {
                        if (assignment.member1 === member) {
                            role = 'Titulaire 1';
                            binome = assignment.member2;
                            backup = assignment.backup;
                        } else if (assignment.member2 === member) {
                            role = 'Titulaire 2';
                            binome = assignment.member1;
                            backup = assignment.backup;
                        } else if (assignment.backup === member) {
                            role = 'Backup';
                            binome = `${assignment.member1} + ${assignment.member2}`;
                        }
                    }
                    
                    // N'ajouter que les semaines o√π la personne est impliqu√©e
                    if (role || vacances) {
                        data.push([
                            `Semaine ${week}`,
                            dateRange,
                            role,
                            binome,
                            backup,
                            vacances
                        ]);
                    }
                }
                
                downloadCSV(data, `planning-${member.replace(/\s+/g, '-')}-${currentYear}.csv`);
            });
            
            alert(`${team.length} fichiers Excel individuels g√©n√©r√©s !`);
        }

        function exportToExcelComplete() {
            // Cr√©er un export combin√© avec statistiques d√©taill√©es
            const data = [];
            
            // Section 1: R√©sum√© ex√©cutif
            data.push(['PLANNING √âQUIPE R√âF√âRENTS PERMIS S', `ANN√âE ${currentYear}`]);
            data.push([]);
            data.push(['STATISTIQUES G√âN√âRALES']);
            
            const totalWeeks = 52;
            const assignedWeeks = Object.keys(assignments).length;
            const vacationWeeksCount = Object.values(vacations).reduce((total, memberVacations) => {
                return total + memberVacations.length;
            }, 0);
            const progress = Math.round((assignedWeeks / totalWeeks) * 100);
            
            data.push(['Semaines totales', totalWeeks]);
            data.push(['Semaines assign√©es', assignedWeeks]);
            data.push(['P√©riodes de vacances', vacationWeeksCount]);
            data.push(['Avancement', `${progress}%`]);
            data.push([]);
            
            // Section 2: Statistiques par membre
            data.push(['R√âPARTITION PAR MEMBRE']);
            data.push(['Nom', 'Semaines assign√©es', 'Semaines backup', 'Jours cong√©s', 'Charge %']);
            
            team.forEach(member => {
                const stats = getTeamMemberStats(member);
                data.push([
                    member,
                    stats.assigned,
                    stats.backup,
                    stats.vacationDays,
                    `${stats.workload}%`
                ]);
            });
            
            data.push([]);
            
            // Section 3: Planning d√©taill√©
            data.push(['PLANNING D√âTAILL√â']);
            data.push(['Semaine', 'Dates', 'Membre 1', 'Membre 2', 'Backup', 'Statut']);
            
            for (let week = 1; week <= 52; week++) {
                const weekKey = `${currentYear}-W${week}`;
                const assignment = assignments[weekKey];
                const weekStart = getDateFromWeek(currentYear, week);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                const dateRange = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
                const hasVacation = checkVacationConflict(weekStart);
                
                let statut = 'Non assign√©e';
                if (assignment) {
                    statut = hasVacation ? 'Conflit vacances' : 'Assign√©e';
                }
                
                data.push([
                    `Semaine ${week}`,
                    dateRange,
                    assignment ? assignment.member1 : '',
                    assignment ? assignment.member2 : '',
                    assignment ? assignment.backup : '',
                    statut
                ]);
            }
            
            data.push([]);
            
            // Section 4: Calendrier des vacances
            data.push(['CALENDRIER DES VACANCES']);
            data.push(['Membre', 'Date d√©but', 'Date fin', 'Dur√©e (jours)']);
            
            team.forEach(member => {
                if (vacations[member]) {
                    vacations[member].forEach(vacation => {
                        const start = new Date(vacation.start);
                        const end = new Date(vacation.end);
                        const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                        
                        data.push([
                            member,
                            start.toLocaleDateString('fr-FR'),
                            end.toLocaleDateString('fr-FR'),
                            duration
                        ]);
                    });
                }
            });
            
            downloadCSV(data, `planning-complet-${currentYear}.csv`);
        }

        function downloadCSV(data, filename) {
            // Convertir les donn√©es en CSV
            const csvContent = data.map(row => 
                row.map(cell => {
                    // √âchapper les guillemets et entourer de guillemets si n√©cessaire
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                }).join(',')
            ).join('\n');
            
            // Ajouter BOM pour l'encodage UTF-8 (support des accents dans Excel)
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // T√©l√©charger le fichier
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function saveData() {
            const data = {
                year: currentYear,
                assignments: assignments,
                vacations: vacations
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `planning-backup-${currentYear}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Donn√©es sauvegard√©es !');
        }

        function loadData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            currentYear = data.year || currentYear;
                            assignments = data.assignments || {};
                            vacations = data.vacations || {};
                            
                            saveToStorage();
                            generateCalendar();
                            generateTeamGrid();
                            updateStats();
                            
                            alert('Donn√©es charg√©es avec succ√®s !');
                        } catch (error) {
                            alert('Erreur lors du chargement du fichier !');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        }

        function exportAllCalendars() {
            let exportedCount = 0;
            
            team.forEach(member => {
                const icsContent = generateICSForMember(member);
                if (icsContent) {
                    downloadICS(icsContent, `BAL-Permis-S-${member.replace(/\s+/g, '-')}-${currentYear}.ics`);
                    exportedCount++;
                }
            });
            
            alert(`üéâ ${exportedCount} calendriers g√©n√©r√©s !\n\nChaque r√©f√©rent peut maintenant importer son fichier .ics dans Outlook, Google Calendar, Apple Calendar, etc.\n\n‚úÖ Import automatique de toutes ses permanences BAL`);
        }

        function generateICSForMember(member) {
            let events = [];
            
            // Parcourir toutes les semaines assign√©es au membre
            Object.entries(assignments).forEach(([weekKey, assignment]) => {
                const weekNum = parseInt(weekKey.split('-W')[1]);
                const weekStart = getDateFromWeek(currentYear, weekNum);
                
                let eventTitle = '';
                let eventDescription = '';
                
                // V√©rifier le r√¥le du membre
                if (assignment.member1 === member || assignment.member2 === member) {
                    const partner = assignment.member1 === member ? assignment.member2 : assignment.member1;
                    eventTitle = `üîó BAL Permis S - Bin√¥me (Semaine ${weekNum})`;
                    eventDescription = `Responsabilit√© BAL collective Permis S\\n\\nBin√¥me: ${partner}\\nBackup: ${assignment.backup}\\n\\nContact: oce-orp-permiss@etat.ge.ch\\nHG: permis_s@hospicegeneral.ch\\n\\nConsultation: 2x/jour (9h et 15h)\\nR√©ponse: <24h`;
                } else if (assignment.backup === member) {
                    eventTitle = `üõ°Ô∏è BAL Permis S - Backup (Semaine ${weekNum})`;
                    eventDescription = `Backup BAL collective Permis S\\n\\nBin√¥me titulaire: ${assignment.member1} + ${assignment.member2}\\n\\nActivation si n√©cessaire\\nContact: oce-orp-permiss@etat.ge.ch`;
                }
                
                if (eventTitle) {
                    // √âv√©nement de 5 jours (lundi √† vendredi)
                    const eventStart = new Date(weekStart);
                    const eventEnd = new Date(weekStart);
                    eventEnd.setDate(eventEnd.getDate() + 4); // Vendredi
                    
                    events.push({
                        title: eventTitle,
                        start: eventStart,
                        end: eventEnd,
                        description: eventDescription,
                        isAllDay: true
                    });
                }
            });
            
            // Ajouter les p√©riodes de vacances
            if (vacations[member]) {
                vacations[member].forEach(vacation => {
                    const vacStart = new Date(vacation.start);
                    const vacEnd = new Date(vacation.end);
                    
                    events.push({
                        title: `üèñÔ∏è Cong√©s - Indisponible BAL Permis S`,
                        start: vacStart,
                        end: vacEnd,
                        description: `P√©riode de cong√©s\\n\\nIndisponible pour BAL collective\\nRemplac√© par bin√¥me ou backup`,
                        isAllDay: true,
                        category: 'VACATION'
                    });
                });
            }
            
            if (events.length === 0) return null;
            
            // G√©n√©rer le contenu ICS
            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Planning Manager//BAL Permis S//FR',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                `X-WR-CALNAME:BAL Permis S - ${member} (${currentYear})`,
                'X-WR-CALDESC:Planning des permanences BAL collective Permis S',
                'X-WR-TIMEZONE:Europe/Zurich'
            ];
            
            events.forEach((event, index) => {
                const uid = `bal-permis-s-${currentYear}-${index}-${member.replace(/\s+/g, '')}@etat.ge.ch`;
                const dtstart = formatICSDate(event.start, event.isAllDay);
                const dtend = formatICSDate(event.end, event.isAllDay);
                const dtstamp = formatICSDate(new Date(), false);
                
                icsContent.push(
                    'BEGIN:VEVENT',
                    `UID:${uid}`,
                    `DTSTAMP:${dtstamp}`,
                    `DTSTART${event.isAllDay ? ';VALUE=DATE' : ''}:${dtstart}`,
                    `DTEND${event.isAllDay ? ';VALUE=DATE' : ''}:${dtend}`,
                    `SUMMARY:${event.title}`,
                    `DESCRIPTION:${event.description}`,
                    'STATUS:CONFIRMED',
                    'TRANSP:OPAQUE',
                    event.category === 'VACATION' ? 'CATEGORIES:VACATION' : 'CATEGORIES:WORK',
                    'END:VEVENT'
                );
            });
            
            icsContent.push('END:VCALENDAR');
            
            return icsContent.join('\r\n');
        }

        function formatICSDate(date, isAllDay) {
            if (isAllDay) {
                return date.toISOString().slice(0, 10).replace(/-/g, '');
            } else {
                return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
            }
        }

        function downloadICS(content, filename) {
            const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function toggleYearView() {
            isYearView = !isYearView;
            const button = document.getElementById('yearViewToggle');
            
            if (isYearView) {
                button.textContent = 'Vue Mensuelle';
                generateYearView();
            } else {
                button.textContent = 'Vue Ann√©e Compl√®te';
                generateCalendar();
            }
        }

        function generateYearView() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            grid.className = 'calendar-grid year-view';
            
            const quarters = [
                { name: 'T1 - Jan-Mar', months: [0, 1, 2] },
                { name: 'T2 - Avr-Juin', months: [3, 4, 5] },
                { name: 'T3 - Juil-Sept', months: [6, 7, 8] },
                { name: 'T4 - Oct-D√©c', months: [9, 10, 11] }
            ];
            
            quarters.forEach(quarter => {
                const quarterColumn = document.createElement('div');
                quarterColumn.className = 'month-column';
                quarterColumn.style.minHeight = '600px';
                
                const header = document.createElement('div');
                header.className = 'month-header';
                header.textContent = quarter.name;
                quarterColumn.appendChild(header);
                
                // Toutes les semaines du trimestre
                quarter.months.forEach(monthIndex => {
                    const weeks = getWeeksInMonth(currentYear, monthIndex);
                    weeks.forEach(week => {
                        const weekItem = document.createElement('div');
                        weekItem.className = 'week-item';
                        weekItem.style.marginBottom = '4px';
                        weekItem.style.padding = '8px';
                        weekItem.style.fontSize = '0.85em';
                        
                        const weekKey = `${currentYear}-W${week.week}`;
                        const assignment = assignments[weekKey];
                        const hasVacation = checkVacationConflict(week.start);
                        
                        if (assignment) {
                            weekItem.classList.add(hasVacation ? 'conflict' : 'assigned');
                        } else if (hasVacation) {
                            weekItem.classList.add('vacation');
                        }
                        
                        weekItem.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 2px;">S${week.week}</div>
                            <div style="font-size: 0.8em;">${formatDate(week.start)}-${formatDate(week.end)}</div>
                            <div style="font-size: 0.8em; margin-top: 2px;">
                                ${assignment ? `${assignment.member1.split(' ')[0]} + ${assignment.member2.split(' ')[0]}` : 'Libre'}
                            </div>
                        `;
                        
                        weekItem.onclick = () => selectWeek(weekKey, week);
                        quarterColumn.appendChild(weekItem);
                    });
                });
                
                grid.appendChild(quarterColumn);
            });
        }

        function debugAssignments() {
            console.log('=== DEBUG ASSIGNMENTS ===');
            console.log('Current Year:', currentYear);
            console.log('Total assignments:', Object.keys(assignments).length);
            console.log('All assignments:', assignments);
            console.log('Vacations:', vacations);
            
            // Test d'assignation directe
            const testKey = `${currentYear}-W1`;
            assignments[testKey] = {
                member1: 'R√©f√©rent 1',
                member2: 'R√©f√©rent 2', 
                backup: 'R√©f√©rent 10'
            };
            
            console.log('Test assignment cr√©√©e:', testKey);
            generateCalendar();
            updateStats();
            
            alert(`Assignments: ${Object.keys(assignments).length}\nTest ajout√© pour semaine 1\nVoir la console pour les d√©tails`);
        }

        function resetPlanning() {
            if (confirm('√ätes-vous s√ªr de vouloir effacer tout le planning ?')) {
                assignments = {};
                vacations = {};
                saveToStorage();
                generateCalendar();
                generateTeamGrid();
                updateStats();
                alert('Planning remis √† z√©ro !');
            }
        }

        function saveToStorage() {
            try {
                const data = {
                    year: currentYear,
                    assignments: assignments,
                    vacations: vacations
                };
                localStorage.setItem('permis-s-planning', JSON.stringify(data));
            } catch (e) {
                console.warn('Impossible de sauvegarder dans localStorage');
            }
        }

        function loadFromStorage() {
            try {
                const data = localStorage.getItem('permis-s-planning');
                if (data) {
                    const parsed = JSON.parse(data);
                    currentYear = parsed.year || currentYear;
                    assignments = parsed.assignments || {};
                    vacations = parsed.vacations || {};
                }
            } catch (e) {
                console.warn('Impossible de charger depuis localStorage');
            }
        }

        // Fermer les modals en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
